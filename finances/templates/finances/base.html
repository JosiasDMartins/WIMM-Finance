{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8"/>
    <script>
        // Set initial dark mode state to prevent FOUC
        (function () {
            const htmlElement = document.documentElement;
            htmlElement.classList.remove('light');
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initial = saved ? saved : (prefersDark ? 'dark' : 'light');
            if (initial === 'dark') {
                htmlElement.classList.add('dark');
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
    <title>{% block title %}{% trans "SweetMoney | Family Financial Flow" %}{% endblock title %}</title>

    <!-- PWA Meta Tags - Custom implementation with dynamic versioning -->
    <meta name="application-name" content="SweetMoney">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SweetMoney">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="{% url 'manifest_json' %}">

    <link rel="icon" type="image/x-icon" href="{% static 'finances/images/favicons/favicon.ico' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'finances/images/favicons/favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'finances/images/favicons/favicon-96x96.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'finances/images/favicons/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'finances/images/favicons/android-chrome-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'finances/images/favicons/android-chrome-512x512.png' %}">

    <link href="{% static 'finances/css/tailwind.css' %}" rel="stylesheet"/>
    <link href="{% static 'finances/css/fonts.css' %}" rel="stylesheet"/>

    <style>
        /* Auto-adjust for Windows DPI scaling */
        @media screen and (min-resolution: 144dpi) and (max-width: 1920px) {
            /* For 150% Windows scaling on FullHD screens */
            html {
                font-size: 14px; /* Reduce base font size from 16px */
            }
        }

        @media screen and (min-resolution: 192dpi) and (max-width: 1920px) {
            /* For 200% Windows scaling */
            html {
                font-size: 13px;
            }
        }

        /* Ensure containers are fluid and responsive */
        .container-fluid {
            max-width: 100%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Prevent horizontal overflow */
        body {
            overflow-x: hidden;
        }

        /* Make buttons and inputs more responsive */
        @media (max-width: 1366px) {
            .btn, button, input[type="submit"] {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>

    <script defer src="{% static 'finances/js/alpine.min.js' %}"></script>

    <!-- Auto-scale adjustment for high DPI displays -->
    <script>
        (function() {
            'use strict';

            // Detect and adjust for Windows DPI scaling
            function adjustForDPIScaling() {
                const dpr = window.devicePixelRatio || 1;
                const screenWidth = window.screen.width * dpr;

                // If DPI scaling is detected (devicePixelRatio > 1) on a FullHD or smaller screen
                // Apply a slight zoom reduction to prevent UI elements from being cut off
                if (dpr >= 1.5 && screenWidth <= 1920) {
                    // Calculate optimal zoom level
                    const optimalZoom = Math.max(0.85, 1 / (dpr * 0.85));
                    document.documentElement.style.zoom = optimalZoom;

                    console.log('[DPI Adjust] Detected DPI scaling:', dpr, '| Applying zoom:', optimalZoom);
                }
            }

            // Run on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', adjustForDPIScaling);
            } else {
                adjustForDPIScaling();
            }

            // Re-adjust on window resize
            window.addEventListener('resize', function() {
                adjustForDPIScaling();
            });
        })();
    </script>
</head>
<body class="h-full bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200" x-data="{ sidebarOpen: false }">


    <div class="flex h-full">
        <aside :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}" 
               class="fixed inset-y-0 left-0 z-30 flex flex-col w-64 px-4 py-8 bg-white dark:bg-gray-800 border-r dark:border-gray-700 transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static">
            
            <div class="flex items-center justify-between">
                <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center gap-2">
                    <img src="{% static 'finances/images/logo.png' %}" alt="SweetMoney" class="h-16 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="flex items-center gap-2" style="display: none;">
                        <span class="material-symbols-outlined text-3xl text-primary">savings</span>
                        <span class="text-2xl font-bold text-gray-800 dark:text-white">SweetMoney</span>
                    </div>
                </a>
                <button @click="sidebarOpen = false" class="md:hidden text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <nav class="flex flex-col justify-between flex-1 mt-6">
                <div class="space-y-2">
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'dashboard' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">dashboard</span>
                        <span class="mx-4 font-medium">{% trans "Dashboard" %}</span>
                    </a>

                    {% if not is_child %}
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'investments' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'investments' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">trending_up</span>
                        <span class="mx-4 font-medium">{% trans "Investments" %}</span>
                        <span class="text-xs font-normal text-teal-600 dark:text-teal-500 ml-auto">{% trans "Soon" %}</span>
                    </a>
                    {% endif %}

                    {% if not is_child %}
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'configuration' or request.resolver_match.url_name == 'members' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'configuration' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">settings</span>
                        <span class="mx-4 font-medium">{% trans "Settings" %}</span>
                    </a>
                    {% endif %}
                </div>

                <div class="mt-auto space-y-2 pb-0">
                    <div class="pt-4 border-t dark:border-gray-700">
                        <a href="{% url 'user_profile' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center px-4 py-2 text-gray-600 rounded-md dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-bold mr-3">
                                {{ request.user.username|first|upper }}
                            </div>
                            <div class="flex flex-col">
                                <span class="font-semibold text-gray-800 dark:text-gray-200 text-sm">{{ request.user.username }}</span>
                                <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "View profile" %}</span>
                            </div>
                        </a>
                    </div>

                    <!-- Logout button (mobile only) -->
                    <div class="px-4 py-2 md:hidden">
                        <form method="POST" action="{% url 'auth_logout' %}">
                            {% csrf_token %}
                            <button type="submit" class="flex items-center w-full px-4 py-2 text-red-600 dark:text-red-400 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                <span class="material-symbols-outlined mr-3">logout</span>
                                <span class="font-medium">{% trans "Logout" %}</span>
                            </button>
                        </form>
                    </div>

                    <!-- PWA Install Button -->
                    <div id="pwa-install-container" class="hidden px-4 py-2">
                        <button id="pwa-install-btn"
                                class="w-full bg-green-500 bg-opacity-80 hover:bg-opacity-100
                                       text-white font-medium py-2 px-4 rounded-lg
                                       flex items-center justify-center gap-2 transition-all
                                       shadow-md hover:shadow-lg">
                            <span class="material-symbols-outlined">install_mobile</span>
                            <span>{% trans "Install App" %}</span>
                        </button>
                    </div>

                    <!-- Version -->
                    <div class="px-4 py-2 pb-0 text-center">
                        <span id="sidebar-version" class="text-xs text-gray-500 dark:text-gray-600">{% trans "Version" %} {{ db_version }}</span>
                        <div id="sidebar-update-indicator" class="hidden text-xs text-orange-500 dark:text-orange-400 mt-1">
                            ({% trans "Update Available" %})
                        </div>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 w-full">

                <button @click="sidebarOpen = true" class="md:hidden text-gray-600 dark:text-gray-400">
                    <span class="material-symbols-outlined">menu</span>
                </button>

                <div class="flex items-center space-x-4 ml-auto">
                    <div class="flex items-center space-x-3">

                        {% if not is_child and is_dashboard %}
                        <button onclick="openCreatePeriodModal()"
                                class="flex items-center space-x-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                title="{% trans 'Create New Period' %}">
                            <span class="material-symbols-outlined text-sm">add</span>
                            <span class="text-sm font-medium hidden md:inline">{% trans "New Period" %}</span>
                        </button>

                        <button type="button"
                                onclick="openDeletePeriodModal()"
                                style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #dc2626; color: white; border-radius: 8px; border: none; cursor: pointer; line-height: 1.25rem;"
                                title="{% trans 'Delete Current Period' %}">

                            <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.054.68-.11 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>

                            <span style="font-size: 14px; font-weight: 500;" class="hidden md:inline">{% trans "Delete Period" %}</span>
                        </button>
                        {% endif %}

                        <div x-data="{ periodDropdownOpen: false }" class="relative">
                            <button @click="{% if is_dashboard %}periodDropdownOpen = !periodDropdownOpen{% endif %}"
                                    class="flex items-center space-x-2 px-3 py-2 bg-primary/10 text-primary rounded-lg {% if is_dashboard %}hover:bg-primary/20 cursor-pointer{% else %}cursor-default opacity-70{% endif %} transition-colors">
                                <span class="material-symbols-outlined text-sm">calendar_month</span>
                                <span class="text-sm font-medium">{{ current_period_label }}</span>
                                {% if is_dashboard %}<span class="material-symbols-outlined text-sm">expand_more</span>{% endif %}
                            </button>
                            
                            <div x-show="periodDropdownOpen" 
                                 @click.away="periodDropdownOpen = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50"
                                 style="display: none;">
                                 <div class="py-1">
                                    {% for period in available_periods %}
                                    <a href="?period={{ period.value }}" 
                                       class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 {% if period.is_current %}bg-primary/10 text-primary font-semibold{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                        <div class="flex items-center justify-between">
                                            <span>{{ period.label }}</span>
                                            {% if period.is_current %}
                                            <span class="text-primary">●</span>
                                            {% elif period.has_data %}
                                            <span class="text-xs text-gray-400">•</span>
                                            {% endif %}
                                        </div>
                                    </a>
                                    {% empty %}
                                    <div class="px-4 py-2 text-sm text-gray-500">{% trans "No periods available" %}</div>
                                    {% endfor %}
                                 </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <button id="notification-bell" class="relative text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">notifications</span>
                            {% if unread_notifications_count > 0 %}
                            <span id="notification-badge" class="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                {{ unread_notifications_count }}
                            </span>
                            {% else %}
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                0
                            </span>
                            {% endif %}
                        </button>

                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-600 max-h-96 overflow-hidden z-50">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Notifications" %}</h3>
                                <button id="acknowledge-all-btn" class="text-xs text-primary hover:text-primary/80 font-medium">
                                    {% trans "Mark all as read" %}
                                </button>
                            </div>
                            <div id="notification-list" class="overflow-y-auto max-h-80">
                                </div>
                        </div>
                    </div>

                    <button id="theme-toggle" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors" title="{% trans 'Toggle Dark Mode' %}">
                        <span id="icon-dark" class="material-symbols-outlined block dark:hidden">dark_mode</span>
                        <span id="icon-light" class="material-symbols-outlined hidden dark:block">light_mode</span>
                    </button>

                    <form method="POST" action="{% url 'auth_logout' %}" class="hidden md:block">
                        {% csrf_token %}
                        <button type="submit" class="text-gray-600 dark:text-gray-400 hover:text-red-500" title="{% trans 'Logout' %}">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </form>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-background-light dark:bg-background-dark">
                {% if messages %}
                    <div class="p-4">
                        {% for message in messages %}
                            <div class="mb-2 p-3 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                {% block content %}
                {% endblock content %}
            </main>
        </div>
    </div>

    <!-- Admin Warning Modal -->
    {% if is_admin and not admin_warning_seen %}
    <div id="admin-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="z-index: 9999;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-amber-600 p-4 flex items-center gap-3">
                <span class="material-symbols-outlined text-white text-3xl">warning</span>
                <h3 class="text-white text-xl font-bold">{% trans "Administrator Account" %}</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    {% trans "This is an Administrator account and should be used only for family group administration. Daily operations should be performed using Parent or Child accounts." %}
                </p>
                <button id="btn-dismiss-admin-warning" type="button" class="w-full px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium transition-colors">
                    {% trans "I Agree" %}
                </button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const modal = document.getElementById('admin-warning-modal');
        const btn = document.getElementById('btn-dismiss-admin-warning');

        if (btn && modal) {
            btn.addEventListener('click', function() {
                fetch('/mark-admin-warning-seen/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(function(response) {
                    if (response.ok) {
                        modal.remove();
                        if (typeof UpdateManager !== 'undefined' && !window.updateManager) {
                            window.updateManager = new UpdateManager();
                        }
                    }
                }).catch(function(err) {
                    console.error('Error dismissing admin warning:', err);
                    modal.remove();
                    if (typeof UpdateManager !== 'undefined' && !window.updateManager) {
                        window.updateManager = new UpdateManager();
                    }
                });
            });
        }
    })();
    </script>
    {% endif %}

    {% include 'finances/update_modal.html' %}

    <div id="createPeriodModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{% trans "Create New Period" %}</h3>
                    <button onclick="closeCreatePeriodModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <form id="createPeriodForm" class="space-y-4">
                    <div>
                        <label for="period_start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            {% trans "Start Date" %}
                        </label>
                        <input type="date" id="period_start_date" name="start_date" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                    </div>

                    <div>
                        <label for="period_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            {% trans "End Date" %}
                        </label>
                        <input type="date" id="period_end_date" name="end_date" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                    </div>

                    <div id="overlapWarning" class="hidden p-3 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-400 dark:border-yellow-600 rounded-lg">
                        <div class="flex items-start">
                            <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 mr-2">warning</span>
                            <div>
                                <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-300">{% trans "Warning: Period Overlap Detected" %}</p>
                                <p id="overlapMessage" class="text-sm text-yellow-700 dark:text-yellow-400 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeCreatePeriodModal()"
                                class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" id="createPeriodBtn"
                                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                            {% trans "Create" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="deletePeriodModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl mx-4 border-4 border-orange-500">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-red-600 dark:text-red-400">
                        <span class="material-symbols-outlined inline align-text-bottom mr-2">warning</span>
                        {% trans "Delete Period" %}
                    </h3>
                    <button onclick="closeDeletePeriodModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div id="deletePeriodContent" class="space-y-4">
                    <div id="deletePeriodLoading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">{% trans "Loading period details..." %}</p>
                    </div>

                    <div id="deletePeriodDetails" class="hidden">
                        <div id="deleteWarningBox" class="p-4 bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 rounded-lg mb-4">
                            <p class="text-sm font-semibold text-red-800 dark:text-red-300">
                                <span class="material-symbols-outlined text-sm align-text-bottom mr-1">warning</span>
                                <span id="deleteWarningText">{% trans "This action cannot be undone!" %}</span>
                            </p>
                            <p id="deleteActionDescription" class="text-sm text-red-700 dark:text-red-400 mt-1"></p>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">{% trans "Period Information" %}</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                <span class="font-medium">{% trans "Period:" %}</span> <span id="deletePeriodLabel"></span>
                            </p>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">{% trans "Period Summary" %}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">{% trans "Flow Groups:" %}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" id="deleteFlowGroupCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">{% trans "Transactions:" %}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" id="deleteTransactionCount">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">{% trans "Key Metrics" %}</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Income (Estimated)" %}</p>
                                    <p class="font-semibold text-green-600 dark:text-green-400">
                                        <span id="deleteCurrencySymbol1"></span><span id="deleteIncomeEstimated">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Income (Realized)" %}</p>
                                    <p class="font-semibold text-green-700 dark:text-green-500">
                                        <span id="deleteCurrencySymbol2"></span><span id="deleteIncomeRealized">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Expenses (Estimated)" %}</p>
                                    <p class="font-semibold text-red-600 dark:text-red-400">
                                        <span id="deleteCurrencySymbol3"></span><span id="deleteExpenseEstimated">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Expenses (Realized)" %}</p>
                                    <p class="font-semibold text-red-700 dark:text-red-500">
                                        <span id="deleteCurrencySymbol4"></span><span id="deleteExpenseRealized">0.00</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="flex items-center mb-4">
                                <input id="deleteConsentCheckbox"
                                       type="checkbox"
                                       onchange="toggleDeleteButton()"
                                       class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500 cursor-pointer">
                                <label for="deleteConsentCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300 cursor-pointer">
                                    {% trans "I understand the consequences and want to proceed." %}
                                </label>
                            </div>

                            <div class="flex space-x-3">
                                <button type="button" onclick="closeDeletePeriodModal()"
                                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                    {% trans "Cancel" %}
                                </button>
                                <button type="button" onclick="confirmDeletePeriod()" id="confirmDeleteBtn" disabled
                                        style="background-color: #d1d5db; color: #6b7280; cursor: not-allowed; transition: all 0.2s;"
                                        class="flex-1 px-4 py-2 rounded-lg shadow-sm flex items-center justify-center font-medium">
                                    <span id="deleteButtonText">{% trans "Delete Period" %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'finances/js/notifications.js' %}"></script>

    <script>
        // Create Period Modal Functions
        function openCreatePeriodModal() {
            document.getElementById('createPeriodModal').classList.remove('hidden');
            // Reset form
            document.getElementById('createPeriodForm').reset();
            document.getElementById('overlapWarning').classList.add('hidden');
            document.getElementById('createPeriodBtn').disabled = false;
        }

        function closeCreatePeriodModal() {
            document.getElementById('createPeriodModal').classList.add('hidden');
        }

        // Validate overlap when dates change
        function validatePeriodOverlap() {
            const startDate = document.getElementById('period_start_date').value;
            const endDate = document.getElementById('period_end_date').value;
            const warningDiv = document.getElementById('overlapWarning');
            const createBtn = document.getElementById('createPeriodBtn');

            if (!startDate || !endDate) {
                warningDiv.classList.add('hidden');
                createBtn.disabled = false;
                return;
            }

            fetch('/api/period/validate-overlap/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_overlap) {
                    warningDiv.classList.remove('hidden');
                    document.getElementById('overlapMessage').textContent = data.message;
                    createBtn.disabled = true;
                    createBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    createBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    warningDiv.classList.add('hidden');
                    createBtn.disabled = false;
                    createBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    createBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            })
            .catch(error => {
                console.error('Error validating period:', error);
            });
        }

        // Attach validation to date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('period_start_date');
            const endDateInput = document.getElementById('period_end_date');

            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', validatePeriodOverlap);
                endDateInput.addEventListener('change', validatePeriodOverlap);
            }
        });

        // Handle form submission
        document.getElementById('createPeriodForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const startDate = document.getElementById('period_start_date').value;
            const endDate = document.getElementById('period_end_date').value;
            const createBtn = document.getElementById('createPeriodBtn');

            // Disable button during submission
            createBtn.disabled = true;
            createBtn.textContent = "{% trans 'Creating...' %}";

            fetch('/api/period/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload page to show new period
                    window.location.href = `?period=${data.period.start_date}`;
                } else {
                    alert("{% trans 'Error:' %} " + data.error);
                    createBtn.disabled = false;
                    createBtn.textContent = "{% trans 'Create' %}";
                }
            })
            .catch(error => {
                console.error('Error creating period:', error);
                alert("{% trans 'An error occurred while creating the period' %}");
                createBtn.disabled = false;
                createBtn.textContent = "{% trans 'Create' %}";
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Delete Period Modal Functions
        let currentPeriodToDelete = null;

        // NOVA FUNÇÃO: Controla estado do botão baseado no checkbox
        function toggleDeleteButton() {
            const checkbox = document.getElementById('deleteConsentCheckbox');
            const btn = document.getElementById('confirmDeleteBtn');

            if (checkbox && checkbox.checked) {
                btn.disabled = false;
                btn.style.backgroundColor = '#dc2626'; // Vermelho
                btn.style.color = 'white';
                btn.style.cursor = 'pointer';
            } else if (btn) {
                btn.disabled = true;
                btn.style.backgroundColor = '#d1d5db'; // Cinza
                btn.style.color = '#6b7280';
                btn.style.cursor = 'not-allowed';
            }
        }

        function openDeletePeriodModal() {
            const modal = document.getElementById('deletePeriodModal');
            modal.classList.remove('hidden');

            // RESET: Desmarcar checkbox e travar botão
            const checkbox = document.getElementById('deleteConsentCheckbox');
            if (checkbox) {
                checkbox.checked = false;
                toggleDeleteButton(); // Aplica o estado visual de travado
            }

            // Show loading, hide content
            document.getElementById('deletePeriodLoading').classList.remove('hidden');
            document.getElementById('deletePeriodDetails').classList.add('hidden');

            // Get current period from URL or use default
            const urlParams = new URLSearchParams(window.location.search);
            const periodParam = urlParams.get('period');

            // Fetch period details
            const periodUrl = periodParam
                ? `/api/period/details/?period_start=${periodParam}`
                : `/api/period/details/?period_start={{ start_date|date:"Y-m-d" }}`;

            fetch(periodUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentPeriodToDelete = data.period.start_date;

                        // Populate modal with period data
                        document.getElementById('deletePeriodLabel').textContent = data.period.label;
                        document.getElementById('deleteFlowGroupCount').textContent = data.summary.flow_group_count;
                        document.getElementById('deleteTransactionCount').textContent = data.summary.transaction_count;

                        // Set currency symbols
                        const currencySymbol = data.summary.currency_symbol;
                        document.getElementById('deleteCurrencySymbol1').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol2').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol3').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol4').textContent = currencySymbol;

                        // Set metrics
                        document.getElementById('deleteIncomeEstimated').textContent = parseFloat(data.summary.total_income_estimated).toFixed(2);
                        document.getElementById('deleteIncomeRealized').textContent = parseFloat(data.summary.total_income_realized).toFixed(2);
                        document.getElementById('deleteExpenseEstimated').textContent = parseFloat(data.summary.total_expense_estimated).toFixed(2);
                        document.getElementById('deleteExpenseRealized').textContent = parseFloat(data.summary.total_expense_realized).toFixed(2);

                        // Translated strings
                        const txtCurrentPeriodWarning = "{% trans 'This is the CURRENT period. All flow groups and transactions will be CLEARED, but the period entry will be kept.' %}";
                        const txtPermanentDeleteWarning = "{% trans 'This period will be PERMANENTLY DELETED along with all its flow groups and transactions.' %}";
                        const txtClearPeriod = "{% trans 'Clear Period' %}";
                        const txtDeletePeriod = "{% trans 'Delete Period' %}";

                        // Update warning message based on whether it's current period
                        if (data.period.is_current) {
                            document.getElementById('deleteActionDescription').textContent = txtCurrentPeriodWarning;
                            document.getElementById('deleteButtonText').textContent = txtClearPeriod;
                        } else {
                            document.getElementById('deleteActionDescription').textContent = txtPermanentDeleteWarning;
                            document.getElementById('deleteButtonText').textContent = txtDeletePeriod;
                        }

                        // Hide loading, show content
                        document.getElementById('deletePeriodLoading').classList.add('hidden');
                        document.getElementById('deletePeriodDetails').classList.remove('hidden');
                    } else {
                        alert('Error loading period details: ' + data.error);
                        closeDeletePeriodModal();
                    }
                })
                .catch(error => {
                    console.error('Error fetching period details:', error);
                    alert('An error occurred while loading period details');
                    closeDeletePeriodModal();
                });
        }

        function closeDeletePeriodModal() {
            document.getElementById('deletePeriodModal').classList.add('hidden');
            currentPeriodToDelete = null;
        }

        function confirmDeletePeriod() {
            if (!currentPeriodToDelete) return;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.querySelector('#deleteButtonText').textContent;

            // Disable button
            confirmBtn.disabled = true;
            confirmBtn.querySelector('#deleteButtonText').textContent = "{% trans 'Processing...' %}";
            confirmBtn.style.cursor = 'wait';

            fetch('/api/period/delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    period_start: currentPeriodToDelete
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    alert(data.message);
                    // Redirect
                    window.location.href = data.redirect;
                } else {
                    alert("{% trans 'Error:' %} " + data.error);
                    confirmBtn.disabled = false;
                    confirmBtn.querySelector('#deleteButtonText').textContent = originalText;
                    // Restaura estilo vermelho pois o erro ocorreu
                    confirmBtn.style.cursor = 'pointer';
                }
            })
            .catch(error => {
                console.error('Error deleting period:', error);
                alert("{% trans 'An error occurred while deleting the period' %}");
                confirmBtn.disabled = false;
                confirmBtn.querySelector('#deleteButtonText').textContent = originalText;
                confirmBtn.style.cursor = 'pointer';
            });
        }
    </script>

    <script>
        // Dark mode toggle functionality
        (function () {
            const themeToggle = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;
            const iconDark = document.getElementById('icon-dark');
            const iconLight = document.getElementById('icon-light');

            function setIcons() {
                if (!iconDark || !iconLight) return;
                if (htmlElement.classList.contains('dark')) {
                    iconDark.style.display = 'none';
                    iconLight.style.display = 'inline-block';
                } else {
                    iconDark.style.display = 'inline-block';
                    iconLight.style.display = 'none';
                }
            }

            // apply immediately
            setIcons();

            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    htmlElement.classList.toggle('dark');
                    const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    setIcons();
                });
            }
        })();
    </script>

    {% block extra_js %}
    {% endblock %}

    <!-- Generic Alert/Confirm Modal -->
    <div id="generic-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Background overlay -->
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity"></div>

        <!-- Modal panel -->
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6">
                    <!-- Icon -->
                    <div class="sm:flex sm:items-start">
                        <div id="modal-icon-container" class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full sm:mx-0 sm:h-10 sm:w-10">
                            <!-- Icon will be injected by JavaScript -->
                            <svg id="modal-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">
                                {% trans "Notification" %}
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-300" id="modal-message">
                                    <!-- Message will be injected by JavaScript -->
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Buttons -->
                    <div class="mt-5 sm:mt-4 grid gap-2 sm:flex sm:flex-row-reverse sm:gap-3" id="modal-buttons">
                        <!-- Buttons will be injected by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal JavaScript -->
    <script>
        // Translation strings for modal
        window.MODAL_I18N = {
            notification: "{% trans 'Notification' %}",
            warning: "{% trans 'Warning' %}",
            error: "{% trans 'Error' %}",
            success: "{% trans 'Success' %}",
            confirm: "{% trans 'Confirm Action' %}",
            ok: "{% trans 'OK' %}",
            cancel: "{% trans 'Cancel' %}",
            continue: "{% trans 'Continue' %}",
            yes: "{% trans 'Yes' %}",
            no: "{% trans 'No' %}",
            close: "{% trans 'Close' %}"
        };

        // Generic Modal Manager
        window.GenericModal = {
            // Show alert modal (only OK button)
            alert: function(message, title, onClose) {
                return this.show({
                    type: 'info',
                    title: title || window.MODAL_I18N.notification,
                    message: message,
                    buttons: [
                        {
                            text: window.MODAL_I18N.ok,
                            className: 'primary',
                            callback: onClose
                        }
                    ]
                });
            },

            // Show confirm modal (Yes/No or OK/Cancel)
            confirm: function(message, title, onConfirm, onCancel) {
                return this.show({
                    type: 'warning',
                    title: title || window.MODAL_I18N.confirm,
                    message: message,
                    buttons: [
                        {
                            text: window.MODAL_I18N.cancel,
                            className: 'secondary',
                            callback: onCancel
                        },
                        {
                            text: window.MODAL_I18N.continue,
                            className: 'danger',
                            callback: onConfirm
                        }
                    ]
                });
            },

            // Generic show method with full customization
            show: function(options) {
                const modal = document.getElementById('generic-modal');
                const iconContainer = document.getElementById('modal-icon-container');
                const icon = document.getElementById('modal-icon');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const buttonsContainer = document.getElementById('modal-buttons');

                // Set type styling
                const types = {
                    info: {
                        iconBg: 'bg-blue-100 dark:bg-blue-900/30',
                        iconColor: 'text-blue-600 dark:text-blue-400',
                        iconPath: 'M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z'
                    },
                    warning: {
                        iconBg: 'bg-yellow-100 dark:bg-yellow-900/30',
                        iconColor: 'text-yellow-600 dark:text-yellow-400',
                        iconPath: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z'
                    },
                    error: {
                        iconBg: 'bg-red-100 dark:bg-red-900/30',
                        iconColor: 'text-red-600 dark:text-red-400',
                        iconPath: 'M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z'
                    },
                    success: {
                        iconBg: 'bg-green-100 dark:bg-green-900/30',
                        iconColor: 'text-green-600 dark:text-green-400',
                        iconPath: 'M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z'
                    }
                };

                const typeStyle = types[options.type || 'info'];

                // Set icon styling
                iconContainer.className = `mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full sm:mx-0 sm:h-10 sm:w-10 ${typeStyle.iconBg}`;
                icon.className = `h-6 w-6 ${typeStyle.iconColor}`;

                // Update or create path element
                let pathElement = icon.querySelector('path');
                if (!pathElement) {
                    pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    pathElement.setAttribute('stroke-linecap', 'round');
                    pathElement.setAttribute('stroke-linejoin', 'round');
                    icon.appendChild(pathElement);
                }
                pathElement.setAttribute('d', typeStyle.iconPath);

                // Set title and message
                titleEl.textContent = options.title || window.MODAL_I18N.notification;
                messageEl.innerHTML = options.message || '';

                // Build buttons
                buttonsContainer.innerHTML = '';
                (options.buttons || []).forEach(btn => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = btn.text;

                    // Button styling based on className
                    const buttonStyles = {
                        primary: 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:w-auto',
                        secondary: 'mt-3 inline-flex w-full justify-center rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 sm:mt-0 sm:w-auto',
                        danger: 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto',
                        success: 'inline-flex w-full justify-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 sm:w-auto'
                    };

                    button.className = buttonStyles[btn.className] || buttonStyles.primary;

                    button.addEventListener('click', () => {
                        this.hide();
                        if (btn.callback && typeof btn.callback === 'function') {
                            btn.callback();
                        }
                    });

                    buttonsContainer.appendChild(button);
                });

                // Show modal
                modal.classList.remove('hidden');

                // Return promise for async/await usage
                return new Promise((resolve) => {
                    // Store resolve for later use if needed
                    modal._resolve = resolve;
                });
            },

            // Hide modal
            hide: function() {
                const modal = document.getElementById('generic-modal');
                modal.classList.add('hidden');
                if (modal._resolve) {
                    modal._resolve();
                    delete modal._resolve;
                }
            }
        };

        // Store original functions for fallback
        window._originalAlert = window.alert;
        window._originalConfirm = window.confirm;

        // Override native alert
        window.alert = function(message, title) {
            console.log('[GenericModal] Alert called:', message);
            GenericModal.alert(message, title);
        };

        // Override native confirm (returns Promise)
        // IMPORTANT: Old synchronous code like `if (confirm(...))` won't work
        // Must use: `confirm(...).then(result => { if (result) {...} })`
        // Or convert function to async: `const result = await confirm(...); if (result) {...}`
        window.confirm = function(message, title) {
            console.log('[GenericModal] Confirm called:', message);
            return new Promise((resolve) => {
                GenericModal.confirm(
                    message,
                    title || window.MODAL_I18N.confirm,
                    () => {
                        console.log('[GenericModal] Confirmed: true');
                        resolve(true);
                    },
                    () => {
                        console.log('[GenericModal] Confirmed: false');
                        resolve(false);
                    }
                );
            });
        };

        // Helper function for inline confirm usage (for onclick attributes)
        window.confirmAction = async function(message, title, callback) {
            const result = await window.confirm(message, title);
            if (result && callback) {
                callback();
            }
            return result;
        };

        // Log that GenericModal is loaded
        console.log('[GenericModal] System loaded successfully');
        console.log('[GenericModal] Available methods:', Object.keys(GenericModal));
    </script>

    <!-- PWA Service Worker Registration & Version Management -->
    <script>
        const SERVER_VERSION = '{{ db_version }}';

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Check if running as installed PWA
                const isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

                // Register service worker
                navigator.serviceWorker.register('{% url "service_worker" %}')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registered successfully:', registration.scope);
                        console.log('[PWA] Server version: ' + SERVER_VERSION);

                        // Check for manifest version updates (for installed apps)
                        if (isInstalled) {
                            checkManifestVersion();
                        }

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                            if (isInstalled) {
                                checkManifestVersion();
                            }
                        }, 60000); // Check every minute
                    })
                    .catch((error) => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });

                // Listen for service worker updates
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('[PWA] New service worker activated - reloading page');
                    window.location.reload();
                });
            });
        }

        // Check manifest version and prompt for reinstall if needed
        async function checkManifestVersion() {
            try {
                // Get cached installed version
                const installedVersion = localStorage.getItem('pwa_installed_version');

                if (!installedVersion) {
                    // First time running, save current version
                    localStorage.setItem('pwa_installed_version', SERVER_VERSION);
                    console.log('[PWA] Saved installed version: ' + SERVER_VERSION);
                    return;
                }

                // Compare versions
                if (installedVersion !== SERVER_VERSION) {
                    console.log('[PWA] Version mismatch! Installed: ' + installedVersion + ', Server: ' + SERVER_VERSION);

                    // Show update notification
                    showUpdateNotification(installedVersion, SERVER_VERSION);
                }
            } catch (error) {
                console.error('[PWA] Error checking manifest version:', error);
            }
        }

        function showUpdateNotification(oldVersion, newVersion) {
            // Only show once per version
            const notificationShown = sessionStorage.getItem('update_notification_' + newVersion);
            if (notificationShown) {
                return;
            }

            // Mark as shown
            sessionStorage.setItem('update_notification_' + newVersion, 'true');

            // Use existing modal system if available
            if (typeof window.showModal === 'function') {
                const title = '🎉 New Version Available!';
                const content = `
                    <div class="space-y-4">
                        <p class="text-gray-700 dark:text-gray-300">
                            SweetMoney has been updated from <strong>v${oldVersion}</strong> to <strong>v${newVersion}</strong>!
                        </p>
                        <p class="text-gray-700 dark:text-gray-300">
                            To see the latest features and improvements, please reinstall the app:
                        </p>
                        <ol class="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-300 text-sm">
                            <li>Uninstall the current app from your device</li>
                            <li>Visit SweetMoney in your browser</li>
                            <li>Click "Install App" to reinstall with the new version</li>
                        </ol>
                        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <p class="text-xs text-blue-700 dark:text-blue-400">
                                💡 <strong>Tip:</strong> Your data is safe on the server. Reinstalling won't affect your financial records.
                            </p>
                        </div>
                        <button onclick="updateInstalledVersion('${newVersion}')"
                                class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg">
                            I'll Do It Later
                        </button>
                    </div>
                `;
                window.showModal(title, content);
            } else {
                // Fallback: console + alert
                if (confirm(`New SweetMoney version available!\n\nInstalled: v${oldVersion}\nAvailable: v${newVersion}\n\nTo update, please reinstall the app.\n\nClick OK to dismiss this message.`)) {
                    localStorage.setItem('pwa_installed_version', newVersion);
                }
            }
        }

        // Allow user to dismiss update notification
        function updateInstalledVersion(version) {
            localStorage.setItem('pwa_installed_version', version);
            console.log('[PWA] User dismissed update notification for version ' + version);

            // Close modal if closeModal function exists
            if (typeof window.closeModal === 'function') {
                window.closeModal();
            }
        }
    </script>

    <!-- PWA Install Manager -->
    <script src="{% static 'finances/js/pwa-install.js' %}"></script>

    <!-- WebSocket Real-time Updates -->
    {% if user.is_authenticated %}
    <script src="{% static 'finances/js/websocket_manager.js' %}"></script>

    <!-- Real-time UI Updates Handler -->
    <script>
        // Expose locale settings for realtime_ui.js
        window.decimalSeparator = "{{ decimal_separator }}";
        window.thousandSeparator = "{{ thousand_separator }}";
        window.currencySymbol = "{{ currency_symbol }}";
    </script>
    <script src="{% static 'finances/js/realtime_ui.js' %}?v=20251215-003"></script>

    <script>
        // Initialize WebSocket connection on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Store current user ID for comparison in RealtimeUI
            document.body.dataset.userId = "{{ user.id }}";

            // Create WebSocket manager instance
            const wsManager = new WebSocketManager();
            wsManager.connect();

            // Show connection status indicator (optional)
            wsManager.onConnectionStatus(function(status) {
                const indicator = document.getElementById('ws-status-indicator');
                if (indicator) {
                    indicator.className = 'ws-' + status;
                    indicator.title = 'WebSocket: ' + status;
                }
            });

            // Register message handlers for real-time updates
            wsManager.registerHandler('transaction_created', function(data) {
                window.RealtimeUI.handleTransactionCreated(data);
            });

            wsManager.registerHandler('transaction_updated', function(data) {
                window.RealtimeUI.handleTransactionUpdated(data);
            });

            wsManager.registerHandler('transaction_deleted', function(data) {
                window.RealtimeUI.handleTransactionDeleted(data);
            });

            wsManager.registerHandler('flowgroup_created', function(data) {
                window.RealtimeUI.handleFlowGroupCreated(data);
            });

            wsManager.registerHandler('flowgroup_updated', function(data) {
                window.RealtimeUI.handleFlowGroupUpdated(data);
            });

            wsManager.registerHandler('flowgroup_deleted', function(data) {
                window.RealtimeUI.handleFlowGroupDeleted(data);
            });

            wsManager.registerHandler('flowgroup_reordered', function(data) {
                window.RealtimeUI.handleFlowGroupReordered(data);
            });

            wsManager.registerHandler('bank_balance_updated', function(data) {
                window.RealtimeUI.handleBankBalanceUpdated(data);
            });

            wsManager.registerHandler('bank_balance_deleted', function(data) {
                window.RealtimeUI.handleBankBalanceDeleted(data);
            });

            wsManager.registerHandler('reconciliation_mode_changed', function(data) {
                window.RealtimeUI.handleReconciliationModeChanged(data);
            });

            wsManager.registerHandler('notification', function(data) {
                window.RealtimeUI.handleNotification(data);
            });
        });
    </script>
    {% endif %}
</body>
</html>
