{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"/>
    <title>{% block title %}{% trans "SweetMoney | Family Financial Flow" %}{% endblock title %}</title>

    <link rel="icon" type="image/x-icon" href="{% static 'finances/images/favicons/favicon.ico' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'finances/images/favicons/favicon.svg' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'finances/images/favicons/favicon-96x96.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'finances/images/favicons/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'finances/images/favicons/android-chrome-192x192.png' %}">
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'finances/images/favicons/android-chrome-512x512.png' %}">
    <link rel="manifest" href="{% static 'finances/images/favicons/site.webmanifest' %}">

    <link href="{% static 'finances/css/tailwind.css' %}" rel="stylesheet"/>
    <link href="{% static 'finances/css/fonts.css' %}" rel="stylesheet"/>

    <style>
        /* Auto-adjust for Windows DPI scaling */
        @media screen and (min-resolution: 144dpi) and (max-width: 1920px) {
            /* For 150% Windows scaling on FullHD screens */
            html {
                font-size: 14px; /* Reduce base font size from 16px */
            }
        }

        @media screen and (min-resolution: 192dpi) and (max-width: 1920px) {
            /* For 200% Windows scaling */
            html {
                font-size: 13px;
            }
        }

        /* Ensure containers are fluid and responsive */
        .container-fluid {
            max-width: 100%;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Prevent horizontal overflow */
        body {
            overflow-x: hidden;
        }

        /* Make buttons and inputs more responsive */
        @media (max-width: 1366px) {
            .btn, button, input[type="submit"] {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>

    <script defer src="{% static 'finances/js/alpine.min.js' %}"></script>

    <!-- Auto-scale adjustment for high DPI displays -->
    <script>
        (function() {
            'use strict';

            // Detect and adjust for Windows DPI scaling
            function adjustForDPIScaling() {
                const dpr = window.devicePixelRatio || 1;
                const screenWidth = window.screen.width * dpr;

                // If DPI scaling is detected (devicePixelRatio > 1) on a FullHD or smaller screen
                // Apply a slight zoom reduction to prevent UI elements from being cut off
                if (dpr >= 1.5 && screenWidth <= 1920) {
                    // Calculate optimal zoom level
                    const optimalZoom = Math.max(0.85, 1 / (dpr * 0.85));
                    document.documentElement.style.zoom = optimalZoom;

                    console.log('[DPI Adjust] Detected DPI scaling:', dpr, '| Applying zoom:', optimalZoom);
                }
            }

            // Run on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', adjustForDPIScaling);
            } else {
                adjustForDPIScaling();
            }

            // Re-adjust on window resize
            window.addEventListener('resize', function() {
                adjustForDPIScaling();
            });
        })();
    </script>
</head>
<body class="h-full bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200" x-data="{ sidebarOpen: false }">


    <div class="flex h-full">
        <aside :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}" 
               class="fixed inset-y-0 left-0 z-30 flex flex-col w-64 px-4 py-8 bg-white dark:bg-gray-800 border-r dark:border-gray-700 transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-0">
            
            <div class="flex items-center justify-between">
                <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center gap-2">
                    <img src="{% static 'finances/images/logo.png' %}" alt="SweetMoney" class="h-16 w-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="flex items-center gap-2" style="display: none;">
                        <span class="material-symbols-outlined text-3xl text-primary">savings</span>
                        <span class="text-2xl font-bold text-gray-800 dark:text-white">SweetMoney</span>
                    </div>
                </a>
                <button @click="sidebarOpen = false" class="md:hidden text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <nav class="flex flex-col justify-between flex-1 mt-6">
                <div class="space-y-2">
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'dashboard' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">dashboard</span>
                        <span class="mx-4 font-medium">{% trans "Dashboard" %}</span>
                    </a>

                    {% if not is_child %}
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'investments' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'investments' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">trending_up</span>
                        <span class="mx-4 font-medium">{% trans "Investments" %}</span>
                        <span class="text-xs font-normal text-teal-600 dark:text-teal-500 ml-auto">{% trans "Soon" %}</span>
                    </a>
                    {% endif %}

                    {% if not is_child %}
                    <a class="flex items-center px-4 py-2 rounded-md {% if request.resolver_match.url_name == 'configuration' or request.resolver_match.url_name == 'members' %}text-gray-700 bg-gray-100 dark:bg-gray-700 dark:text-gray-200{% else %}text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700{% endif %}" href="{% url 'configuration' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        <span class="material-symbols-outlined">settings</span>
                        <span class="mx-4 font-medium">{% trans "Settings" %}</span>
                    </a>
                    {% endif %}
                </div>

                <div class="mt-auto space-y-2">
                    <div class="pt-4 border-t dark:border-gray-700">
                        <a href="{% url 'user_profile' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center px-4 py-2 text-gray-600 rounded-md dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-bold mr-3">
                                {{ request.user.username|first|upper }}
                            </div>
                            <div class="flex flex-col">
                                <span class="font-semibold text-gray-800 dark:text-gray-200 text-sm">{{ request.user.username }}</span>
                                <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "View profile" %}</span>
                            </div>
                        </a>
                    </div>
                    
                    <div class="px-4 py-2">
                        <span id="sidebar-version" class="text-xs text-gray-500 dark:text-gray-600">{% trans "Version" %} {{ db_version }}</span>
                        <div id="sidebar-update-indicator" class="hidden text-xs text-orange-500 dark:text-orange-400 mt-1">
                            ({% trans "Update Available" %})
                        </div>
                    </div>
                </div>
            </nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-end p-4 bg-white dark:bg-gray-800 border-b dark:border-gray-700 w-full">
                
                <button @click="sidebarOpen = true" class="md:hidden text-gray-600 dark:text-gray-400">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        
                        {% if not is_child %}
                        <button onclick="openCreatePeriodModal()"
                                class="flex items-center space-x-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                title="{% trans 'Create New Period' %}">
                            <span class="material-symbols-outlined text-sm">add</span>
                            <span class="text-sm font-medium hidden md:inline">{% trans "New Period" %}</span>
                        </button>

                        <button type="button"
                                onclick="openDeletePeriodModal()"
                                style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background-color: #dc2626; color: white; border-radius: 8px; border: none; cursor: pointer; line-height: 1.25rem;"
                                title="{% trans 'Delete Current Period' %}">

                            <svg style="width: 20px; height: 20px; flex-shrink: 0;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.054.68-.11 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>

                            <span style="font-size: 14px; font-weight: 500;" class="hidden md:inline">{% trans "Delete Period" %}</span>
                        </button>
                        {% endif %}

                        <div x-data="{ periodDropdownOpen: false }" class="relative">
                            <button @click="periodDropdownOpen = !periodDropdownOpen" 
                                    class="flex items-center space-x-2 px-3 py-2 bg-primary/10 text-primary rounded-lg hover:bg-primary/20 transition-colors">
                                <span class="material-symbols-outlined text-sm">calendar_month</span>
                                <span class="text-sm font-medium">{{ current_period_label }}</span>
                                <span class="material-symbols-outlined text-sm">expand_more</span>
                            </button>
                            
                            <div x-show="periodDropdownOpen" 
                                 @click.away="periodDropdownOpen = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50"
                                 style="display: none;">
                                 <div class="py-1">
                                    {% for period in available_periods %}
                                    <a href="?period={{ period.value }}" 
                                       class="block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 {% if period.is_current %}bg-primary/10 text-primary font-semibold{% else %}text-gray-700 dark:text-gray-300{% endif %}">
                                        <div class="flex items-center justify-between">
                                            <span>{{ period.label }}</span>
                                            {% if period.is_current %}
                                            <span class="text-primary">●</span>
                                            {% elif period.has_data %}
                                            <span class="text-xs text-gray-400">•</span>
                                            {% endif %}
                                        </div>
                                    </a>
                                    {% empty %}
                                    <div class="px-4 py-2 text-sm text-gray-500">{% trans "No periods available" %}</div>
                                    {% endfor %}
                                 </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <button id="notification-bell" class="relative text-gray-600 dark:text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">notifications</span>
                            {% if unread_notifications_count > 0 %}
                            <span id="notification-badge" class="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                {{ unread_notifications_count }}
                            </span>
                            {% else %}
                            <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-yellow-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                                0
                            </span>
                            {% endif %}
                        </button>

                        <div id="notification-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-600 max-h-96 overflow-hidden z-50">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                <h3 class="font-semibold text-gray-900 dark:text-white">{% trans "Notifications" %}</h3>
                                <button id="acknowledge-all-btn" class="text-xs text-primary hover:text-primary/80 font-medium">
                                    {% trans "Mark all as read" %}
                                </button>
                            </div>
                            <div id="notification-list" class="overflow-y-auto max-h-80">
                                </div>
                        </div>
                    </div>

                    <button id="theme-toggle" class="text-gray-600 dark:text-gray-400 hover:text-primary transition-colors" title="{% trans 'Toggle Dark Mode' %}">
                        <span id="icon-dark" class="material-symbols-outlined block dark:hidden">dark_mode</span>
                        <span id="icon-light" class="material-symbols-outlined hidden dark:block">light_mode</span>
                    </button>

                    <form method="POST" action="{% url 'auth_logout' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="text-gray-600 dark:text-gray-400 hover:text-red-500" title="{% trans 'Logout' %}">
                            <span class="material-symbols-outlined">logout</span>
                        </button>
                    </form>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-background-light dark:bg-background-dark">
                {% if messages %}
                    <div class="p-4">
                        {% for message in messages %}
                            <div class="mb-2 p-3 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                {% block content %}
                {% endblock content %}
            </main>
        </div>
    </div>

    <!-- Admin Warning Modal -->
    {% if is_admin and not admin_warning_seen %}
    <div id="admin-warning-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="z-index: 9999;">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="bg-amber-600 p-4 flex items-center gap-3">
                <span class="material-symbols-outlined text-white text-3xl">warning</span>
                <h3 class="text-white text-xl font-bold">{% trans "Administrator Account" %}</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 dark:text-gray-300 mb-4">
                    {% trans "This is an Administrator account and should be used only for family group administration. Daily operations should be performed using Parent or Child accounts." %}
                </p>
                <button id="btn-dismiss-admin-warning" type="button" class="w-full px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium transition-colors">
                    {% trans "I Agree" %}
                </button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const modal = document.getElementById('admin-warning-modal');
        const btn = document.getElementById('btn-dismiss-admin-warning');

        if (btn && modal) {
            btn.addEventListener('click', function() {
                fetch('/mark-admin-warning-seen/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(function(response) {
                    if (response.ok) {
                        modal.remove();
                        if (typeof UpdateManager !== 'undefined' && !window.updateManager) {
                            window.updateManager = new UpdateManager();
                        }
                    }
                }).catch(function(err) {
                    console.error('Error dismissing admin warning:', err);
                    modal.remove();
                    if (typeof UpdateManager !== 'undefined' && !window.updateManager) {
                        window.updateManager = new UpdateManager();
                    }
                });
            });
        }
    })();
    </script>
    {% endif %}

    {% include 'finances/update_modal.html' %}

    <div id="createPeriodModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">{% trans "Create New Period" %}</h3>
                    <button onclick="closeCreatePeriodModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <form id="createPeriodForm" class="space-y-4">
                    <div>
                        <label for="period_start_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            {% trans "Start Date" %}
                        </label>
                        <input type="date" id="period_start_date" name="start_date" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                    </div>

                    <div>
                        <label for="period_end_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            {% trans "End Date" %}
                        </label>
                        <input type="date" id="period_end_date" name="end_date" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                    </div>

                    <div id="overlapWarning" class="hidden p-3 bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-400 dark:border-yellow-600 rounded-lg">
                        <div class="flex items-start">
                            <span class="material-symbols-outlined text-yellow-600 dark:text-yellow-400 mr-2">warning</span>
                            <div>
                                <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-300">{% trans "Warning: Period Overlap Detected" %}</p>
                                <p id="overlapMessage" class="text-sm text-yellow-700 dark:text-yellow-400 mt-1"></p>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="closeCreatePeriodModal()"
                                class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            {% trans "Cancel" %}
                        </button>
                        <button type="submit" id="createPeriodBtn"
                                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                            {% trans "Create" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="deletePeriodModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl mx-4 border-4 border-orange-500">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-red-600 dark:text-red-400">
                        <span class="material-symbols-outlined inline align-text-bottom mr-2">warning</span>
                        {% trans "Delete Period" %}
                    </h3>
                    <button onclick="closeDeletePeriodModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div id="deletePeriodContent" class="space-y-4">
                    <div id="deletePeriodLoading" class="text-center py-8">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">{% trans "Loading period details..." %}</p>
                    </div>

                    <div id="deletePeriodDetails" class="hidden">
                        <div id="deleteWarningBox" class="p-4 bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 rounded-lg mb-4">
                            <p class="text-sm font-semibold text-red-800 dark:text-red-300">
                                <span class="material-symbols-outlined text-sm align-text-bottom mr-1">warning</span>
                                <span id="deleteWarningText">{% trans "This action cannot be undone!" %}</span>
                            </p>
                            <p id="deleteActionDescription" class="text-sm text-red-700 dark:text-red-400 mt-1"></p>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">{% trans "Period Information" %}</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                <span class="font-medium">{% trans "Period:" %}</span> <span id="deletePeriodLabel"></span>
                            </p>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">{% trans "Period Summary" %}</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">{% trans "Flow Groups:" %}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" id="deleteFlowGroupCount">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">{% trans "Transactions:" %}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white" id="deleteTransactionCount">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3">{% trans "Key Metrics" %}</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Income (Estimated)" %}</p>
                                    <p class="font-semibold text-green-600 dark:text-green-400">
                                        <span id="deleteCurrencySymbol1"></span><span id="deleteIncomeEstimated">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Income (Realized)" %}</p>
                                    <p class="font-semibold text-green-700 dark:text-green-500">
                                        <span id="deleteCurrencySymbol2"></span><span id="deleteIncomeRealized">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Expenses (Estimated)" %}</p>
                                    <p class="font-semibold text-red-600 dark:text-red-400">
                                        <span id="deleteCurrencySymbol3"></span><span id="deleteExpenseEstimated">0.00</span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400 mb-1">{% trans "Expenses (Realized)" %}</p>
                                    <p class="font-semibold text-red-700 dark:text-red-500">
                                        <span id="deleteCurrencySymbol4"></span><span id="deleteExpenseRealized">0.00</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="flex items-center mb-4">
                                <input id="deleteConsentCheckbox"
                                       type="checkbox"
                                       onchange="toggleDeleteButton()"
                                       class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500 cursor-pointer">
                                <label for="deleteConsentCheckbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300 cursor-pointer">
                                    {% trans "I understand the consequences and want to proceed." %}
                                </label>
                            </div>

                            <div class="flex space-x-3">
                                <button type="button" onclick="closeDeletePeriodModal()"
                                        class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                                    {% trans "Cancel" %}
                                </button>
                                <button type="button" onclick="confirmDeletePeriod()" id="confirmDeleteBtn" disabled
                                        style="background-color: #d1d5db; color: #6b7280; cursor: not-allowed; transition: all 0.2s;"
                                        class="flex-1 px-4 py-2 rounded-lg shadow-sm flex items-center justify-center font-medium">
                                    <span id="deleteButtonText">{% trans "Delete Period" %}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{% static 'finances/js/notifications.js' %}"></script>

    <script>
        // Create Period Modal Functions
        function openCreatePeriodModal() {
            document.getElementById('createPeriodModal').classList.remove('hidden');
            // Reset form
            document.getElementById('createPeriodForm').reset();
            document.getElementById('overlapWarning').classList.add('hidden');
            document.getElementById('createPeriodBtn').disabled = false;
        }

        function closeCreatePeriodModal() {
            document.getElementById('createPeriodModal').classList.add('hidden');
        }

        // Validate overlap when dates change
        function validatePeriodOverlap() {
            const startDate = document.getElementById('period_start_date').value;
            const endDate = document.getElementById('period_end_date').value;
            const warningDiv = document.getElementById('overlapWarning');
            const createBtn = document.getElementById('createPeriodBtn');

            if (!startDate || !endDate) {
                warningDiv.classList.add('hidden');
                createBtn.disabled = false;
                return;
            }

            fetch('/api/period/validate-overlap/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.has_overlap) {
                    warningDiv.classList.remove('hidden');
                    document.getElementById('overlapMessage').textContent = data.message;
                    createBtn.disabled = true;
                    createBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    createBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                } else {
                    warningDiv.classList.add('hidden');
                    createBtn.disabled = false;
                    createBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    createBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }
            })
            .catch(error => {
                console.error('Error validating period:', error);
            });
        }

        // Attach validation to date inputs
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('period_start_date');
            const endDateInput = document.getElementById('period_end_date');

            if (startDateInput && endDateInput) {
                startDateInput.addEventListener('change', validatePeriodOverlap);
                endDateInput.addEventListener('change', validatePeriodOverlap);
            }
        });

        // Handle form submission
        document.getElementById('createPeriodForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const startDate = document.getElementById('period_start_date').value;
            const endDate = document.getElementById('period_end_date').value;
            const createBtn = document.getElementById('createPeriodBtn');

            // Disable button during submission
            createBtn.disabled = true;
            createBtn.textContent = "{% trans 'Creating...' %}";

            fetch('/api/period/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload page to show new period
                    window.location.href = `?period=${data.period.start_date}`;
                } else {
                    alert("{% trans 'Error:' %} " + data.error);
                    createBtn.disabled = false;
                    createBtn.textContent = "{% trans 'Create' %}";
                }
            })
            .catch(error => {
                console.error('Error creating period:', error);
                alert("{% trans 'An error occurred while creating the period' %}");
                createBtn.disabled = false;
                createBtn.textContent = "{% trans 'Create' %}";
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Delete Period Modal Functions
        let currentPeriodToDelete = null;

        // NOVA FUNÇÃO: Controla estado do botão baseado no checkbox
        function toggleDeleteButton() {
            const checkbox = document.getElementById('deleteConsentCheckbox');
            const btn = document.getElementById('confirmDeleteBtn');

            if (checkbox && checkbox.checked) {
                btn.disabled = false;
                btn.style.backgroundColor = '#dc2626'; // Vermelho
                btn.style.color = 'white';
                btn.style.cursor = 'pointer';
            } else if (btn) {
                btn.disabled = true;
                btn.style.backgroundColor = '#d1d5db'; // Cinza
                btn.style.color = '#6b7280';
                btn.style.cursor = 'not-allowed';
            }
        }

        function openDeletePeriodModal() {
            const modal = document.getElementById('deletePeriodModal');
            modal.classList.remove('hidden');

            // RESET: Desmarcar checkbox e travar botão
            const checkbox = document.getElementById('deleteConsentCheckbox');
            if (checkbox) {
                checkbox.checked = false;
                toggleDeleteButton(); // Aplica o estado visual de travado
            }

            // Show loading, hide content
            document.getElementById('deletePeriodLoading').classList.remove('hidden');
            document.getElementById('deletePeriodDetails').classList.add('hidden');

            // Get current period from URL or use default
            const urlParams = new URLSearchParams(window.location.search);
            const periodParam = urlParams.get('period');

            // Fetch period details
            const periodUrl = periodParam
                ? `/api/period/details/?period_start=${periodParam}`
                : `/api/period/details/?period_start={{ start_date|date:"Y-m-d" }}`;

            fetch(periodUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentPeriodToDelete = data.period.start_date;

                        // Populate modal with period data
                        document.getElementById('deletePeriodLabel').textContent = data.period.label;
                        document.getElementById('deleteFlowGroupCount').textContent = data.summary.flow_group_count;
                        document.getElementById('deleteTransactionCount').textContent = data.summary.transaction_count;

                        // Set currency symbols
                        const currencySymbol = data.summary.currency_symbol;
                        document.getElementById('deleteCurrencySymbol1').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol2').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol3').textContent = currencySymbol;
                        document.getElementById('deleteCurrencySymbol4').textContent = currencySymbol;

                        // Set metrics
                        document.getElementById('deleteIncomeEstimated').textContent = parseFloat(data.summary.total_income_estimated).toFixed(2);
                        document.getElementById('deleteIncomeRealized').textContent = parseFloat(data.summary.total_income_realized).toFixed(2);
                        document.getElementById('deleteExpenseEstimated').textContent = parseFloat(data.summary.total_expense_estimated).toFixed(2);
                        document.getElementById('deleteExpenseRealized').textContent = parseFloat(data.summary.total_expense_realized).toFixed(2);

                        // Translated strings
                        const txtCurrentPeriodWarning = "{% trans 'This is the CURRENT period. All flow groups and transactions will be CLEARED, but the period entry will be kept.' %}";
                        const txtPermanentDeleteWarning = "{% trans 'This period will be PERMANENTLY DELETED along with all its flow groups and transactions.' %}";
                        const txtClearPeriod = "{% trans 'Clear Period' %}";
                        const txtDeletePeriod = "{% trans 'Delete Period' %}";

                        // Update warning message based on whether it's current period
                        if (data.period.is_current) {
                            document.getElementById('deleteActionDescription').textContent = txtCurrentPeriodWarning;
                            document.getElementById('deleteButtonText').textContent = txtClearPeriod;
                        } else {
                            document.getElementById('deleteActionDescription').textContent = txtPermanentDeleteWarning;
                            document.getElementById('deleteButtonText').textContent = txtDeletePeriod;
                        }

                        // Hide loading, show content
                        document.getElementById('deletePeriodLoading').classList.add('hidden');
                        document.getElementById('deletePeriodDetails').classList.remove('hidden');
                    } else {
                        alert('Error loading period details: ' + data.error);
                        closeDeletePeriodModal();
                    }
                })
                .catch(error => {
                    console.error('Error fetching period details:', error);
                    alert('An error occurred while loading period details');
                    closeDeletePeriodModal();
                });
        }

        function closeDeletePeriodModal() {
            document.getElementById('deletePeriodModal').classList.add('hidden');
            currentPeriodToDelete = null;
        }

        function confirmDeletePeriod() {
            if (!currentPeriodToDelete) return;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.querySelector('#deleteButtonText').textContent;

            // Disable button
            confirmBtn.disabled = true;
            confirmBtn.querySelector('#deleteButtonText').textContent = "{% trans 'Processing...' %}";
            confirmBtn.style.cursor = 'wait';

            fetch('/api/period/delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    period_start: currentPeriodToDelete
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success message
                    alert(data.message);
                    // Redirect
                    window.location.href = data.redirect;
                } else {
                    alert("{% trans 'Error:' %} " + data.error);
                    confirmBtn.disabled = false;
                    confirmBtn.querySelector('#deleteButtonText').textContent = originalText;
                    // Restaura estilo vermelho pois o erro ocorreu
                    confirmBtn.style.cursor = 'pointer';
                }
            })
            .catch(error => {
                console.error('Error deleting period:', error);
                alert("{% trans 'An error occurred while deleting the period' %}");
                confirmBtn.disabled = false;
                confirmBtn.querySelector('#deleteButtonText').textContent = originalText;
                confirmBtn.style.cursor = 'pointer';
            });
        }
    </script>

    <script>
        // Dark mode toggle functionality - deterministic inline display (avoids FOUC)
        (function () {
            const themeToggle = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;
            // remove legacy class if present
            htmlElement.classList.remove('light');

            // Read saved preference or use system preference as fallback
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initial = saved ? saved : (prefersDark ? 'dark' : 'light');

            if (initial === 'dark') {
                htmlElement.classList.add('dark');
            } else {
                htmlElement.classList.remove('dark');
            }

            const iconDark = document.getElementById('icon-dark');
            const iconLight = document.getElementById('icon-light');

            function setIcons() {
                if (!iconDark || !iconLight) return;
                if (htmlElement.classList.contains('dark')) {
                    iconDark.style.display = 'none';
                    iconLight.style.display = 'inline-block';
                } else {
                    iconDark.style.display = 'inline-block';
                    iconLight.style.display = 'none';
                }
            }

            // apply immediately
            setIcons();

            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    htmlElement.classList.toggle('dark');
                    const newTheme = htmlElement.classList.contains('dark') ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    setIcons();
                });
            }
        })();
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>