{% extends "finances/base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<main class="p-6 md:p-10 lg:p-12">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-[#0d171b] dark:text-white text-2xl font-bold tracking-[-0.015em] mb-8">{% trans "Application Settings" %}</h1>

        <!-- Navigation Tabs -->
        <div x-data="{ activeTab: '{{ tab|default:"configuration" }}' }" class="mb-6">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8">
                    <button @click="activeTab = 'configuration'"
                            :class="activeTab === 'configuration' ? 'border-primary text-primary' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600'"
                            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">settings</span>
                            {% trans "Configuration" %}
                        </span>
                    </button>

                    <button @click="activeTab = 'members'"
                            :class="activeTab === 'members' ? 'border-primary text-primary' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600'"
                            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">group</span>
                            {% trans "Members" %}
                        </span>
                    </button>

                    {% if is_admin %}
                    <button @click="activeTab = 'backup'"
                            :class="activeTab === 'backup' ? 'border-primary text-primary' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600'"
                            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">backup</span>
                            {% trans "Backup & Restore" %}
                        </span>
                    </button>

                    <button @click="activeTab = 'updates'"
                            :class="activeTab === 'updates' ? 'border-primary text-primary' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300 dark:hover:border-gray-600'"
                            class="border-b-2 py-4 px-1 text-sm font-medium transition-colors">
                        <span class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">cloud_sync</span>
                            {% trans "Updates" %}
                        </span>
                    </button>
                    {% endif %}
                </nav>
            </div>
            
            <!-- Configuration Tab -->
            <div x-show="activeTab === 'configuration'" class="mt-6" x-cloak>
                {% if is_child %}
                <!-- Child User Restriction Message -->
                <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-6 rounded-lg">
                    <div class="flex items-start">
                        <span class="material-symbols-outlined text-amber-500 text-2xl mr-3">block</span>
                        <div>
                            <h3 class="text-lg font-semibold text-amber-900 dark:text-amber-200 mb-2">{% trans "Access Restricted" %}</h3>
                            <p class="text-amber-800 dark:text-amber-300">
                                {% trans "Child users cannot access system configuration settings. Please contact an Admin or Parent user to modify these settings." %}
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <form method="post" id="configuration-form" class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    {% csrf_token %}
                    <input type="hidden" name="confirm_period_change" id="confirm-period-change-input" value="false">
                    <div class="p-6 space-y-6">
                        
                        <!-- Base Currency Selection -->
                        <div class="flex flex-col">
                            <label class="text-[#0d171b] dark:text-gray-300 text-base font-medium leading-normal pb-2" for="{{ form.base_currency.id_for_label }}">{% trans "Base Currency" %}</label>
                            {{ form.base_currency }}
                            <p class="text-xs text-gray-500 mt-1">{% trans "All financial values will be stored and displayed in this currency. Changing this will not convert existing values." %}</p>
                        </div>

                        <!-- Period Type Selection -->
                        <div class="flex flex-col {% if not is_admin %}opacity-60 pointer-events-none{% endif %}">
                            <label class="text-[#0d171b] dark:text-gray-300 text-base font-medium leading-normal pb-2">
                                {% trans "Period Frequency" %}
                                {% if not is_admin %}
                                <span class="text-xs text-gray-500 font-normal">({% trans "Admin only" %})</span>
                                {% endif %}
                            </label>
                            <div class="space-y-3">
                                {% for radio in form.period_type %}
                                <label class="flex items-center gap-3 border border-[#cfdfe7] dark:border-gray-600 p-[15px] rounded-lg {% if is_admin %}cursor-pointer hover:bg-slate-50 dark:hover:bg-gray-700{% else %}cursor-not-allowed{% endif %}">
                                    {{ radio.tag }}
                                    <div class="flex grow flex-col">
                                        <p class="text-[#0d171b] dark:text-white text-sm font-medium leading-normal">{{ radio.choice_label }}</p>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Starting Day - Only for Monthly -->
                        <div id="starting-day-field" class="flex flex-col {% if not is_admin %}opacity-60 pointer-events-none{% endif %}">
                            <label class="text-[#0d171b] dark:text-gray-300 text-base font-medium leading-normal pb-2" for="{{ form.starting_day.id_for_label }}">
                                {% trans "Starting Day of Month" %}
                                {% if not is_admin %}
                                <span class="text-xs text-gray-500 font-normal">({% trans "Admin only" %})</span>
                                {% endif %}
                            </label>
                            <input type="number" name="starting_day" id="{{ form.starting_day.id_for_label }}" value="{{ form.starting_day.value|default:'' }}" min="1" max="31" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-teal-500 focus:border-transparent" {% if not is_admin %}disabled{% endif %}>
                            <p class="text-xs text-gray-500 mt-1">{% trans "Day of the month (1-31) that defines the cycle start." %}</p>
                        </div>

                        <!-- Base Date - Only for Bi-weekly/Weekly -->
                        <div id="base-date-field" class="flex flex-col {% if not is_admin %}opacity-60 pointer-events-none{% endif %}" style="display: none;">
                            <label class="text-[#0d171b] dark:text-gray-300 text-base font-medium leading-normal pb-2" for="{{ form.base_date.id_for_label }}">
                                {% trans "Base Date for Cycle" %}
                                {% if not is_admin %}
                                <span class="text-xs text-gray-500 font-normal">({% trans "Admin only" %})</span>
                                {% endif %}
                            </label>
                            <input type="date" name="base_date" id="{{ form.base_date.id_for_label }}" value="{% if form.base_date.value %}{{ form.base_date.value|date:'Y-m-d' }}{% endif %}" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-teal-500 focus:border-transparent" {% if not is_admin %}disabled{% endif %}>
                            <p class="text-xs text-gray-500 mt-1">{% trans "Reference date used to calculate bi-weekly or weekly periods." %}</p>
                        </div>

                        <!-- Bank Reconciliation Tolerance -->
                        <div class="flex flex-col">
                            <label class="text-[#0d171b] dark:text-gray-300 text-base font-medium leading-normal pb-2" for="{{ form.bank_reconciliation_tolerance.id_for_label }}">{% trans "Bank Reconciliation Tolerance (%)" %}</label>
                            {{ form.bank_reconciliation_tolerance }}
                            <p class="text-xs text-gray-500 mt-1">{% trans "Percentage tolerance for bank reconciliation discrepancy warnings (e.g., 5.00 for 5%)." %}</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-[#dee2e6] dark:border-gray-700 flex justify-end gap-4 p-6">
                        <button type="submit" class="rounded-lg bg-primary text-white text-sm font-medium leading-normal p-3 hover:bg-primary/90">
                            {% trans "Save Configuration" %}
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>

            <!-- Members Tab -->
            <div x-show="activeTab === 'members'" class="mt-6" x-cloak x-data="{ editMemberId: null, editUsername: '', editEmail: '', editRole: '', showPasswordModal: false, passwordMemberId: null, showDeleteModal: false, deleteMemberId: null, deleteMemberUsername: '' }">
                {% if is_admin or is_parent %}
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-10 border border-primary/20">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white mb-4">{% trans "Add New Member" %}</h2>

                    {% if is_parent %}
                    <div class="p-3 mb-4 text-sm text-blue-700 bg-blue-100 rounded-lg dark:bg-blue-200 dark:text-blue-800" role="alert">
                        <p><strong>{% trans "Note:" %}</strong> {% trans "As a Parent, you can only add Child users." %}</p>
                    </div>
                    {% endif %}

                    {% if add_member_form.non_field_errors %}
                        <div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800" role="alert">
                            <p><strong>{% trans "Error:" %}</strong> {{ add_member_form.non_field_errors }}</p>
                        </div>
                    {% endif %}

                    <form id="add-member-form" method="POST" action="{% url 'member_add' %}{% if selected_period %}?period={{ selected_period }}{% endif %}">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 gap-4 md:gap-6 md:grid-cols-5 items-end">

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ add_member_form.username.id_for_label }}">
                                    {{ add_member_form.username.label }}
                                </label>
                                {{ add_member_form.username }}
                                {% for error in add_member_form.username.errors %}
                                    <p class="mt-1 text-xs text-red-500">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ add_member_form.email.id_for_label }}">
                                    {{ add_member_form.email.label }}
                                </label>
                                {{ add_member_form.email }}
                                {% for error in add_member_form.email.errors %}
                                    <p class="mt-1 text-xs text-red-500">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ add_member_form.password.id_for_label }}">
                                    {{ add_member_form.password.label }}
                                </label>
                                {{ add_member_form.password }}
                                {% for error in add_member_form.password.errors %}
                                    <p class="mt-1 text-xs text-red-500">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ add_member_form.role.id_for_label }}">
                                    {{ add_member_form.role.label }}
                                </label>
                                {% if is_parent %}
                                    <select name="role" id="{{ add_member_form.role.id_for_label }}" class="w-full border rounded-lg bg-background-light dark:bg-background-dark border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-slate-800 dark:text-slate-200 p-2">
                                        <option value="CHILD">Child</option>
                                    </select>
                                {% else %}
                                    {{ add_member_form.role }}
                                {% endif %}
                                {% for error in add_member_form.role.errors %}
                                    <p class="mt-1 text-xs text-red-500">{{ error }}</p>
                                {% endfor %}
                            </div>

                            <div class="w-full">
                                <button type="submit" class="w-full rounded-lg bg-primary text-white text-base font-bold p-3 h-12 flex items-center justify-center hover:bg-primary/90 transition-colors shadow-lg">
                                    <span class="material-symbols-outlined mr-1">add</span>
                                    {% trans "Add" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}

                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Member" %}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Email" %}</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Role" %}</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Actions" %}</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            {% for item in members_with_permissions %}
                            <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50" data-member-id="{{ item.member.id }}">
                                <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white">{{ item.member.user.username }}</td>
                                <td class="px-6 py-4 text-sm text-gray-500">{{ item.member.user.email|default:"-" }}</td>
                                <td class="px-6 py-4 text-sm text-gray-500">
                                    <span class="px-2 py-1 text-sm font-medium rounded-full bg-primary/20 text-primary">{{ item.member.get_role_display }}</span>
                                </td>
                                <td class="px-6 py-4 text-center whitespace-nowrap">
                                    <div class="flex justify-center gap-2">
                                        {% if item.can_edit %}
                                        <button type="button"
                                                @click="editMemberId = {{ item.member.id }}; editUsername = '{{ item.member.user.username }}'; editEmail = '{{ item.member.user.email }}'; editRole = '{{ item.member.role }}'"
                                                class="p-1 text-slate-500 hover:text-primary"
                                                title="{% trans 'Edit' %}">
                                            <span class="material-symbols-outlined text-lg">edit</span>
                                        </button>
                                        {% endif %}

                                        {% if item.can_change_password %}
                                        <button type="button"
                                                @click="passwordMemberId = {{ item.member.id }}; showPasswordModal = true"
                                                class="p-1 text-slate-500 hover:text-blue-500"
                                                title="{% trans 'Change Password' %}">
                                            <span class="material-symbols-outlined text-lg">key</span>
                                        </button>
                                        {% endif %}

                                        {% if item.can_delete %}
                                        <button type="button"
                                                @click="showDeleteModal = true; deleteMemberId = {{ item.member.id }}; deleteMemberUsername = '{{ item.member.user.username }}'"
                                                class="p-1 text-slate-500 hover:text-red-500"
                                                title="{% trans 'Remove' %}">
                                            <span class="material-symbols-outlined text-lg">delete</span>
                                        </button>
                                        {% endif %}

                                        {% if not item.can_edit and not item.can_change_password and not item.can_delete %}
                                        <span class="text-xs text-gray-400 dark:text-gray-500">{% trans "View only" %}</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-sm text-gray-500 text-center">{% trans "No members found in the family." %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Edit Member Modal -->
                <div x-show="editMemberId !== null"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 z-50 overflow-y-auto"
                     style="display: none;">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-black opacity-50" @click="editMemberId = null"></div>

                        <div class="relative bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 z-10">
                            <h3 class="text-xl font-bold text-[#0d171b] dark:text-white mb-4">{% trans "Edit Member" %}</h3>

                            <form method="POST" :action="`/members/edit/${editMemberId}/{% if selected_period %}?period={{ selected_period }}{% endif %}`">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_info">

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Username" %}</label>
                                        <input type="text" name="username" x-model="editUsername" class="w-full border rounded-lg bg-white dark:bg-gray-700 border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-gray-900 dark:text-white p-2" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Email" %}</label>
                                        <input type="email" name="email" x-model="editEmail" class="w-full border rounded-lg bg-white dark:bg-gray-700 border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-gray-900 dark:text-white p-2">
                                    </div>

                                    {% if is_admin %}
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Role" %}</label>
                                        <select name="role" x-model="editRole" class="w-full border rounded-lg bg-white dark:bg-gray-700 border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-gray-900 dark:text-white p-2">
                                            <option value="ADMIN">{% trans "Admin" %}</option>
                                            <option value="PARENT">{% trans "Parent" %}</option>
                                            <option value="CHILD">{% trans "Child" %}</option>
                                        </select>
                                    </div>
                                    {% else %}
                                    <input type="hidden" name="role" x-model="editRole">
                                    {% endif %}
                                </div>

                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" @click="editMemberId = null" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                        {% trans "Save Changes" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Change Password Modal -->
                <div x-show="showPasswordModal"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 z-50 overflow-y-auto"
                     style="display: none;">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-black opacity-50" @click="showPasswordModal = false"></div>

                        <div class="relative bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 z-10">
                            <h3 class="text-xl font-bold text-[#0d171b] dark:text-white mb-4">{% trans "Change Password" %}</h3>

                            <form method="POST" :action="`/members/edit/${passwordMemberId}/{% if selected_period %}?period={{ selected_period }}{% endif %}`">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="change_password">

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "New Password" %}</label>
                                        <input type="password" name="new_password" class="w-full border rounded-lg bg-background-light dark:bg-background-dark border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-slate-800 dark:text-slate-200 p-2" required>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">{% trans "Confirm Password" %}</label>
                                        <input type="password" name="confirm_password" class="w-full border rounded-lg bg-background-light dark:bg-background-dark border-slate-300 dark:border-slate-700 focus:ring-primary focus:border-primary text-slate-800 dark:text-slate-200 p-2" required>
                                    </div>
                                </div>

                                <div class="mt-6 flex justify-end space-x-3">
                                    <button type="button" @click="showPasswordModal = false; passwordMemberId = null" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                        {% trans "Change Password" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div x-show="showDeleteModal"
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-200"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="fixed inset-0 z-50 overflow-y-auto"
                     style="display: none;">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        <div class="fixed inset-0 bg-black opacity-50" @click="showDeleteModal = false"></div>

                        <div class="relative bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6 z-10">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="material-symbols-outlined text-red-500 text-3xl">warning</span>
                                <h3 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Confirm Removal" %}</h3>
                            </div>

                            <p class="text-gray-600 dark:text-gray-300 mb-6">
                                {% trans "Are you sure you want to remove" %} <strong x-text="deleteMemberUsername"></strong> {% trans "from the family?" %}
                            </p>

                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                                {% trans "This action cannot be undone. The user account and all associated data will be permanently deleted." %}
                            </p>

                            <form method="POST" :action="`/members/remove/${deleteMemberId}/{% if selected_period %}?period={{ selected_period }}&tab=members{% else %}?tab=members{% endif %}`">
                                {% csrf_token %}
                                <div class="flex justify-end space-x-3">
                                    <button type="button" @click="showDeleteModal = false; deleteMemberId = null" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                                        {% trans "Cancel" %}
                                    </button>
                                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                        {% trans "Remove Member" %}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore Tab -->
            {% if is_admin %}
            <div x-show="activeTab === 'backup'" class="mt-6 space-y-6" x-cloak>
                <!-- Database Backup Section -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="material-symbols-outlined text-amber-600 text-2xl">backup</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 dark:text-white text-lg">{% trans "Backup Database" %}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    {% trans "Download a complete backup of your database. Keep this file safe for recovery purposes." %}
                                </p>
                            </div>
                        </div>

                        <button id="btn-backup-db"
                                class="w-full px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">download</span>
                            {% trans "Download Database Backup" %}
                        </button>
                    </div>
                </div>
                
                <!-- Database Restore Section -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="material-symbols-outlined text-blue-600 text-2xl">upload_file</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 dark:text-white text-lg">{% trans "Restore Database" %}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    {% trans "Restore your database from a previously saved backup file." %}
                                </p>
                            </div>
                        </div>

                        <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-4">
                            <div class="flex">
                                <span class="material-symbols-outlined text-red-500 mr-2">warning</span>
                                <div>
                                    <h4 class="font-semibold text-red-900 dark:text-red-200">{% trans "Warning" %}</h4>
                                    <p class="text-sm text-red-800 dark:text-red-300 mt-1">
                                        {% trans "Restoring a backup will replace your current database. This action cannot be undone." %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <input type="file" id="restore-file-input" accept=".sqlite3" class="hidden">
                            <label for="restore-file-input" class="cursor-pointer">
                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2 block">cloud_upload</span>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                                    {% trans "Click to select a backup file" %}
                                </p>
                                <p class="text-xs text-gray-500">{% trans "SQLite3 database files only" %}</p>
                            </label>
                        </div>

                        <p id="restore-file-name" class="text-sm text-gray-600 dark:text-gray-400 mt-2 text-center">
                            {% trans "No file selected" %}
                        </p>

                        <button id="btn-restore-db" disabled
                                class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="material-symbols-outlined">restore</span>
                            {% trans "Restore Database" %}
                        </button>

                        <!-- Restore Preview (shown after restore) -->
                        <div id="restore-preview" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <h4 class="font-semibold text-green-900 dark:text-green-200 mb-2">{% trans "Restore Complete" %}</h4>
                            <p class="text-sm text-green-800 dark:text-green-300 mb-2">
                                {% trans "Family:" %} <span id="restore-family-name" class="font-semibold"></span>
                            </p>
                            <p class="text-sm text-green-800 dark:text-green-300 mb-1">{% trans "Users:" %}</p>
                            <ul id="restore-users-list" class="list-disc list-inside text-sm text-green-700 dark:text-green-400">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Updates Tab -->
            {% if is_admin %}
            <div x-show="activeTab === 'updates'" class="mt-6 space-y-6" x-cloak>
                <!-- Current Version Info -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-blue-900 dark:text-blue-200 font-medium">{% trans "Current System Version" %}</p>
                                    <p class="text-2xl font-mono text-blue-700 dark:text-blue-300 mt-1">
                                        {{ VERSION }}
                                    </p>
                                </div>
                                <span class="material-symbols-outlined text-4xl text-blue-500">info</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GitHub Update Check -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="material-symbols-outlined text-green-600 text-2xl">cloud_download</span>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 dark:text-white text-lg">{% trans "Check for Online Updates" %}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    {% trans "Check GitHub repository for the latest available release." %}
                                </p>
                            </div>
                        </div>

                        <!--
                        CORREÇÃO: O ID deste botão foi alterado de 'btn-check-online-updates'
                        para 'manualCheckUpdates' para que o script global update_manager.js
                        possa encontrá-lo e anexar o listener correto.
                        -->
                        <button id="manualCheckUpdates"
                                class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">refresh</span>
                            {% trans "Check for Updates" %}
                        </button>
                        
                        <!-- 
                        NOTA: A DIV 'online-update-info' abaixo não é mais usada
                        pelo 'addEventListener' local, pois ele foi removido.
                        O update_manager.js agora controla o fluxo e abrirá o modal
                        diretamente.
                        
                        Esta DIV de feedback pode ser removida ou deixada
                        para uso futuro, se necessário.
                        -->
                        <div id="online-update-info" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                            <div id="no-updates-found" class="hidden text-center text-gray-600 dark:text-gray-400">
                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">check_circle</span>
                                <p class="font-medium">{% trans "System is up to date!" %}</p>
                                <p class="text-sm mt-1">{% trans "Latest version:" %} <span id="github-latest-version" class="font-mono"></span></p>
                            </div>

                            <div id="updates-available" class="hidden">
                                <!-- ... (conteúdo de 'updates-available') ... -->
                            </div>

                            <div id="local-update-pending" class="hidden text-center text-orange-600 dark:text-orange-400">
                                <span class="material-symbols-outlined text-4xl mb-2">construction</span>
                                <p class="font-medium">{% trans "Local updates pending" %}</p>
                                <p class="text-sm mt-1">{% trans "Please apply local updates first before checking for online updates." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<!-- Include Period Change Confirmation Modal -->
{% include "finances/period_change_confirmation_modal.html" %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration tab: Period type field visibility
    const periodTypeRadios = document.querySelectorAll('input[name="period_type"]');
    const startingDayField = document.getElementById('starting-day-field');
    const baseDateField = document.getElementById('base-date-field');
    
    function updateFieldVisibility() {
        const selectedPeriodType = document.querySelector('input[name="period_type"]:checked')?.value;
        
        if (selectedPeriodType === 'M') {
            startingDayField.style.display = 'block';
            baseDateField.style.display = 'none';
        } else {
            startingDayField.style.display = 'none';
            baseDateField.style.display = 'block';
        }
    }
    
    periodTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateFieldVisibility);
    });

    updateFieldVisibility();

    // Period Change Confirmation Logic
    const configForm = document.getElementById('configuration-form');
    const confirmInput = document.getElementById('confirm-period-change-input');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');

    if (configForm) {
        configForm.addEventListener('submit', async function(e) {
            // If already confirmed, let it proceed normally
            if (confirmInput.value === 'true') {
                console.log('[CONFIG FORM] Submitting with confirmation');
                return true;
            }

            // Intercept submit to check if period change confirmation is needed
            e.preventDefault();
            console.log('[CONFIG FORM] Form submit intercepted - checking for period changes');

            const formData = new FormData(configForm);

            try {
                const response = await fetch(configForm.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                // Check if response is JSON (modal data) or HTML (normal response)
                const contentType = response.headers.get('content-type');

                if (contentType && contentType.includes('application/json')) {
                    // Server returned JSON - this means we need to show confirmation modal
                    const data = await response.json();

                    if (data.requires_confirmation) {
                        console.log('[CONFIG FORM] Period change requires confirmation - showing modal');
                        console.log('[CONFIG FORM] Modal data:', data);

                        // Show the modal with impact data
                        showPeriodChangeModal(data);

                        // Set up confirm button handler
                        modalConfirmBtn.onclick = function() {
                            console.log('[CONFIG FORM] User confirmed period change');

                            // Set confirmation flag
                            confirmInput.value = 'true';

                            // Close modal
                            closePeriodChangeModal();

                            // Submit form normally
                            configForm.submit();
                        };
                    }
                } else {
                    // Server returned HTML - no confirmation needed, reload page
                    console.log('[CONFIG FORM] No confirmation needed - reloading page');
                    window.location.reload();
                }
            } catch (error) {
                console.error('[CONFIG FORM] Error submitting form:', error);
                alert('{% trans "An error occurred while saving configuration. Please try again." %}');
            }
        });
    }

    // Backup functionality
    const backupBtn = document.getElementById('btn-backup-db');
    if (!backupBtn) {
        console.error('Backup button not found! Expected ID: btn-backup-db');
    }

    backupBtn?.addEventListener('click', async function() {
        console.log('Backup button clicked');
        const btn = this;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> {% trans "Creating backup..." %}';

        try {
            console.log('Sending backup request to /create-backup/');
            const response = await fetch('/create-backup/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            console.log('Backup response status:', response.status);
            const data = await response.json();
            console.log('Backup response data:', data);

            if (data.success) {
                console.log('Redirecting to download:', data.filename);
                window.location.href = `/download-backup/${data.filename}/`;
            } else {
                console.error('Backup failed:', data.error);
                alert("{% trans 'Failed to create backup:' %} " + data.error);
            }
        } catch (error) {
            console.error('Error creating backup:', error);
            alert("{% trans 'Failed to create backup:' %} " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
    
    // Restore functionality
    const restoreFileInput = document.getElementById('restore-file-input');
    const restoreFileName = document.getElementById('restore-file-name');
    const btnRestore = document.getElementById('btn-restore-db');
    
    restoreFileInput?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            restoreFileName.textContent = file.name;
            btnRestore.disabled = false;
        } else {
            restoreFileName.textContent = "{% trans 'No file selected' %}";
            btnRestore.disabled = true;
        }
    });

    btnRestore?.addEventListener('click', async function() {
        const file = restoreFileInput.files[0];
        if (!file) {
            alert("{% trans 'Please select a backup file first' %}");
            return;
        }

        if (!confirm("{% trans 'WARNING: This will replace your current database. All current data will be lost. Continue?' %}")) {
            return;
        }

        const btn = this;
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> {% trans "Restoring..." %}';
        
        try {
            const formData = new FormData();
            formData.append('backup_file', file);
            
            const response = await fetch('/restore-backup/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                const preview = document.getElementById('restore-preview');
                const familyName = document.getElementById('restore-family-name');
                const usersList = document.getElementById('restore-users-list');
                
                familyName.textContent = data.family.name;
                usersList.innerHTML = '';
                data.users.forEach(user => {
                    const li = document.createElement('li');
                    li.textContent = `${user.username} (${user.role})`;
                    usersList.appendChild(li);
                });
                
                preview.classList.remove('hidden');

                alert("{% trans 'Database restored successfully! Please log out and log in again.' %}");
            } else {
                alert("{% trans 'Failed to restore backup:' %} " + data.error);
            }
        } catch (error) {
            console.error('Error restoring backup:', error);
            alert("{% trans 'Failed to restore backup:' %} " + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
            restoreFileInput.value = '';
            restoreFileName.textContent = "{% trans 'No file selected' %}";
            btn.disabled = true;
        }
    });
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

// ============================================
// REAL-TIME SYNCHRONIZATION
// ============================================

// Configuration Real-time Updates
window.ConfigurationRealtime = {
    updateConfiguration: function(configData) {
        console.log('[ConfigurationRT] Updating configuration:', configData);

        // Update Base Currency
        const currencySelect = document.getElementById('id_base_currency');
        if (currencySelect && configData.base_currency) {
            currencySelect.value = configData.base_currency;
            console.log('[ConfigurationRT] Updated base_currency to:', configData.base_currency);
        }

        // Update Period Type
        if (configData.period_type) {
            const periodTypeRadio = document.querySelector(`input[name="period_type"][value="${configData.period_type}"]`);
            if (periodTypeRadio) {
                periodTypeRadio.checked = true;
                console.log('[ConfigurationRT] Updated period_type to:', configData.period_type);

                // Toggle field visibility based on period type
                const startingDayField = document.getElementById('starting-day-field');
                const baseDateField = document.getElementById('base-date-field');

                if (configData.period_type === 'M') {
                    // Monthly - show starting day, hide base date
                    if (startingDayField) startingDayField.style.display = 'block';
                    if (baseDateField) baseDateField.style.display = 'none';
                } else {
                    // Bi-weekly or Weekly - hide starting day, show base date
                    if (startingDayField) startingDayField.style.display = 'none';
                    if (baseDateField) baseDateField.style.display = 'block';
                }
            }
        }

        // Update Starting Day
        const startingDayInput = document.getElementById('id_starting_day');
        if (startingDayInput && configData.starting_day) {
            startingDayInput.value = configData.starting_day;
            console.log('[ConfigurationRT] Updated starting_day to:', configData.starting_day);
        }

        // Update Base Date
        const baseDateInput = document.getElementById('id_base_date');
        if (baseDateInput && configData.base_date) {
            baseDateInput.value = configData.base_date;
            console.log('[ConfigurationRT] Updated base_date to:', configData.base_date);
        }

        // Update Bank Reconciliation Tolerance
        const toleranceInput = document.getElementById('id_bank_reconciliation_tolerance');
        if (toleranceInput && configData.bank_reconciliation_tolerance) {
            toleranceInput.value = configData.bank_reconciliation_tolerance;
            console.log('[ConfigurationRT] Updated bank_reconciliation_tolerance to:', configData.bank_reconciliation_tolerance);
        }
    }
};

// Members Real-time Updates
window.MembersRealtime = {
    addMember: function(memberData) {
        console.log('[MembersRT] Adding member:', memberData);

        const tbody = document.querySelector('table tbody');
        if (!tbody) {
            console.warn('[MembersRT] Members table tbody not found');
            return;
        }

        // Check if member already exists in table (prevent duplicates)
        const existingRow = tbody.querySelector(`tr[data-member-id="${memberData.id}"]`);
        if (existingRow) {
            console.log('[MembersRT] Member already exists in table, skipping duplicate add');
            return;
        }

        // Remove empty message if exists
        const emptyRow = tbody.querySelector('td[colspan="4"]');
        if (emptyRow) {
            emptyRow.parentElement.remove();
        }

        // Create new row
        const newRow = document.createElement('tr');
        newRow.className = 'hover:bg-slate-50 dark:hover:bg-gray-700/50';
        newRow.setAttribute('data-member-id', memberData.id);

        newRow.innerHTML = `
            <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white">${this.escapeHtml(memberData.username)}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${this.escapeHtml(memberData.email || '-')}</td>
            <td class="px-6 py-4 text-sm text-gray-500">
                <span class="px-2 py-1 text-sm font-medium rounded-full bg-primary/20 text-primary">${this.escapeHtml(memberData.role_display)}</span>
            </td>
            <td class="px-6 py-4 text-center whitespace-nowrap">
                <div class="flex justify-center gap-2">
                    <span class="text-xs text-gray-400 dark:text-gray-500">{% trans "View only" %}</span>
                </div>
            </td>
        `;

        tbody.appendChild(newRow);

        // Highlight new row
        if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
            window.RealtimeUI.utils.highlightElement(newRow, 2000);
        }
    },

    updateMember: function(memberData) {
        console.log('[MembersRT] Updating member:', memberData);

        const row = document.querySelector(`tr[data-member-id="${memberData.id}"]`);
        if (!row) {
            console.warn('[MembersRT] Member row not found for ID:', memberData.id);
            return;
        }

        // Update username
        const usernameCell = row.querySelector('td:nth-child(1)');
        if (usernameCell) {
            usernameCell.textContent = memberData.username;
        }

        // Update email
        const emailCell = row.querySelector('td:nth-child(2)');
        if (emailCell) {
            emailCell.textContent = memberData.email || '-';
        }

        // Update role
        const roleCell = row.querySelector('td:nth-child(3) span');
        if (roleCell) {
            roleCell.textContent = memberData.role_display;
        }

        // Highlight updated row
        if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
            window.RealtimeUI.utils.highlightElement(row, 2000);
        }
    },

    removeMember: function(memberData) {
        console.log('[MembersRT] Removing member:', memberData);

        const row = document.querySelector(`tr[data-member-id="${memberData.id}"]`);
        if (!row) {
            console.warn('[MembersRT] Member row not found for ID:', memberData.id);
            return;
        }

        // Add fade-out animation
        row.style.transition = 'opacity 0.3s';
        row.style.opacity = '0';

        setTimeout(() => {
            row.remove();

            // Check if table is empty and add empty message
            const tbody = document.querySelector('table tbody');
            if (tbody && tbody.children.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" class="px-6 py-4 text-sm text-gray-500 text-center">{% trans "No members found in the family." %}</td>
                `;
                tbody.appendChild(emptyRow);
            }
        }, 300);
    },

    escapeHtml: function(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
};

// Listen for configuration events
document.addEventListener('realtime:configuration:updated', function(event) {
    if (window.ConfigurationRealtime && window.ConfigurationRealtime.updateConfiguration) {
        window.ConfigurationRealtime.updateConfiguration(event.detail.data);
    }
});

// Listen for member events
document.addEventListener('realtime:member:added', function(event) {
    if (window.MembersRealtime && window.MembersRealtime.addMember) {
        window.MembersRealtime.addMember(event.detail.data);
    }
});

document.addEventListener('realtime:member:updated', function(event) {
    if (window.MembersRealtime && window.MembersRealtime.updateMember) {
        window.MembersRealtime.updateMember(event.detail.data);
    }
});

document.addEventListener('realtime:member:removed', function(event) {
    // Check if current user is the actor (who performed the action)
    // If yes, skip the real-time update as the page will redirect
    const currentUsername = '{{ request.user.username }}';
    const actorUsername = event.detail.actor?.username;

    if (actorUsername && actorUsername === currentUsername) {
        console.log('[MembersRT] Current user is the actor, skipping real-time removal (page will redirect)');
        return;
    }

    if (window.MembersRealtime && window.MembersRealtime.removeMember) {
        window.MembersRealtime.removeMember(event.detail.data);
    }
});

// Add Member Form - Prevent page reload
const addMemberForm = document.getElementById('add-member-form');
if (addMemberForm) {
    addMemberForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(addMemberForm);
        const submitBtn = addMemberForm.querySelector('button[type="submit"]');

        // Disable button during submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="material-symbols-outlined mr-1 animate-spin">progress_activity</span>{% trans "Adding..." %}';

        fetch(addMemberForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.redirected) {
                // If redirected, means there was an error (redirect to same page with errors)
                // Reload to show errors
                window.location.href = response.url;
            } else {
                // Success - member was added
                // Reset form
                addMemberForm.reset();

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span class="material-symbols-outlined mr-1">add</span>{% trans "Add" %}';

                // The WebSocket will add the new row automatically
                console.log('[AddMember] Member added successfully, waiting for WebSocket update');
            }
        })
        .catch(error => {
            console.error('[AddMember] Error:', error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span class="material-symbols-outlined mr-1">add</span>{% trans "Add" %}';
            alert('{% trans "Error adding member. Please try again." %}');
        });
    });
}

console.log('[ConfigurationRealtime] Loaded successfully');
console.log('[MembersRealtime] Loaded successfully');

</script>
{% endblock %}