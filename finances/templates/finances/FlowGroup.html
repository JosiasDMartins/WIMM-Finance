{% extends "finances/base.html" %}
{% load static %}
{% load humanize %} 

{% block title %}Flow Group: {{ flow_group.name|default:"New Group" }}{% endblock title %}

{% block content %}
<div class="p-6 md:p-10 lg:p-12">
    
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center text-primary hover:text-primary/80 transition-colors">
            <span class="material-symbols-outlined mr-2">arrow_back</span>
            Back to Dashboard
        </a>

        <div class="flex space-x-4">
            {% if not is_new and can_edit_group %}
            <button type="button" onclick="deleteFlowGroup()" class="rounded-lg border border-red-500 text-red-500 text-base font-medium p-3 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                <span class="material-symbols-outlined text-lg mr-2">delete</span>
                Delete Group
            </button>
            {% endif %}
            <button type="button" onclick="history.back()" class="rounded-lg border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-base font-medium p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                Discard
            </button>
            <button type="submit" form="flow-group-form" class="rounded-lg bg-primary text-white text-base font-medium p-3 hover:bg-primary/90 transition-colors shadow-lg">
                <span class="material-symbols-outlined text-lg mr-2">save</span>
                Save Changes
            </button>
        </div>
    </div>

    <form id="flow-group-form" method="POST" 
          action="{% if flow_group.id %}{% url 'edit_flow_group' flow_group.id %}{% else %}{% url 'add_flow_group' %}{% endif %}" 
          data-flow-group-id="{{ flow_group.id|default:'NEW' }}">
        {% csrf_token %}
        {% if selected_period %}
        <input type="hidden" name="period" value="{{ selected_period }}">
        {% endif %}
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-[#0d171b] dark:text-white">{{ flow_group.name|default:"Create New Flow Group" }}</h1>
                
                {% if flow_group.is_kids_group and not is_new %}
                <div class="flex items-center gap-3 p-3 border-2 border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">Budget Given:</span>
                    <button type="button" 
                            onclick="toggleKidsGroupRealized({{ flow_group.realized|yesno:'true,false' }})"
                            {% if current_member.role == 'CHILD' %}disabled{% endif %}
                            class="kids-group-realized-toggle relative inline-block w-12 h-7 transition duration-200 ease-in-out rounded-full {% if current_member.role == 'CHILD' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %} {% if flow_group.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}"
                            title="{% if current_member.role == 'CHILD' %}Only Parents/Admins can change this{% else %}Click to toggle if budget was given to child{% endif %}">
                        <span class="absolute left-0 inline-block w-5 h-5 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if flow_group.realized %}translate-x-5{% endif %}"></span>
                    </button>
                    <span class="text-xs text-slate-600 dark:text-slate-400">
                        {% if flow_group.realized %}
                            ✓ Marked as given
                        {% else %}
                            Not given yet
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.name.id_for_label }}">Group Name</label>
                    {{ form.name }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.budgeted_amount.id_for_label }}">
                        Budgeted Amount ($)
                        {% if current_member.role == 'CHILD' %}
                        <span class="text-xs text-gray-500">(Read-only for children)</span>
                        {% endif %}
                    </label>
                    {{ form.budgeted_amount }}
                </div>
                
                <input type="hidden" name="group_type" value="EXPENSE_MAIN">

                {% if current_member.role != 'CHILD' %}
                <div class="flex items-center gap-4 flex-wrap">
                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                        <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" 
                               id="id_is_shared" 
                               name="is_shared" 
                               type="checkbox" 
                               onchange="handleSharedChange()"
                               {% if flow_group.is_shared or flow_group.is_kids_group %}checked{% endif %}>
                        <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Shared Group</span>
                    </label>
                    
                    <div id="members-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_shared and not flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                        {% for member in form.assigned_members.field.queryset %}
                        <label class="flex items-center p-2 border border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20 cursor-pointer hover:bg-green-100">
                            <input type="checkbox" 
                                   name="assigned_members" 
                                   value="{{ member.id }}" 
                                   class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                   {% if member in flow_group.assigned_members.all %}checked{% endif %}>
                            <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ member.user.username }}</span>
                        </label>
                        {% empty %}
                        <span class="text-sm text-gray-500 p-2">No Parents/Admins</span>
                        {% endfor %}
                    </div>
                    
                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                        <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" 
                               id="id_is_kids_group" 
                               name="is_kids_group" 
                               type="checkbox"
                               onchange="handleKidsChange()"
                               {% if flow_group.is_kids_group %}checked{% endif %}>
                        <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Kids</span>
                    </label>
                    
                    <div id="children-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                        {% for child in form.assigned_children.field.queryset %}
                        <label class="flex items-center p-2 border border-primary/50 dark:border-primary/30 rounded-lg bg-primary/10 dark:bg-primary/20 cursor-pointer hover:bg-primary/20">
                            <input type="checkbox" 
                                   name="assigned_children" 
                                   value="{{ child.id }}" 
                                   class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                   {% if child in flow_group.assigned_children.all %}checked{% endif %}>
                            <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ child.user.username }}</span>
                        </label>
                        {% empty %}
                        <span class="text-sm text-gray-500 p-2">No children in family</span>
                        {% endfor %}
                    </div>
                    
                    <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                        <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" 
                               id="id_is_investment" 
                               name="is_investment" 
                               type="checkbox"
                               {% if flow_group.is_investment %}checked{% endif %}>
                        <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">Investment</span>
                    </label>
                </div>
                {% endif %}                
            </div>
            
            {% if form.errors %}
                <div class="mt-4 p-3 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300">
                    <p class="font-bold">Please correct the errors below:</p>
                    {{ form.non_field_errors }}
                    <ul class="list-disc list-inside">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        </div>
    </form>

    {% if flow_group %}
    {% if budget_warning %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-500 p-4 mb-6 rounded">
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="material-symbols-outlined text-yellow-400">warning</span>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    <strong>Budget Warning:</strong> Estimated expenses ($ {{ total_estimated|intcomma }}) exceed the budgeted amount ($ {{ flow_group.budgeted_amount|intcomma }}).
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
        
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead>
                <tr>
                    <th class="px-6 py-3 text-center w-8 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Move</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Member</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Realized</th>
                    <th class="px-6 py-3 text-center w-24 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="expense-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for transaction in transactions %}
                <tr id="item-{{ transaction.id }}" 
                    data-item-id="{{ transaction.id }}" 
                    data-mode="display" 
                    data-realized="{{ transaction.realized|yesno:'true,false' }}"
                    data-amount="{{ transaction.amount.amount|default:transaction.amount|default:'0.00' }}"
                    class="hover:bg-slate-50 dark:hover:bg-gray-700/50">
                    
                    <td class="px-6 py-4 text-center whitespace-nowrap">
                        <button type="button" onclick="moveRow('item-{{ transaction.id }}', 'up')" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">arrow_upward</span></button>
                        <button type="button" onclick="moveRow('item-{{ transaction.id }}', 'down')" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">arrow_downward</span></button>
                    </td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display">{{ transaction.description }}</td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit hidden">
                        <input type="text" value="{{ transaction.description }}" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1">
                    </td>
                    
                    <td class="px-6 py-4 text-right text-primary cell-budget-display">{{ transaction.amount|intcomma }}</td>
                    <td class="px-6 py-4 text-right text-primary cell-budget-edit hidden">
                         <input type="number" step="0.01" value="{{ transaction.amount.amount|default:transaction.amount|default:'0.00' }}" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1">
                    </td>
                    
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-display">{{ transaction.date|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit hidden">
                        <input type="date" value="{{ transaction.date|date:'Y-m-d' }}" data-field="date" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1">
                    </td>
                    
                    <td class="px-6 py-4 text-sm text-gray-500 cell-member-display" data-member-id="{{ transaction.member.id }}">{{ transaction.member.user.username }}</td>
                    <td class="px-6 py-2 cell-member-edit hidden">
                        <select data-field="member_id" class="w-full border-b border-primary bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                            {% for member in family_members %}
                                {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                    <option value="{{ member.id }}" {% if member.id == transaction.member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center">
                            <button type="button" onclick="toggleRealized('item-{{ transaction.id }}', {{ transaction.realized|yesno:'true,false' }})" class="realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                <span class="absolute left-0 inline-block w-4 h-4 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-4{% endif %}"></span>
                            </button>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center whitespace-nowrap">
                        <div class="actions-display">
                            <button type="button" onclick="toggleEditMode('item-{{ transaction.id }}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                            <button type="button" onclick="deleteItem('item-{{ transaction.id }}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                        </div>
                        <div class="actions-edit hidden space-x-2">
                             <button type="button" onclick="saveItem('item-{{ transaction.id }}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                             <button type="button" onclick="toggleEditMode('item-{{ transaction.id }}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        No transactions found for this Flow Group.
                    </td>
                </tr>
                {% endfor %}
                
                <tr id="new-item-template" data-item-id="NEW" data-mode="edit" class="hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                    <td class="px-6 py-4 text-center whitespace-nowrap actions-display"></td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display hidden"></td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit">
                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1" placeholder="New Item Description">
                    </td>
                    <td class="px-6 py-4 text-right text-primary cell-budget-display hidden"></td>
                    <td class="px-6 py-4 text-right text-primary cell-budget-edit">
                         <input type="number" step="0.01" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1" value="0.00">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-display hidden"></td>
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit">
                        <input type="date" data-field="date" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1" value="{{ today_date }}">
                    </td>
                    
                    <td class="px-6 py-4 text-sm text-gray-500 cell-member-display hidden"></td>
                    <td class="px-6 py-2 cell-member-edit">
                        <select data-field="member_id" class="w-full border-b border-primary bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                            {% for member in family_members %}
                                {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                    <option value="{{ member.id }}" {% if member.id == current_member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center">
                            <div class="realized-toggle-new relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600">
                                <span class="absolute left-0 inline-block w-4 h-4 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                            </div>
                        </div>
                    </td>
                    
                    <td class="px-6 py-4 text-center whitespace-nowrap">
                        <div class="actions-display hidden"></div>
                        <div class="actions-edit space-x-2">
                             <button type="button" onclick="saveItem('new-item-template')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                             <button type="button" onclick="cancelNewRow('new-item-template')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
            <button type="button" onclick="addNewRow()" class="flex items-center text-primary hover:text-primary/80 text-sm font-medium">
                <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                Add New Item
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Utility for getting CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Member role (for conditional logic)
    const memberRoleForPeriod = "{{ member_role_for_period }}";
    
    // Obter o símbolo da moeda do backend (fallback para '$')
    const currencySymbol = "{{ currency_symbol|default:'$' }}";

    // Function to toggle Kids Group realized status (Parents/Admins only)
    function toggleKidsGroupRealized(currentStatus) {
        const flowGroupId = document.getElementById('flow-group-form').getAttribute('data-flow-group-id');
        
        if (flowGroupId === 'NEW') {
            alert('Please save the Flow Group first before marking it as realized.');
            return;
        }
        
        const newStatus = !currentStatus;
        
        fetch("{% url 'toggle_kids_group_realized_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                'flow_group_id': flowGroupId,
                'realized': newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = document.querySelector('.kids-group-realized-toggle');
                const toggleCircle = toggleBtn.querySelector('span');
                const statusText = toggleBtn.parentElement.querySelector('.text-xs');
                
                if (data.realized) {
                    toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    toggleBtn.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-5');
                    statusText.textContent = '✓ Marked as given';
                    toggleBtn.setAttribute('onclick', `toggleKidsGroupRealized(true)`);
                } else {
                    toggleBtn.classList.remove('bg-green-500');
                    toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-5');
                    statusText.textContent = 'Not given yet';
                    toggleBtn.setAttribute('onclick', `toggleKidsGroupRealized(false)`);
                }
                
                // Show success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                messageDiv.textContent = data.realized ? 'Budget marked as given to child' : 'Budget marked as not given';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            } else {
                alert('Error updating status: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred.');
        });
    }

    // Handle Kids checkbox change
    function handleKidsChange() {
        const kidsCheckbox = document.getElementById('id_is_kids_group');
        const sharedCheckbox = document.getElementById('id_is_shared');
        const childrenContainer = document.getElementById('children-selection-container');
        const membersContainer = document.getElementById('members-selection-container');
        
        if (kidsCheckbox.checked) {
            // Auto-check Shared when Kids is checked
            sharedCheckbox.checked = true;
            sharedCheckbox.disabled = true;
            // Show children selection, hide members selection
            childrenContainer.style.display = 'flex';
            membersContainer.style.display = 'none';
        } else {
            // Enable Shared checkbox when Kids is unchecked
            sharedCheckbox.disabled = false;
            // Hide children selection
            childrenContainer.style.display = 'none';
            // Show members selection if Shared is
            if (sharedCheckbox.checked) {
                membersContainer.style.display = 'flex';
            }
        }
    }
    
    // Handle Shared checkbox change
    function handleSharedChange() {
        const sharedCheckbox = document.getElementById('id_is_shared');
        const kidsCheckbox = document.getElementById('id_is_kids_group');
        const membersContainer = document.getElementById('members-selection-container');
        
        // Only show members selection if Shared is checked AND Kids is NOT checked
        if (sharedCheckbox.checked && !kidsCheckbox.checked) {
            membersContainer.style.display = 'flex';
        } else {
            membersContainer.style.display = 'none';
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial state based on existing values
        handleKidsChange();
    });

    // Function to delete flow group
    function deleteFlowGroup() {
        if (!confirm('WARNING: All transactions in this group for the current period will be permanently deleted. This action cannot be undone.\\n\\nAre you sure you want to delete this Flow Group?')) {
            return;
        }
        
        const flowGroupId = document.getElementById('flow-group-form').getAttribute('data-flow-group-id');
        
        fetch("{% url 'delete_flow_group' flow_group.id|default:0 %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                messageDiv.textContent = 'Flow Group deleted successfully';
                document.body.appendChild(messageDiv);
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = "{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}";
                }, 3000);
            } else {
                alert('Error deleting Flow Group: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred.');
        });
    }

    // Function to toggle realized status directly (without entering edit mode)
    function toggleRealized(rowId, currentStatus) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') return;
        
        const newStatus = !currentStatus;
        
        // Get other field values from display mode
        const description = row.querySelector('.cell-description-display').textContent;
        // CORREÇÃO: Ler o 'amount' do atributo 'data-amount' para obter o valor numérico puro
        const amountText = row.getAttribute('data-amount');
        const dateText = row.querySelector('.cell-date-display').textContent;
        const memberId = row.querySelector('.cell-member-display').getAttribute('data-member-id');
        
        const data = {
            'flow_group_id': document.getElementById('flow-group-form').getAttribute('data-flow-group-id'),
            'transaction_id': transactionId,
            'description': description,
            'amount': amountText, // Agora envia o valor numérico puro
            'date': dateText,
            'member_id': memberId,
            'realized': newStatus,
        };

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = row.querySelector('.realized-toggle');
                const toggleCircle = toggleBtn.querySelector('span');
                
                // CORREÇÃO: Atualizar os atributos 'data-realized' e 'data-amount'
                row.setAttribute('data-realized', data.realized ? 'true' : 'false');
                row.setAttribute('data-amount', data.amount); // Manter o data-amount em sincronia
                
                if (data.realized) {
                    toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    toggleBtn.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-4');
                    toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', true)`);
                } else {
                    toggleBtn.classList.remove('bg-green-500');
                    toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-4');
                    toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', false)`);
                }
            } else {
                alert('Error updating realized status: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred.');
        });
    }

    // Function to add a new row using the template
    function addNewRow() {
        const templateRow = document.getElementById('new-item-template');
        if (templateRow && templateRow.classList.contains('hidden')) {
             templateRow.classList.remove('hidden');
             templateRow.querySelector('input[data-field="description"]').focus();
        } else if (templateRow) {
             templateRow.querySelector('input[data-field="description"]').focus();
        }
    }
    
    // Function to handle saving/updating an item (New or Existing)
    function saveItem(rowId) {
        const row = document.getElementById(rowId);
        const isNew = row.getAttribute('data-item-id') === 'NEW';
        
        // CORREÇÃO: Ler o 'realized' do atributo 'data-realized' para itens existentes
        let realizedValue = false;
        if (isNew) {
            // Para novos itens, ler o estado do toggle (baseado em classe)
            const toggleNew = row.querySelector('.realized-toggle-new');
            realizedValue = toggleNew.classList.contains('bg-green-500');
        } else {
            // Para itens existentes, ler o atributo 'data-realized'
            realizedValue = row.getAttribute('data-realized') === 'true';
        }
        
        const data = {
            'flow_group_id': document.getElementById('flow-group-form').getAttribute('data-flow-group-id'),
            'transaction_id': isNew ? null : row.getAttribute('data-item-id'),
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': row.querySelector('input[data-field="amount"]').value, // Lê do input (que agora tem o valor correto)
            'date': row.querySelector('input[data-field="date"]').value,
            'member_id': row.querySelector('select[data-field="member_id"]').value,
            'realized': realizedValue,
            'is_child_expense': memberRoleForPeriod === 'CHILD',  // Flag for child expense
        };
        
        if (!data.description || !data.amount || !data.date) {
            alert("Description, Amount, and Date are required.");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (isNew) {
                    window.location.reload(); 
                } else {
                    updateRowDisplay(rowId, data);
                    toggleEditMode(rowId, false);
                }
            } else {
                alert('Error saving item: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred.');
        });
    }
    
    // Function to update the row's display values after a successful save
    function updateRowDisplay(rowId, data) {
        const row = document.getElementById(rowId);
        
        // CORREÇÃO: Atualizar também os atributos 'data-*'
        row.setAttribute('data-item-id', data.transaction_id); 
        row.setAttribute('data-realized', data.realized ? 'true' : 'false');
        row.setAttribute('data-amount', data.amount);

        // Update display cells
        row.querySelector('.cell-description-display').textContent = data.description;
        // Usar o currencySymbol global e formatar
        row.querySelector('.cell-budget-display').textContent = `${currencySymbol} ${parseFloat(data.amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        row.querySelector('.cell-date-display').textContent = data.date;
        row.querySelector('.cell-member-display').textContent = data.member_name;
        row.querySelector('.cell-member-display').setAttribute('data-member-id', data.member_id);
        
        // Update realized toggle
        const toggleBtn = row.querySelector('.realized-toggle');
        const toggleCircle = toggleBtn.querySelector('span');
        
        if (data.realized) {
            toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
            toggleBtn.classList.add('bg-green-500');
            toggleCircle.classList.add('translate-x-4');
            toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', true)`);
        } else {
            toggleBtn.classList.remove('bg-green-500');
            toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
            toggleCircle.classList.remove('translate-x-4');
            toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', false)`);
        }
        
        // Update edit inputs
        row.querySelector('input[data-field="description"]').value = data.description;
        row.querySelector('input[data-field="amount"]').value = data.amount;
        row.querySelector('input[data-field="date"]').value = data.date;
        row.querySelector('select[data-field="member_id"]').value = data.member_id;
    }
    
    // Function to delete an item
    function deleteItem(rowId) {
        if (!confirm('Are you sure you want to delete this item?')) return;
        
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') {
            cancelNewRow(rowId);
            return;
        }

        fetch("{% url 'delete_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({'transaction_id': transactionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                row.remove();
            } else {
                alert('Error deleting item: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred.');
        });
    }

    // Function to toggle between display and edit mode
    function toggleEditMode(rowId, startEdit) {
        const row = document.getElementById(rowId);
        if (!row) return;

        const displayElements = row.querySelectorAll('.actions-display, .cell-description-display, .cell-budget-display, .cell-date-display, .cell-member-display');
        const editElements = row.querySelectorAll('.actions-edit, .cell-description-edit, .cell-budget-edit, .cell-date-edit, .cell-member-edit');
        
        displayElements.forEach(el => el.classList.toggle('hidden', startEdit));
        editElements.forEach(el => el.classList.toggle('hidden', !startEdit));
        
        row.setAttribute('data-mode', startEdit ? 'edit' : 'display');
        if(startEdit) {
             row.querySelector('.cell-description-edit input').focus();
        }
    }
    
    // Function to remove the new row template
    function cancelNewRow(rowId) {
        const row = document.getElementById(rowId);
        row.classList.add('hidden');
        row.querySelector('input[data-field="description"]').value = '';
        row.querySelector('input[data-field="amount"]').value = '0.00';
        
        // Reset toggle for new item
        const toggleNew = row.querySelector('.realized-toggle-new');
        const toggleCircle = toggleNew.querySelector('span');
        toggleNew.classList.remove('bg-green-500');
        toggleNew.classList.add('bg-gray-300', 'dark:bg-gray-600');
        toggleCircle.classList.remove('translate-x-4');
    }

    // Function to save the order of items
    function saveItemsOrder() {
        const tbody = document.getElementById('expense-items-body');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr[data-item-id]:not(#new-item-template)');
        
        const orderData = [];
        rows.forEach((row, index) => {
            const itemId = row.getAttribute('data-item-id');
            if (itemId && itemId !== 'NEW') {
                orderData.push({
                    id: itemId,
                    order: index + 1
                });
            }
        });
        
        if (orderData.length === 0) return;
        
        fetch("{% url 'reorder_flow_items_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ items: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Order saved successfully');
            } else {
                console.error('Error saving order:', data.error);
                alert('Error saving order: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('A network error occurred while saving order.');
        });
    }




    function moveRow(rowId, direction) {
        console.log(`Moving ${rowId} ${direction}`);
        const row = document.getElementById(rowId);
        if (!row) return;

        const tbody = row.parentNode;
        let moved = false;

        if (direction === 'up' && row.previousElementSibling) {
            const prevRow = row.previousElementSibling;
            if (prevRow.id !== 'new-item-template') {
                tbody.insertBefore(row, prevRow);
                moved = true;
            }
        } else if (direction === 'down' && row.nextElementSibling) {
            const nextRow = row.nextElementSibling;
            if (nextRow.id !== 'new-item-template' || nextRow.classList.contains('hidden')) {
                tbody.insertBefore(nextRow, row);
                moved = true;
            }
        }

        // If row was moved, save the new order
        if (moved) {
            saveItemsOrder();
        }
    }
        
    // Add click handler for new item toggle
    document.addEventListener('DOMContentLoaded', function() {
        const toggleNew = document.querySelector('.realized-toggle-new');
        if (toggleNew) {
            toggleNew.addEventListener('click', function() {
                const toggleCircle = this.querySelector('span');
                if (this.classList.contains('bg-green-500')) {
                    this.classList.remove('bg-green-500');
                    this.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-4');
                } else {
                    this.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    this.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-4');
                }
            });
        }
    });

</script>
{% endblock content %}