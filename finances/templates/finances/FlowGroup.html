{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load l10n %} 

{% block title %}{% trans "Flow Group" %}: {{ flow_group.name|default:"New Group" }}{% endblock title %}

{% block content %}
<div class="p-6 md:p-10 lg:p-12">
    
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center text-primary hover:text-primary/80 transition-colors">
            <span class="material-symbols-outlined mr-2">arrow_back</span>
            {% trans "Back to Dashboard" %}
        </a>

        <div class="flex space-x-4">
            {% if not is_new and can_edit_group %}
            <button type="button" onclick="deleteFlowGroup()" class="rounded-lg border border-red-500 text-red-500 text-base font-medium p-3 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                <span class="material-symbols-outlined text-lg mr-2">delete</span>
                {% trans "Delete Group" %}
            </button>
            {% endif %}
            <button type="button" onclick="history.back()" class="rounded-lg border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-base font-medium p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                {% trans "Discard" %}
            </button>
            <button type="submit" form="flow-group-form" class="rounded-lg bg-primary text-white text-base font-medium p-3 hover:bg-primary/90 transition-colors shadow-lg">
                <span class="material-symbols-outlined text-lg mr-2">save</span>
                {% trans "Save Changes" %}
            </button>
        </div>
    </div>

    <form id="flow-group-form" method="POST" 
          action="{% if flow_group.id %}{% url 'edit_flow_group' flow_group.id %}{% else %}{% url 'add_flow_group' %}{% endif %}" 
          data-flow-group-id="{{ flow_group.id|default:'NEW' }}">
        {% csrf_token %}
        {% if selected_period %}
        <input type="hidden" name="period" value="{{ selected_period }}">
        {% endif %}
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-[#0d171b] dark:text-white">{{ flow_group.name|default:"Create New Flow Group" }}</h1>
                
                {% if flow_group.is_kids_group and not is_new %}
                <div class="flex items-center gap-3 p-3 border-2 border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20">
                    <span class="text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Budget Given:" %}</span>
                    <button type="button" 
                            onclick="toggleKidsGroupRealized({{ flow_group.realized|yesno:'true,false' }})"
                            {% if current_member.role == 'CHILD' %}disabled{% endif %}
                            class="kids-group-realized-toggle relative inline-block w-12 h-7 transition duration-200 ease-in-out rounded-full {% if current_member.role == 'CHILD' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %} {% if flow_group.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}"
                            title="{% if current_member.role == 'CHILD' %}Only Parents/Admins can change this{% else %}Click to toggle if budget was given to child{% endif %}">
                        <span class="absolute left-1 top-1 inline-block w-5 h-5 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if flow_group.realized %}translate-x-5{% endif %}"></span>
                    </button>
                    <span class="text-xs text-slate-600 dark:text-slate-400">
                        {% if flow_group.realized %}
                            ✓ Marked as given
                        {% else %}
                            Not given yet
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div class="flex flex-col gap-6">

                <!-- Group Name - compact width -->
                <div class="flex flex-col">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.name.id_for_label }}">{% trans "Group Name" %}</label>
                    <div class="w-64">
                        {{ form.name }}
                    </div>
                </div>

                <!-- Budgeted Amount and Checkboxes in same row -->
                <div class="flex flex-wrap items-end gap-6">
                    <!-- Budgeted Amount - compact width -->
                    <div class="flex flex-col">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.budgeted_amount.id_for_label }}">
                            {% trans "Budgeted Amount" %} ($)
                            {% if current_member.role == 'CHILD' %}
                            <span class="text-xs text-gray-500">({% trans "Read-only for children" %})</span>
                            {% endif %}
                        </label>
                        <div class="w-64">
                            {{ form.budgeted_amount }}
                        </div>
                    </div>

                    <input type="hidden" name="group_type" value="EXPENSE_MAIN">

                    {% if current_member.role != 'CHILD' %}
                    <!-- Checkboxes aligned with bottom of Budgeted Amount input -->
                    <div class="flex items-center gap-3 flex-wrap">
                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                                <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                       id="id_is_shared"
                                       name="is_shared"
                                       type="checkbox"
                                       onchange="handleSharedChange()"
                                       {% if flow_group.is_shared or flow_group.is_kids_group %}checked{% endif %}>
                                <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Shared Group" %}</span>
                            </label>

                            <div id="members-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_shared and not flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                                {% for member in form.assigned_members.field.queryset %}
                                <label class="flex items-center p-2 border border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/30">
                                    <input type="checkbox"
                                           name="assigned_members"
                                           value="{{ member.id }}"
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           {% if member in flow_group.assigned_members.all %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ member.user.username }}</span>
                                </label>
                                {% empty %}
                                <span class="text-sm text-gray-500 dark:text-gray-400 p-2">{% trans "No Parents/Admins" %}</span>
                                {% endfor %}
                            </div>

                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                                <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                       id="id_is_kids_group"
                                       name="is_kids_group"
                                       type="checkbox"
                                       onchange="handleKidsChange()"
                                       {% if flow_group.is_kids_group %}checked{% endif %}>
                                <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Kids" %}</span>
                            </label>

                            <div id="children-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                                {% for child in form.assigned_children.field.queryset %}
                                <label class="flex items-center p-2 border border-primary/50 dark:border-primary/30 rounded-lg bg-primary/10 dark:bg-primary/20 cursor-pointer hover:bg-primary/20 dark:hover:bg-primary/30">
                                    <input type="checkbox"
                                           name="assigned_children"
                                           value="{{ child.id }}"
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           {% if child in flow_group.assigned_children.all %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ child.user.username }}</span>
                                </label>
                                {% empty %}
                                <span class="text-sm text-gray-500 dark:text-gray-400 p-2">{% trans "No children in family" %}</span>
                                {% endfor %}
                            </div>

                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                            <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                   id="id_is_investment"
                                   name="is_investment"
                                   type="checkbox"
                                   {% if flow_group.is_investment %}checked{% endif %}>
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Investment" %}</span>
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if form.errors %}
                <div class="mt-4 p-3 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300">
                    <p class="font-bold">{% trans "Please correct the errors below:" %}</p>
                    {{ form.non_field_errors }}
                    <ul class="list-disc list-inside">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

        </div>
    </form>

    {% if flow_group %}
    <div id="budget-warning-container" class="{% if not budget_warning %}hidden{% endif %} bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-500 p-4 mb-6 rounded">
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="material-symbols-outlined text-yellow-400">warning</span>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                    <strong>{% trans "Budget Warning:" %}</strong> <span id="budget-warning-text">{% blocktrans with estimated=total_estimated|floatformat:2|intcomma budgeted=flow_group.budgeted_amount|floatformat:2|intcomma %}Estimated expenses ($ {{ estimated }}) exceed the budgeted amount ($ {{ budgeted }}).{% endblocktrans %}</span>
                </p>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">

        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead>
                <tr>
                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Description" %}</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider date-header-mobile">{% trans "Date" %}</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Member" %}</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Realized" %}</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Amount" %}</th>
                    <th class="px-6 py-3 text-center w-24 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody id="expense-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for transaction in transactions %}
                <tr id="item-{{ transaction.id }}"
                    data-item-id="{{ transaction.id }}"
                    data-mode="display"
                    data-realized="{{ transaction.realized|yesno:'true,false' }}"
                    data-amount="{{ transaction.amount.amount|default:transaction.amount|default:'0.00' }}"
                    data-order="{{ forloop.counter }}"
                    draggable="true"
                    class="draggable-row swipeable-row {% if transaction.realized %}row-realized{% else %}row-not-realized{% endif %} hover:bg-slate-50 dark:hover:bg-gray-700/50">

                    <td class="px-2 py-4 text-center drag-handle-cell" data-row-id="item-{{ transaction.id }}">
                        <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                        <button type="button" onclick="saveItem('item-{{ transaction.id }}')" class="edit-save-icon" style="display: none;">
                            <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                        </button>
                    </td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display">{{ transaction.description }}</td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit hidden">
                        <input type="text" value="{{ transaction.description }}" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1">
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-display">
                        <span class="date-full">{{ transaction.date|date:"Y-m-d" }}</span>
                        <span class="date-short">{{ transaction.date|date:"d/m" }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit hidden">
                        <input type="date" value="{{ transaction.date|date:'Y-m-d' }}" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-sm p-1 date-input-field">
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-500 cell-member-display" data-member-id="{{ transaction.member.id }}">
                        {{ transaction.member.user.username }}
                    </td>
                    <td class="px-6 py-2 cell-member-edit hidden">
                        <select data-field="member_id" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                            {% for member in family_members %}
                                {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                    <option value="{{ member.id }}" {% if member.id == transaction.member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>

                    <td class="px-6 py-4 text-center mobile-hide-column">
                        <div class="flex items-center justify-center">
                            <button type="button" onclick="toggleRealized('item-{{ transaction.id }}', {{ transaction.realized|yesno:'true,false' }})" class="realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-4{% endif %}"></span>
                            </button>
                        </div>
                    </td>

                    <td class="px-6 py-4 text-right text-primary cell-budget-display amount-cell-with-actions">
                        {{ transaction.amount|intcomma }}
                        <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                        <div class="mobile-actions-btns">
                            <button type="button" onclick="toggleEditMode('item-{{ transaction.id }}', true)" class="mobile-action-btn edit-btn">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button type="button" onclick="deleteItem('item-{{ transaction.id }}')" class="mobile-action-btn delete-btn">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right text-primary cell-budget-edit hidden">
                         <input type="text" inputmode="decimal" value="{{ transaction.amount.amount|default:transaction.amount|default:'0.00'|floatformat:2 }}" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1">
                    </td>

                    <td class="px-6 py-4 text-center whitespace-nowrap mobile-hide-column">
                        <div class="actions-display">
                            <button type="button" onclick="toggleEditMode('item-{{ transaction.id }}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                            <button type="button" onclick="deleteItem('item-{{ transaction.id }}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                        </div>
                        <div class="actions-edit hidden space-x-2">
                             <button type="button" onclick="saveItem('item-{{ transaction.id }}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                             <button type="button" onclick="toggleEditMode('item-{{ transaction.id }}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                        {% trans "No transactions found for this Flow Group." %}
                    </td>
                </tr>
                {% endfor %}
                
                <tr id="new-item-template" data-item-id="NEW" data-mode="edit" class="swipeable-row hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                    <td class="px-2 py-4 text-center drag-handle-cell">
                        <button type="button" onclick="saveItem('new-item-template')" class="edit-save-icon">
                            <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                        </button>
                    </td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display hidden"></td>
                    <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit">
                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1" placeholder="{% trans "New Item Description" %}">
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-display hidden"></td>
                    <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit">
                        <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-sm p-1 date-input-field" value="{{ today_date }}">
                    </td>

                    <td class="px-6 py-4 text-sm text-gray-500 cell-member-display hidden"></td>
                    <td class="px-6 py-2 cell-member-edit">
                        <select data-field="member_id" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                            {% for member in family_members %}
                                {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                    <option value="{{ member.id }}" {% if member.id == current_member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </td>

                    <td class="px-6 py-4 text-center mobile-hide-column">
                        <div class="flex items-center justify-center">
                            <div class="realized-toggle-new relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600">
                                <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                            </div>
                        </div>
                    </td>

                    <td class="px-6 py-4 text-right text-primary cell-budget-display hidden"></td>
                    <td class="px-6 py-4 text-right text-primary cell-budget-edit">
                         <input type="number" step="0.01" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1" value="0.00">
                    </td>

                    <td class="px-6 py-4 text-center whitespace-nowrap mobile-hide-column">
                        <div class="actions-display hidden"></div>
                        <div class="actions-edit space-x-2">
                             <button type="button" onclick="saveItem('new-item-template')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                             <button type="button" onclick="cancelNewRow('new-item-template')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
            <button type="button" onclick="addNewRow()" class="flex items-center text-primary hover:text-primary/80 text-sm font-medium">
                <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                {% trans "Add New Item" %}
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Utility for getting CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Locale-specific separators from backend
    const decimalSeparator = "{{ decimal_separator }}";
    const thousandSeparator = "{{ thousand_separator }}";

    // Translated strings for budget warning
    const txtEstimatedExpenses = "{% trans 'Estimated expenses' %}";
    const txtExceedBudget = "{% trans 'exceed the budgeted amount' %}";

    // Member role (for conditional logic)
    const memberRoleForPeriod = "{{ member_role_for_period }}";

    // Obter o símbolo da moeda do backend (fallback para '$')
    const currencySymbol = "{{ currency_symbol|default:'$' }}";

    // Function to toggle Kids Group realized status (Parents/Admins only)
    function toggleKidsGroupRealized(currentStatus) {
        const flowGroupId = document.getElementById('flow-group-form').getAttribute('data-flow-group-id');
        
        if (flowGroupId === 'NEW') {
            alert('{% trans "Please save the Flow Group first before marking it as realized." %}');
            return;
        }
        
        const newStatus = !currentStatus;
        
        fetch("{% url 'toggle_kids_group_realized_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                'flow_group_id': flowGroupId,
                'realized': newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = document.querySelector('.kids-group-realized-toggle');
                const toggleCircle = toggleBtn.querySelector('span');
                const statusText = toggleBtn.parentElement.querySelector('.text-xs');
                
                if (data.realized) {
                    toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    toggleBtn.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-5');
                    statusText.textContent = '{% trans "✓ Marked as given" %}';
                    toggleBtn.setAttribute('onclick', `toggleKidsGroupRealized(true)`);
                } else {
                    toggleBtn.classList.remove('bg-green-500');
                    toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-5');
                    statusText.textContent = '{% trans "Not given yet" %}';
                    toggleBtn.setAttribute('onclick', `toggleKidsGroupRealized(false)`);
                }
                
                // Show success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                messageDiv.textContent = data.realized ? '{% trans "Budget marked as given to child" %}' : '{% trans "Budget marked as not given" %}';
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    messageDiv.remove();
                }, 3000);
            } else {
                alert('{% trans "Error updating status:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Handle Kids checkbox change
    function handleKidsChange() {
        const kidsCheckbox = document.getElementById('id_is_kids_group');
        const sharedCheckbox = document.getElementById('id_is_shared');
        const childrenContainer = document.getElementById('children-selection-container');
        const membersContainer = document.getElementById('members-selection-container');
        
        if (kidsCheckbox.checked) {
            // Auto-check Shared when Kids is checked
            sharedCheckbox.checked = true;
            sharedCheckbox.disabled = true;
            // Show children selection, hide members selection
            childrenContainer.style.display = 'flex';
            membersContainer.style.display = 'none';
        } else {
            // Enable Shared checkbox when Kids is unchecked
            sharedCheckbox.disabled = false;
            // Hide children selection
            childrenContainer.style.display = 'none';
            // Show members selection if Shared is
            if (sharedCheckbox.checked) {
                membersContainer.style.display = 'flex';
            }
        }
    }
    
    // Handle Shared checkbox change
    function handleSharedChange() {
        const sharedCheckbox = document.getElementById('id_is_shared');
        const kidsCheckbox = document.getElementById('id_is_kids_group');
        const membersContainer = document.getElementById('members-selection-container');
        
        // Only show members selection if Shared is checked AND Kids is NOT checked
        if (sharedCheckbox.checked && !kidsCheckbox.checked) {
            membersContainer.style.display = 'flex';
        } else {
            membersContainer.style.display = 'none';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial state based on existing values
        handleKidsChange();
        // Initialize drag and drop
        initializeDragAndDrop();
        // Initialize toggle for new item
        initializeNewItemToggle();
    });

    // Function to format amount values with user's locale decimal separator
    function formatAmountForInput(amount) {
        // Convert to number and format with 2 decimals
        const num = parseFloat(amount);
        if (isNaN(num)) return amount;

        // Format to 2 decimal places and replace decimal separator
        // decimalSeparator comes from backend template context
        return num.toFixed(2).replace('.', decimalSeparator);
    }

    // Function to format number as currency for display
    function formatCurrency(amount) {
        // Parse the amount to ensure it's a number
        const num = parseFloat(amount);
        if (isNaN(num)) return amount;

        // Format to 2 decimal places
        const parts = num.toFixed(2).split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1];

        // Add thousand separators to integer part
        const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

        // Combine with decimal separator
        return formattedInteger + decimalSeparator + decimalPart;
    }

    // Function to update budget warning display
    function updateBudgetWarning() {
        const warningContainer = document.getElementById('budget-warning-container');
        const warningText = document.getElementById('budget-warning-text');

        // If elements don't exist, just return (page might not have budget warning section)
        if (!warningContainer || !warningText) return;

        // Get budget amount from the form
        const budgetInput = document.querySelector('input[name="budgeted_amount"]');
        if (!budgetInput) {
            console.log('[updateBudgetWarning] Budget input not found');
            return;
        }

        // Parse budget value, replacing comma with period if needed
        let budgetValue = budgetInput.value.replace(',', '.');
        const budgetedAmount = parseFloat(budgetValue) || 0;

        console.log('[updateBudgetWarning] Budget input value:', budgetInput.value);
        console.log('[updateBudgetWarning] Budget parsed:', budgetedAmount);
        console.log('[updateBudgetWarning] Translated strings:', txtEstimatedExpenses, txtExceedBudget);

        // Calculate total from all transaction rows
        let totalEstimated = 0;
        const rows = document.querySelectorAll('tr[data-item-id]');
        rows.forEach(row => {
            const amount = parseFloat(row.getAttribute('data-amount')) || 0;
            totalEstimated += amount;
        });

        console.log('[updateBudgetWarning] Total estimated:', totalEstimated);

        // Check if over budget
        const isOverBudget = totalEstimated > budgetedAmount;

        if (isOverBudget) {
            // Show warning with formatted values
            const formattedEstimated = formatCurrency(totalEstimated);
            const formattedBudget = formatCurrency(budgetedAmount);

            console.log('[updateBudgetWarning] Formatted values:', formattedEstimated, formattedBudget);

            // Build text using translated strings
            const warningMsg = txtEstimatedExpenses + ' (' + currencySymbol + ' ' + formattedEstimated + ') ' + txtExceedBudget + ' (' + currencySymbol + ' ' + formattedBudget + ').';
            warningText.textContent = warningMsg;
            warningContainer.classList.remove('hidden');
        } else {
            // Hide warning
            warningContainer.classList.add('hidden');
        }
    }

    // Function to delete flow group
    function deleteFlowGroup() {
        if (!confirm('{% trans "WARNING: All transactions in this group for the current period will be permanently deleted. This action cannot be undone." %}\n\n{% trans "Are you sure you want to delete this Flow Group?" %}')) {
            return;
        }
        
        const flowGroupId = document.getElementById('flow-group-form').getAttribute('data-flow-group-id');
        
        fetch("{% url 'delete_flow_group' flow_group.id|default:0 %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                messageDiv.textContent = '{% trans "Flow Group deleted successfully" %}';
                document.body.appendChild(messageDiv);
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = "{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}";
                }, 3000);
            } else {
                alert('{% trans "Error deleting Flow Group:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to toggle realized status directly (without entering edit mode)
    function toggleRealized(rowId, currentStatus) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') return;
        
        const newStatus = !currentStatus;
        
        // Get other field values from display mode
        const description = row.querySelector('.cell-description-display').textContent;
        // CORREÇÃO: Ler o 'amount' do atributo 'data-amount' para obter o valor numérico puro
        const amountText = row.getAttribute('data-amount');
        // Get date from the hidden input (edit mode) which has the correct YYYY-MM-DD format
        const dateText = row.querySelector('.cell-date-edit input[data-field="date"]').value;
        const memberId = row.querySelector('.cell-member-display').getAttribute('data-member-id');
        
        const data = {
            'flow_group_id': document.getElementById('flow-group-form').getAttribute('data-flow-group-id'),
            'transaction_id': transactionId,
            'description': description,
            'amount': amountText, // Agora envia o valor numérico puro
            'date': dateText,
            'member_id': memberId,
            'realized': newStatus,
        };

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = row.querySelector('.realized-toggle');

                // CORREÇÃO: Atualizar os atributos 'data-realized' e 'data-amount'
                row.setAttribute('data-realized', data.realized ? 'true' : 'false');
                row.setAttribute('data-amount', data.amount); // Manter o data-amount em sincronia

                if (data.realized) {
                    // Update desktop toggle button
                    if (toggleBtn) {
                        const toggleCircle = toggleBtn.querySelector('span');
                        toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                        toggleBtn.classList.add('bg-green-500');
                        toggleCircle.classList.add('translate-x-4');
                        toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', true)`);
                    }
                    // Update mobile row visual state
                    row.classList.remove('row-not-realized');
                    row.classList.add('row-realized');
                } else {
                    // Update desktop toggle button
                    if (toggleBtn) {
                        const toggleCircle = toggleBtn.querySelector('span');
                        toggleBtn.classList.remove('bg-green-500');
                        toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                        toggleCircle.classList.remove('translate-x-4');
                        toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', false)`);
                    }
                    // Update mobile row visual state
                    row.classList.remove('row-realized');
                    row.classList.add('row-not-realized');
                }
            } else {
                alert('{% trans "Error updating realized status:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to add a new row using the template
    function addNewRow() {
        const templateRow = document.getElementById('new-item-template');
        if (templateRow && templateRow.classList.contains('hidden')) {
             templateRow.classList.remove('hidden');
             templateRow.querySelector('input[data-field="description"]').focus();
        } else if (templateRow) {
             templateRow.querySelector('input[data-field="description"]').focus();
        }
    }
    
    // Function to handle saving/updating an item (New or Existing)
    function saveItem(rowId) {
        const row = document.getElementById(rowId);
        const isNew = row.getAttribute('data-item-id') === 'NEW';
        
        // CORREÇÃO: Ler o 'realized' do atributo 'data-realized' para itens existentes
        let realizedValue = false;
        if (isNew) {
            // Para novos itens, ler o estado do toggle (baseado em classe)
            const toggleNew = row.querySelector('.realized-toggle-new');
            realizedValue = toggleNew.classList.contains('bg-green-500');
        } else {
            // Para itens existentes, ler o atributo 'data-realized'
            realizedValue = row.getAttribute('data-realized') === 'true';
        }
        
        // Get amount value - send as-is, backend will handle locale parsing
        let amountValue = row.querySelector('input[data-field="amount"]').value;

        const data = {
            'flow_group_id': document.getElementById('flow-group-form').getAttribute('data-flow-group-id'),
            'transaction_id': isNew ? null : row.getAttribute('data-item-id'),
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': amountValue,  // Send raw value, backend handles locale
            'date': row.querySelector('input[data-field="date"]').value,
            'member_id': row.querySelector('select[data-field="member_id"]').value,
            'realized': realizedValue,
            'is_child_expense': memberRoleForPeriod === 'CHILD',  // Flag for child expense
        };

        if (!data.description || !data.amount || !data.date) {
            alert("{% trans 'Description, Amount, and Date are required.' %}");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (isNew) {
                    // Convert new item template to regular item
                    const newRow = row;

                    // Update row ID and attributes
                    newRow.id = 'item-' + data.transaction_id;
                    newRow.setAttribute('data-item-id', data.transaction_id);
                    newRow.setAttribute('data-mode', 'display');
                    newRow.setAttribute('data-realized', data.realized ? 'true' : 'false');
                    newRow.setAttribute('data-amount', data.amount);
                    newRow.setAttribute('data-date', data.date);

                    // Update drag handle to show drag icon instead of check icon
                    const dragHandle = newRow.querySelector('.drag-handle-cell');
                    if (dragHandle) {
                        dragHandle.innerHTML = '<span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>' +
                            '<button type="button" onclick="saveItem(\'item-' + data.transaction_id + '\')" class="edit-save-icon" style="display: none;">' +
                            '<span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span></button>';
                    }

                    // Populate display values
                    updateRowDisplay('item-' + data.transaction_id, data);

                    // Switch to display mode
                    toggleEditMode('item-' + data.transaction_id, false);

                    // Update onclick handlers with new row ID
                    newRow.querySelectorAll('button[onclick*="new-item-template"]').forEach(btn => {
                        const onclick = btn.getAttribute('onclick');
                        if (onclick) {
                            btn.setAttribute('onclick', onclick.replace('new-item-template', 'item-' + data.transaction_id));
                        }
                    });

                    // Create a new empty template row
                    addNewItem();

                    // Update budget warning
                    updateBudgetWarning();
                } else {
                    updateRowDisplay(rowId, data);
                    toggleEditMode(rowId, false);
                    updateBudgetWarning();
                }
            } else {
                alert('{% trans "Error saving item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }
    
    // Function to update the row's display values after a successful save
    function updateRowDisplay(rowId, data) {
        const row = document.getElementById(rowId);
        
        // CORREÇÃO: Atualizar também os atributos 'data-*'
        row.setAttribute('data-item-id', data.transaction_id); 
        row.setAttribute('data-realized', data.realized ? 'true' : 'false');
        row.setAttribute('data-amount', data.amount);

        // Update display cells
        row.querySelector('.cell-description-display').textContent = data.description;
        // Usar o currencySymbol global e formatar
        row.querySelector('.cell-budget-display').textContent = `${currencySymbol} ${formatCurrency(data.amount)}`;

        // Update date: Update both the full and short format spans
        const dateCell = row.querySelector('.cell-date-display');
        const dateObj = new Date(data.date + 'T00:00:00'); // Add time to avoid timezone issues
        const dateFullSpan = dateCell.querySelector('.date-full');
        const dateShortSpan = dateCell.querySelector('.date-short');
        if (dateFullSpan) dateFullSpan.textContent = data.date;
        if (dateShortSpan) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            dateShortSpan.textContent = `${day}/${month}`;
        }

        // Update edit input as well
        const dateEditInput = row.querySelector('.cell-date-edit input[data-field="date"]');
        dateEditInput.value = data.date;

        // Update data-display-value for mobile button-style input
        if (window.matchMedia('(max-width: 768px)').matches) {
            const [year, month, day] = data.date.split('-');
            const displayValue = `${day}/${month}`;
            dateEditInput.setAttribute('data-display-value', displayValue);
        }

        // Update member - preserve mobile action buttons
        const memberCell = row.querySelector('.cell-member-display');
        const mobileActionsDiv = memberCell.querySelector('.mobile-actions-btns');

        // Clear text content while preserving mobile actions
        const textNodes = Array.from(memberCell.childNodes).filter(node => node.nodeType === Node.TEXT_NODE);
        textNodes.forEach(node => node.remove());

        // Add new member name as text node before mobile actions
        if (mobileActionsDiv) {
            memberCell.insertBefore(document.createTextNode(data.member_name), mobileActionsDiv);
        } else {
            memberCell.textContent = data.member_name;
        }
        memberCell.setAttribute('data-member-id', data.member_id);
        
        // Update realized toggle
        const toggleBtn = row.querySelector('.realized-toggle');
        const toggleCircle = toggleBtn.querySelector('span');
        
        if (data.realized) {
            toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
            toggleBtn.classList.add('bg-green-500');
            toggleCircle.classList.add('translate-x-4');
            toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', true)`);
        } else {
            toggleBtn.classList.remove('bg-green-500');
            toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
            toggleCircle.classList.remove('translate-x-4');
            toggleBtn.setAttribute('onclick', `toggleRealized('${rowId}', false)`);
        }
        
        // Update edit inputs
        row.querySelector('input[data-field="description"]').value = data.description;
        row.querySelector('input[data-field="amount"]').value = formatAmountForInput(data.amount);
        row.querySelector('input[data-field="date"]').value = data.date;
        row.querySelector('select[data-field="member_id"]').value = data.member_id;
    }
    
    // Function to delete an item
    function deleteItem(rowId) {
        if (!confirm('{% trans "Are you sure you want to delete this item?" %}')) return;
        
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') {
            cancelNewRow(rowId);
            return;
        }

        fetch("{% url 'delete_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({'transaction_id': transactionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                row.remove();
                updateBudgetWarning();
            } else {
                alert('{% trans "Error deleting item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to toggle between display and edit mode
    function toggleEditMode(rowId, startEdit) {
        const row = document.getElementById(rowId);
        if (!row) return;

        const displayElements = row.querySelectorAll('.actions-display, .cell-description-display, .cell-budget-display, .cell-date-display, .cell-member-display');
        const editElements = row.querySelectorAll('.actions-edit, .cell-description-edit, .cell-budget-edit, .cell-date-edit, .cell-member-edit');

        displayElements.forEach(el => el.classList.toggle('hidden', startEdit));
        editElements.forEach(el => el.classList.toggle('hidden', !startEdit));

        row.setAttribute('data-mode', startEdit ? 'edit' : 'display');

        // Mobile: Reset row position when entering/exiting edit mode
        if (window.matchMedia('(max-width: 768px)').matches) {
            row.style.transform = 'translateX(0)';
            row.classList.remove('actions-revealed');

            // Toggle drag handle visibility based on edit mode
            const dragHandle = row.querySelector('.drag-handle-cell');
            const dragIcon = dragHandle.querySelector('.drag-handle');
            const checkIcon = dragHandle.querySelector('.edit-save-icon');

            if (startEdit) {
                // Show check icon, hide drag icon
                if (dragIcon) dragIcon.style.display = 'none';
                if (checkIcon) checkIcon.style.display = 'inline-block';

                // Update date input display value for mobile button-style input
                const dateInput = row.querySelector('.date-input-field');
                if (dateInput) {
                    const dateValue = dateInput.value; // YYYY-MM-DD format
                    if (dateValue) {
                        const [year, month, day] = dateValue.split('-');
                        const displayValue = `${day}/${month}`;
                        dateInput.setAttribute('data-display-value', displayValue);
                    }
                }
            } else {
                // Show drag icon, hide check icon
                if (dragIcon) dragIcon.style.display = 'inline-block';
                if (checkIcon) checkIcon.style.display = 'none';
            }
        }

        if(startEdit) {
             row.querySelector('.cell-description-edit input').focus();
        }
    }
    
    // Function to remove the new row template
    function cancelNewRow(rowId) {
        const row = document.getElementById(rowId);
        row.classList.add('hidden');
        row.querySelector('input[data-field="description"]').value = '';
        row.querySelector('input[data-field="amount"]').value = '0.00';
        
        // Reset toggle for new item
        const toggleNew = row.querySelector('.realized-toggle-new');
        const toggleCircle = toggleNew.querySelector('span');
        toggleNew.classList.remove('bg-green-500');
        toggleNew.classList.add('bg-gray-300', 'dark:bg-gray-600');
        toggleCircle.classList.remove('translate-x-4');
    }

    // === DRAG AND DROP REORDERING FOR EXPENSE ITEMS ===

    let draggedRow = null;
    let draggedOverRow = null;

    function initializeDragAndDrop() {
        const tbody = document.getElementById('expense-items-body');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.draggable-row');

        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);

            // Prevent drag on non-drag-handle clicks
            row.addEventListener('mousedown', function(e) {
                if (!e.target.closest('.drag-handle-cell') && !e.target.closest('.drag-handle')) {
                    this.setAttribute('draggable', 'false');
                } else {
                    this.setAttribute('draggable', 'true');
                }
            });
        });

        // Enable dragging only from handle
        const dragHandles = tbody.querySelectorAll('.drag-handle');
        dragHandles.forEach(handle => {
            handle.addEventListener('mousedown', function(e) {
                const row = this.closest('tr');
                if (row) {
                    row.setAttribute('draggable', 'true');
                }
            });
        });
    }

    function handleDragStart(e) {
        draggedRow = this;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter(e) {
        if (this !== draggedRow && this.id !== 'new-item-template') {
            this.classList.add('border-t-2', 'border-primary');
            draggedOverRow = this;
        }
    }

    function handleDragLeave(e) {
        this.classList.remove('border-t-2', 'border-primary');
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedRow !== this && this.id !== 'new-item-template') {
            // Get the tbody
            const tbody = document.getElementById('expense-items-body');
            const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));

            const draggedIndex = allRows.indexOf(draggedRow);
            const targetIndex = allRows.indexOf(this);

            // Move the dragged row
            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedRow, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedRow, this);
            }

            // Save new order to backend
            saveItemsOrder();
        }

        return false;
    }

    function handleDragEnd(e) {
        this.style.opacity = '1';

        // Remove all drag-related classes
        const rows = document.querySelectorAll('tr.draggable-row');
        rows.forEach(row => {
            row.classList.remove('border-t-2', 'border-primary');
        });

        draggedRow = null;
        draggedOverRow = null;
    }

    function saveItemsOrder() {
        const tbody = document.getElementById('expense-items-body');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.draggable-row');

        const orderData = [];
        rows.forEach((row, index) => {
            const itemId = row.getAttribute('data-item-id');
            if (itemId && itemId !== 'NEW') {
                orderData.push({
                    id: itemId,
                    order: index + 1
                });
            }
        });

        if (orderData.length === 0) return;

        fetch("{% url 'reorder_flow_items_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ items: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Order saved successfully');
            } else {
                console.error('Error saving order:', data.error);
                alert('{% trans "Error saving order:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred while saving order." %}');
        });
    }

    // Add click handler for new item toggle
    function initializeNewItemToggle() {
        const toggleNew = document.querySelector('.realized-toggle-new');
        if (toggleNew) {
            toggleNew.addEventListener('click', function() {
                const toggleCircle = this.querySelector('span');
                if (this.classList.contains('bg-green-500')) {
                    this.classList.remove('bg-green-500');
                    this.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-4');
                } else {
                    this.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    this.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-4');
                }
            });
        }
    }

    // ========== MOBILE-SPECIFIC FUNCTIONALITY ==========
    // Initialize mobile swipe and tap functionality
    (function initMobileFeatures() {
        'use strict';

        const isMobile = window.matchMedia('(max-width: 768px)').matches;

        if (!isMobile) {
            console.log('[MOBILE] Not mobile viewport, skipping mobile features');
            return; // Only run on mobile devices
        }

        console.log('[MOBILE] Initializing mobile features for FlowGroup items');
        const swipeableRows = document.querySelectorAll('.swipeable-row');
        console.log('[MOBILE] Found', swipeableRows.length, 'swipeable rows');

        swipeableRows.forEach(row => {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let startTime = 0;
            const swipeThreshold = 60; // Minimum pixels to trigger swipe
            const tapTimeThreshold = 200; // Max ms for tap detection

            // Prevent default drag behavior on mobile
            row.setAttribute('draggable', 'false');

            // Touch start
            row.addEventListener('touchstart', (e) => {
                // Ignore if touching action buttons or check icon
                if (e.target.closest('.mobile-action-btn')) return;
                if (e.target.closest('.edit-save-icon')) return;

                startX = e.touches[0].clientX;
                currentX = startX;
                startTime = Date.now();
                isDragging = false;
            }, { passive: true });

            // Touch move
            row.addEventListener('touchmove', (e) => {
                if (e.target.closest('.mobile-action-btn')) return;
                if (e.target.closest('.edit-save-icon')) return;

                currentX = e.touches[0].clientX;
                const deltaX = currentX - startX;

                // In edit mode: allow swipe right to cancel
                if (row.dataset.mode === 'edit') {
                    if (deltaX > 0) {
                        isDragging = true;
                        const translateX = Math.min(deltaX, 120); // Max 120px right
                        row.style.transform = `translateX(${translateX}px)`;
                        row.style.transition = 'none';
                    }
                } else {
                    // In display mode: allow swipe left to reveal actions
                    if (deltaX < 0) {
                        isDragging = true;
                        const translateX = Math.max(deltaX, -120); // Max 120px left
                        row.style.transform = `translateX(${translateX}px)`;
                        row.style.transition = 'none';
                    }
                }
            }, { passive: true });

            // Touch end
            row.addEventListener('touchend', (e) => {
                if (e.target.closest('.mobile-action-btn')) return;
                if (e.target.closest('.edit-save-icon')) return;

                const deltaX = currentX - startX;
                const deltaTime = Date.now() - startTime;

                row.style.transition = 'transform 0.3s ease-out';

                // In edit mode: swipe right to cancel
                if (row.dataset.mode === 'edit') {
                    if (deltaX > swipeThreshold) {
                        console.log('[MOBILE SWIPE] Canceling edit mode for:', row.id);
                        toggleEditMode(row.id, false);
                    } else {
                        // Reset position
                        row.style.transform = 'translateX(0)';
                    }
                } else {
                    // In display mode
                    // Check if it's a tap (quick touch with minimal movement)
                    if (!isDragging && Math.abs(deltaX) < 10 && deltaTime < tapTimeThreshold) {
                        // Tap detected - toggle realized status
                        const rowId = row.id;
                        const currentRealized = row.dataset.realized === 'true';
                        console.log('[MOBILE TAP] Toggling realized:', rowId, 'Current:', currentRealized);
                        toggleRealized(rowId, currentRealized);
                    }
                    // Check if swipe left exceeded threshold
                    else if (deltaX < -swipeThreshold) {
                        // Show actions (swipe left)
                        row.style.transform = 'translateX(-120px)';
                        row.classList.add('actions-revealed');
                    } else {
                        // Reset to original position
                        row.style.transform = 'translateX(0)';
                        row.classList.remove('actions-revealed');
                    }
                }

                isDragging = false;
            }, { passive: true });

            // Close actions when tapping outside
            document.addEventListener('touchstart', (e) => {
                if (!row.contains(e.target) && row.classList.contains('actions-revealed')) {
                    row.style.transform = 'translateX(0)';
                    row.classList.remove('actions-revealed');
                }
            }, { passive: true });
        });

        // Add change event listener to all date inputs to update display value
        const dateInputs = document.querySelectorAll('.date-input-field');
        dateInputs.forEach(input => {
            input.addEventListener('change', function() {
                const dateValue = this.value; // YYYY-MM-DD format
                if (dateValue) {
                    const [year, month, day] = dateValue.split('-');
                    const displayValue = `${day}/${month}`;
                    this.setAttribute('data-display-value', displayValue);
                    console.log('[MOBILE DATE] Updated display value:', displayValue);
                }
            });
        });

        // Re-initialize after adding new items
        const originalAddNewItem = window.addNewItem;
        window.addNewItem = function() {
            if (originalAddNewItem) originalAddNewItem();
            setTimeout(initMobileFeatures, 100);
        };
    })();

    // Note: normalizeDecimalInput function removed - backend now handles all locale parsing

    // Mobile keyboard handling - scroll input into view when keyboard opens
    function initMobileKeyboardHandling() {
        // Só executa em mobile
        if (window.innerWidth > 768) return;

        const inputs = document.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                // Timeout para aguardar teclado aparecer
                setTimeout(() => {
                    if (window.visualViewport) {
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;

                        if (keyboardHeight > 50) { // Teclado está visível
                            this.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center',
                                inline: 'nearest'
                            });
                        }
                    } else {
                        // Fallback para browsers sem visualViewport API
                        this.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                    }
                }, 300); // Aguarda 300ms para teclado aparecer
            });
        });
    }

    // Inicializar quando DOM carregar
    document.addEventListener('DOMContentLoaded', function() {
        initMobileKeyboardHandling();
    });

</script>

<!-- Mobile-specific CSS -->
<style>
    /* Hide Realized and Actions columns on mobile */
    @media (max-width: 768px) {
        .mobile-hide-column {
            display: none !important;
        }

        /* Date column optimizations for mobile */
        .date-header-mobile {
            width: 60px;
        }

        /* Make date input work as a button - tap anywhere opens calendar */
        .date-input-field {
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .date-input-field {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Make entire input clickable - calendar icon spans full width */
        .date-input-field::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        /* Hide the text but keep input functional */
        .date-input-field {
            color: transparent;
            font-size: 0;
        }

        /* Show the actual date value using custom content */
        .date-input-field::before {
            content: attr(data-display-value);
            color: #3b82f6;
            font-size: 0.875rem;
            font-weight: 500;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .dark .date-input-field::before {
            color: #60a5fa;
        }

        /* Center date display cells */
        .cell-date-display,
        .cell-date-edit {
            text-align: center;
            position: relative;
        }

        /* Show short date format on mobile, hide full date */
        .date-full {
            display: none;
        }

        .date-short {
            display: inline;
        }

        /* Swipeable row styles */
        .swipeable-row {
            position: relative;
            transition: transform 0.3s ease-out;
            will-change: transform;
        }

        /* Amount cell needs to be positioned to contain absolute buttons */
        .amount-cell-with-actions {
            position: relative;
            overflow: visible;
        }

        /* Mobile actions container (hidden behind row, revealed on swipe left) */
        .mobile-actions-btns {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            z-index: 10;
            pointer-events: none;
        }

        .swipeable-row.actions-revealed .mobile-actions-btns {
            pointer-events: auto;
        }

        .mobile-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
            border: none;
            cursor: pointer;
        }

        .mobile-action-btn.edit-btn {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-action-btn.edit-btn:active {
            background-color: #2563eb;
            transform: scale(0.95);
        }

        .mobile-action-btn.delete-btn {
            background-color: #ef4444;
            color: white;
        }

        .mobile-action-btn.delete-btn:active {
            background-color: #dc2626;
            transform: scale(0.95);
        }

        /* Realized status visual feedback */
        .row-realized {
            background-color: rgba(34, 197, 94, 0.15) !important;
        }

        .dark .row-realized {
            background-color: rgba(34, 197, 94, 0.1) !important;
        }

        .row-not-realized {
            background-color: rgba(148, 163, 184, 0.08) !important;
        }

        .dark .row-not-realized {
            background-color: rgba(148, 163, 184, 0.05) !important;
        }

        /* Disable drag handle on mobile in display mode */
        .drag-handle-cell .drag-handle {
            cursor: default;
            opacity: 0.3;
        }

        /* Edit save icon styling */
        .edit-save-icon {
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
        }

        /* Adjust padding for mobile */
        .swipeable-row td {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .swipeable-row .px-6 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Ensure table doesn't clip buttons */
        #expense-items-body {
            overflow: visible;
        }

        tbody tr {
            overflow: visible;
        }
    }

    /* Desktop: show full date, hide short date and mobile actions */
    @media (min-width: 769px) {
        .date-full {
            display: inline;
        }

        .date-short {
            display: none;
        }

        .mobile-actions-btns {
            display: none !important;
        }

        .edit-save-icon {
            display: none !important;
        }
    }
</style>

{% endblock content %}