{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load l10n %}

{% block title %}{% trans "Flow Group" %}: {{ flow_group.name|default:"New Group" }}{% endblock title %}

{% block content %}
<div class="p-6 md:p-10 lg:p-12">
    
    <div class="flex justify-between items-center mb-6">
        <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center text-primary hover:text-primary/80 transition-colors">
            <span class="material-symbols-outlined mr-2">arrow_back</span>
            {% trans "Back" %}
        </a>

        <div class="flex space-x-4">
            {% if not is_new and can_edit_group %}
            <button type="button" data-action="delete-flowgroup" class="rounded-lg border border-red-500 text-red-500 text-base font-medium p-3 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center">
                <span class="material-symbols-outlined text-lg mr-2">delete</span>
                {% trans "Group" %}
            </button>
            {% endif %}
            <button type="button" data-action="history-back" class="rounded-lg border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 text-base font-medium p-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                {% trans "Discard" %}
            </button>
            <button type="submit" form="flow-group-form" class="rounded-lg bg-primary text-white text-base font-medium p-3 hover:bg-primary/90 transition-colors shadow-lg flex items-center">
                <span class="material-symbols-outlined text-lg mr-2">save</span>
                {% trans "Save" %}
            </button>
        </div>
    </div>

    <form id="flow-group-form" method="POST" 
          action="{% if flow_group.id %}{% url 'edit_flow_group' flow_group.id %}{% else %}{% url 'add_flow_group' %}{% endif %}" 
          data-flow-group-id="{{ flow_group.id|default:'NEW' }}" novalidate>
        {% csrf_token %}
        {% if selected_period %}
        <input type="hidden" name="period" value="{{ selected_period }}">
        {% endif %}
        
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
            <!-- Desktop: Title and buttons on same line -->
            <div class="hidden lg:!flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-[#0d171b] dark:text-white">{{ flow_group.name|default:"Create New Flow Group" }}</h1>

                <div class="flex items-center gap-4">
                    {% if not is_new and current_member.role != 'CHILD' %}
                    <!-- Recurring Button -->
                    <button type="button"
                            data-action="toggle-flowgroup-recurring"
                            id="recurring-btn"
                            class="recurring-btn inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200 {% if flow_group.is_recurring %}bg-blue-600 text-white hover:bg-blue-700{% else %}bg-blue-600/30 text-blue-600 dark:text-blue-400 hover:bg-blue-600/50{% endif %}"
                            title="{% trans 'Mark this group as recurring to automatically copy it to new periods' %}">
                        <span class="text-sm font-medium">{% trans "Recurrent" %}</span>
                        <span class="flex items-center justify-center w-6 h-6 rounded {% if flow_group.is_recurring %}bg-blue-800{% else %}bg-blue-700/50{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" />
                            </svg>
                        </span>
                    </button>
                    {% endif %}

                    {% if flow_group.is_kids_group and not is_new %}
                    <div class="flex items-center gap-3 p-3 border-2 border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Budget Given:" %}</span>
                        <button type="button"
                                data-action="toggle-kids-realized" data-current-state="{{ flow_group.realized|yesno:'true,false' }}"
                                {% if current_member.role == 'CHILD' %}disabled{% endif %}
                                class="kids-group-realized-toggle relative inline-block w-12 h-7 transition duration-200 ease-in-out rounded-full {% if current_member.role == 'CHILD' %}cursor-not-allowed opacity-60{% else %}cursor-pointer{% endif %} {% if flow_group.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}"
                                title="{% if current_member.role == 'CHILD' %}Only Parents/Admins can change this{% else %}Click to toggle if budget was given to child{% endif %}">
                            <span class="absolute left-1 top-1 inline-block w-5 h-5 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if flow_group.realized %}translate-x-5{% endif %}"></span>
                        </button>
                        <span class="text-xs text-slate-600 dark:text-slate-400">
                            {% if flow_group.realized %}
                                ✓ Marked as given
                            {% else %}
                                Not given yet
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    {% if flow_group.is_credit_card and not is_new %}
                    <!-- Closed Button -->
                    <button type="button"
                            data-action="toggle-creditcard-closed" data-current-state="{{ flow_group.closed|yesno:'true,false' }}"
                            id="closed-btn"
                            {% if current_member.role == 'CHILD' %}disabled{% endif %}
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200"
                            style="{% if current_member.role == 'CHILD' %}border: 1px solid #d1d5db; opacity: 0.6; cursor: not-allowed;{% elif flow_group.closed %}background-color: #dc2626 !important; color: white !important; border: none;{% else %}background-color: rgba(220, 38, 38, 0.3) !important; color: #dc2626 !important; border: none;{% endif %}"
                            title="{% if current_member.role == 'CHILD' %}Only Parents/Admins can change this{% else %}Click to toggle if credit card bill is closed and paid{% endif %}">
                        <span class="text-sm font-medium">{% trans "Closed" %}</span>
                        <span class="flex items-center justify-center w-6 h-6 rounded" style="{% if flow_group.closed %}background-color: #991b1b;{% else %}background-color: rgba(185, 28, 28, 0.5);{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-col gap-6">

                <!-- Group Name and Budgeted Amount in same row - using flexbox -->
                <div class="flex flex-row gap-4 items-start">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.name.id_for_label }}">{% trans "Group Name" %}</label>
                        <div style="width: 200px;">
                            {{ form.name }}
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="{{ form.budgeted_amount.id_for_label }}">
                            {% trans "Budgeted Amount" %} ($)
                            {% if current_member.role == 'CHILD' %}
                            <span class="text-xs text-gray-500">({% trans "Read-only for children" %})</span>
                            {% endif %}
                        </label>
                        <div style="width: 150px;">
                            {{ form.budgeted_amount }}
                        </div>
                    </div>
                </div>

                <!-- Mobile: Buttons below name/budget fields -->
                <div class="md:hidden flex flex-wrap items-center gap-3">
                    {% if not is_new and current_member.role != 'CHILD' %}
                    <!-- Recurring Button -->
                    <button type="button"
                            data-action="toggle-flowgroup-recurring"
                            id="recurring-btn-mobile"
                            class="recurring-btn inline-flex items-center gap-2 px-3 py-2 rounded-lg transition-all duration-200 {% if flow_group.is_recurring %}bg-blue-600 text-white hover:bg-blue-700{% else %}bg-blue-600/30 text-blue-600 dark:text-blue-400 hover:bg-blue-600/50{% endif %}"
                            title="{% trans 'Mark this group as recurring to automatically copy it to new periods' %}">
                        <span class="text-sm font-medium">{% trans "Recurrent" %}</span>
                        <span class="flex items-center justify-center w-5 h-5 rounded {% if flow_group.is_recurring %}bg-blue-800{% else %}bg-blue-700/50{% endif %}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                      d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" />
                            </svg>
                        </span>
                    </button>
                    {% endif %}

                    {% if flow_group.is_credit_card and not is_new %}
                    <!-- Closed Button -->
                    <button type="button"
                            data-action="toggle-creditcard-closed" data-current-state="{{ flow_group.closed|yesno:'true,false' }}"
                            id="closed-btn-mobile"
                            {% if current_member.role == 'CHILD' %}disabled{% endif %}
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-all duration-200"
                            style="{% if current_member.role == 'CHILD' %}border: 1px solid #d1d5db; opacity: 0.6; cursor: not-allowed;{% elif flow_group.closed %}background-color: #dc2626 !important; color: white !important; border: none;{% else %}background-color: rgba(220, 38, 38, 0.3) !important; color: #dc2626 !important; border: none;{% endif %}"
                            title="{% if current_member.role == 'CHILD' %}Only Parents/Admins can change this{% else %}Click to toggle if credit card bill is closed and paid{% endif %}">
                        <span class="text-sm font-medium">{% trans "Closed" %}</span>
                        <span class="flex items-center justify-center w-6 h-6 rounded" style="{% if flow_group.closed %}background-color: #991b1b;{% else %}background-color: rgba(185, 28, 28, 0.5);{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                            </svg>
                        </span>
                    </button>
                    {% endif %}
                </div>

                <input type="hidden" name="group_type" value="EXPENSE_MAIN">

                <!-- Share, Kids, Investment checkboxes -->
                <div class="flex flex-wrap items-start gap-6">

                    {% if current_member.role != 'CHILD' %}
                    <!-- Checkboxes aligned with bottom of Budgeted Amount input -->
                    <div class="flex items-center gap-3 flex-wrap">
                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                                <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                       id="id_is_shared"
                                       name="is_shared"
                                       type="checkbox"
                                       data-change-action="handle-shared-change"
                                       {% if flow_group.is_shared or flow_group.is_kids_group %}checked{% endif %}>
                                <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Shared Group" %}</span>
                            </label>

                            <div id="members-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_shared and not flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                                {% for member in form.assigned_members.field.queryset %}
                                <label class="flex items-center p-2 border border-green-500/50 dark:border-green-500/30 rounded-lg bg-green-50 dark:bg-green-900/20 cursor-pointer hover:bg-green-100 dark:hover:bg-green-900/30">
                                    <input type="checkbox"
                                           name="assigned_members"
                                           value="{{ member.id }}"
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           {% if member in flow_group.assigned_members.all %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ member.user.username }}</span>
                                </label>
                                {% empty %}
                                <span class="text-sm text-gray-500 dark:text-gray-400 p-2">{% trans "No Parents/Admins" %}</span>
                                {% endfor %}
                            </div>

                            <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                                <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                       id="id_is_kids_group"
                                       name="is_kids_group"
                                       type="checkbox"
                                       data-change-action="handle-kids-change"
                                       {% if flow_group.is_kids_group %}checked{% endif %}>
                                <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Kids" %}</span>
                            </label>

                            <div id="children-selection-container" class="flex items-center gap-2 flex-wrap" style="display: {% if flow_group.is_kids_group %}flex{% else %}none{% endif %};">
                                {% for child in form.assigned_children.field.queryset %}
                                <label class="flex items-center p-2 border border-primary/50 dark:border-primary/30 rounded-lg bg-primary/10 dark:bg-primary/20 cursor-pointer hover:bg-primary/20 dark:hover:bg-primary/30">
                                    <input type="checkbox"
                                           name="assigned_children"
                                           value="{{ child.id }}"
                                           class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                           {% if child in flow_group.assigned_children.all %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-slate-700 dark:text-slate-200">{{ child.user.username }}</span>
                                </label>
                                {% empty %}
                                <span class="text-sm text-gray-500 dark:text-gray-400 p-2">{% trans "No children in family" %}</span>
                                {% endfor %}
                            </div>

                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                            <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                   id="id_is_investment"
                                   name="is_investment"
                                   type="checkbox"
                                   {% if flow_group.is_investment %}checked{% endif %}>
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Investment" %}</span>
                        </label>

                        <label class="flex items-center p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-slate-50 dark:bg-slate-700/50 cursor-pointer">
                            <input class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
                                   id="id_is_credit_card"
                                   name="is_credit_card"
                                   type="checkbox"
                                   data-change-action="handle-creditcard-change"
                                   {% if flow_group.is_credit_card %}checked{% endif %}>
                            <span class="ml-2 text-sm font-medium text-slate-700 dark:text-slate-300">{% trans "Credit Card" %}</span>
                        </label>
                    </div>
                    {% endif %}
                </div>
                </div>
            </div>
            
            {% if form.errors %}
                <div class="mt-4 p-3 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-700 rounded-lg text-red-700 dark:text-red-300">
                    <p class="font-bold">{% trans "Please correct the errors below:" %}</p>
                    {{ form.non_field_errors }}
                    <ul class="list-disc list-inside">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}



            {% if flow_group %}
            <div id="budget-warning-container" class="{% if not budget_warning %}hidden{% endif %} bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-500 p-4 mb-6 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <span class="material-symbols-outlined text-yellow-400">warning</span>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300">
                            <strong>{% trans "Budget Warning:" %}</strong> <span id="budget-warning-text">{% blocktrans with estimated=total_estimated|floatformat:2|intcomma budgeted=flow_group.budgeted_amount|floatformat:2|intcomma %}Estimated expenses ($ {{ estimated }}) exceed the budgeted amount ($ {{ budgeted }}).{% endblocktrans %}</span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">

                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Description" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider date-header-mobile">{% trans "Date" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider member-header-mobile">{% trans "Member" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Realized" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Fixed" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Amount" %}</th>
                            <th class="px-6 py-3 text-left w-24 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="expense-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for transaction in transactions %}
                        <tr id="item-{{ transaction.id }}"
                            data-item-id="{{ transaction.id }}"
                            data-mode="display"
                            data-realized="{{ transaction.realized|yesno:'true,false' }}"
                            data-fixed="{{ transaction.is_fixed|yesno:'true,false' }}"
                            data-amount="{{ transaction.amount.amount|default:transaction.amount|default:'0.00' }}"
                            data-order="{{ forloop.counter }}"
                            draggable="true"
                            class="draggable-row swipeable-row {% if transaction.realized %}row-realized{% else %}row-not-realized{% endif %} {% if transaction.is_fixed %}row-fixed{% endif %} hover:bg-slate-50 dark:hover:bg-gray-700/50">

                            <td class="px-2 py-4 text-center drag-handle-cell" data-row-id="item-{{ transaction.id }}">
                                <!-- Mobile Fixed Button (hidden behind row, revealed on swipe right) -->
                                {% if current_member.role != 'CHILD' %}
                                <div class="mobile-fixed-btn-container">
                                    <button type="button"
                                            data-action="toggle-transaction-fixed" data-row-id="item-{{ transaction.id }}"
                                            class="mobile-fixed-btn {% if transaction.is_fixed %}active{% endif %}"
                                            title="{% trans 'Mark as recurring expense' %}">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                                d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" />
                                        </svg>
                                    </button>
                                </div>
                                {% endif %}
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                                <button type="button" data-action="save" data-row-id="item-{{ transaction.id }}" class="edit-save-icon" style="display: none;">
                                    <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                </button>
                            </td>
                            <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display">{{ transaction.description }}</td>
                            <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit hidden">
                                <input type="text" value="{{ transaction.description }}" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1">
                            </td>

                            <td class="px-6 py-4 text-sm text-gray-500 cell-date-display">
                                <span class="date-full">{{ transaction.date|date:"Y-m-d" }}</span>
                                <span class="date-short">{{ transaction.date|date:"d/m" }}</span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit hidden">
                                <input type="date" value="{{ transaction.date|date:'Y-m-d' }}" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-sm p-1 date-input-field">
                            </td>

                            <td class="px-6 py-4 text-sm text-gray-500 cell-member-display" data-member-id="{{ transaction.member.id }}">
                                {{ transaction.member.user.username }}
                            </td>
                            <td class="px-6 py-2 cell-member-edit hidden">
                                <select data-field="member_id" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                                    {% for member in family_members %}
                                        {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                            <option value="{{ member.id }}" {% if member.id == transaction.member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>

                            <td class="px-6 py-4 mobile-hide-column">
                                <div class="flex items-center">
                                    <button type="button" data-toggle="realized" data-item-id="item-{{ transaction.id }}" data-current-state="{{ transaction.realized|yesno:'true,false' }}" class="realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                        <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-4{% endif %}"></span>
                                    </button>
                                </div>
                            </td>

                            <td class="px-6 py-4 mobile-hide-column">
                                <div class="flex items-center">
                                    {% if current_member.role != 'CHILD' %}
                                    <button type="button"
                                            data-action="toggle-fixed" data-item-id="item-{{ transaction.id }}"
                                            class="fixed-toggle-btn inline-flex items-center justify-center w-8 h-8 rounded transition-all duration-200 {% if transaction.is_fixed %}bg-blue-600 text-white hover:bg-blue-700{% else %}bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500 hover:bg-blue-200 dark:hover:bg-blue-900/30{% endif %}"
                                            title="{% trans 'Mark as recurring expense' %}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" />
                                        </svg>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="px-6 py-4 text-right text-primary cell-budget-display amount-cell-with-actions">
                                {{ transaction.amount|intcomma }}
                                <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                                <div class="mobile-actions-btns">
                                    <button type="button" data-action="edit" data-row-id="item-{{ transaction.id }}" class="mobile-action-btn edit-btn">
                                        <span class="material-symbols-outlined">edit</span>
                                    </button>
                                    <button type="button" data-action="delete" data-row-id="item-{{ transaction.id }}" class="mobile-action-btn delete-btn">
                                        <span class="material-symbols-outlined">delete</span>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right text-primary cell-budget-edit hidden">
                                <input type="text" inputmode="decimal" value="{{ transaction.amount.amount|default:transaction.amount|default:'0.00'|floatformat:2 }}" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1">
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap mobile-hide-column">
                                <div class="actions-display">
                                    <button type="button" data-action="edit" data-row-id="item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                                    <button type="button" data-action="delete" data-row-id="item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                                </div>
                                <div class="actions-edit hidden space-x-2">
                                    <button type="button" data-action="save" data-row-id="item-{{ transaction.id }}" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                    <button type="button" data-action="cancel" data-row-id="item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="empty-state-row">
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                {% trans "No transactions found for this Flow Group." %}
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <tr id="new-item-template" data-item-id="NEW" data-mode="edit" class="swipeable-row hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                            <td class="px-2 py-4 text-center drag-handle-cell">
                                <button type="button" data-action="save" data-item-id="new-item-template" class="edit-save-icon">
                                    <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                </button>
                            </td>
                            <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-display hidden"></td>
                            <td class="px-6 py-4 font-medium text-[#0d171b] dark:text-white cell-description-edit">
                                <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm p-1" placeholder="{% trans "New Item Description" %}">
                            </td>

                            <td class="px-6 py-4 text-sm text-gray-500 cell-date-display hidden"></td>
                            <td class="px-6 py-4 text-sm text-gray-500 cell-date-edit">
                                <input type="date" data-field="date" class="w-full border-b border-primary text-gray-900 dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-sm p-1 date-input-field" value="{{ today_date }}" data-display-value="{{ today_date|date:'d/m' }}">
                            </td>

                            <td class="px-6 py-4 text-sm text-gray-500 cell-member-display hidden"></td>
                            <td class="px-6 py-2 cell-member-edit">
                                <select data-field="member_id" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:ring-0 focus:border-primary text-sm p-1">
                                    {% for member in family_members %}
                                        {% if member_role_for_period == 'ADMIN' or member.role != 'ADMIN' %}
                                            <option value="{{ member.id }}" {% if member.id == current_member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>

                            <td class="px-6 py-4 mobile-hide-column">
                                <div class="flex items-center">
                                    <div class="realized-toggle-new relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600">
                                        <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                                    </div>
                                </div>
                            </td>

                            <td class="px-6 py-4 mobile-hide-column">
                                <div class="flex items-center">
                                    {% if current_member.role != 'CHILD' %}
                                    <div class="fixed-toggle-new relative inline-flex items-center justify-center w-8 h-8 rounded transition-all duration-200 bg-gray-200 dark:bg-gray-700 text-gray-400 dark:text-gray-500 cursor-pointer hover:bg-blue-200 dark:hover:bg-blue-900/30"
                                         data-action="toggle-new-item-fixed" data-item-id="new-item-template"
                                         data-fixed="false"
                                         title="{% trans 'Mark as recurring expense' %}">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" />
                                        </svg>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>

                            <td class="px-6 py-4 text-right text-primary cell-budget-display hidden"></td>
                            <td class="px-6 py-4 text-right text-primary cell-budget-edit amount-cell-with-actions">
                                <input type="text" inputmode="decimal" data-field="amount" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-sm text-right p-1" value="0{{ decimal_separator }}00">
                                <div class="mobile-actions-btns">
                                    <button type="button" data-action="save" data-row-id="new-item-template" class="mobile-action-btn edit-btn">
                                        <span class="material-symbols-outlined">check</span>
                                    </button>
                                    <button type="button" data-action="cancel-new-row" data-row-id="new-item-template" class="mobile-action-btn delete-btn">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </td>

                            <td class="px-6 py-4 whitespace-nowrap mobile-hide-column">
                                <div class="actions-display hidden"></div>
                                <div class="actions-edit space-x-2">
                                    <button type="button" data-action="save" data-item-id="new-item-template" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                    <button type="button" data-action="cancel-new-row" data-item-id="new-item-template" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                </div>
                            </td>
                        </tr>

                        <!-- Totals Row with Add New Item button -->
                        <tr id="totals-row" class="bg-gray-50 dark:bg-gray-800 border-t-2 border-gray-300 dark:border-gray-600 font-semibold">
                            <td colspan="2" class="px-4 py-3">
                                <button type="button" data-action="add-new-row" data-type="expense" class="totals-add-btn flex items-center text-sm font-medium">
                                    <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                                    {% trans "Add New Item" %}
                                </button>
                            </td>
                            <!-- Date column -->
                            <td class="px-6 py-3"></td>
                            <!-- Member column - shows LABELS on MOBILE only -->
                            <td class="px-2 py-3 text-right totals-member-col">
                                <div class="flex flex-col gap-1">
                                    <div class="text-sm">
                                        <span class="totals-label text-xs uppercase">{% trans "Total:" %}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="totals-label text-xs uppercase">{% trans "Realized:" %}</span>
                                    </div>
                                </div>
                            </td>
                            <!-- Realized column (hidden on mobile) -->
                            <td class="px-6 py-3 mobile-hide-column"></td>
                            <!-- Fixed column - Desktop: Shows LABELS, Mobile: Hidden -->
                            <td class="px-2 py-3 text-right mobile-hide-column totals-fixed-col">
                                <div class="flex flex-col gap-1">
                                    <div class="text-sm">
                                        <span class="totals-label text-xs uppercase">{% trans "Total:" %}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span class="totals-label text-xs uppercase">{% trans "Realized:" %}</span>
                                    </div>
                                </div>
                            </td>
                            <!-- Amount column - Desktop: Values only, Mobile: Values only -->
                            <td class="py-3 text-right totals-amount-col">
                                <!-- Desktop: Values only -->
                                <div class="totals-amount-desktop flex flex-col gap-1 pl-2 pr-6">
                                    <div class="text-sm">
                                        <span id="total-expenses-desktop" class="totals-value font-bold">{{ currency_symbol }} {{ total_estimated|floatformat:2|intcomma }}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span id="total-realized-desktop" class="totals-realized font-bold">{{ currency_symbol }} {{ total_realized|floatformat:2|intcomma }}</span>
                                    </div>
                                </div>
                                <!-- Mobile: Values only -->
                                <div class="totals-amount-mobile flex flex-col gap-1 px-6">
                                    <div class="text-sm">
                                        <span id="total-expenses-mobile" class="totals-value font-bold">{{ currency_symbol }} {{ total_estimated|floatformat:2|intcomma }}</span>
                                    </div>
                                    <div class="text-sm">
                                        <span id="total-realized-mobile" class="totals-realized font-bold">{{ currency_symbol }} {{ total_realized|floatformat:2|intcomma }}</span>
                                    </div>
                                </div>
                            </td>
                            <!-- Actions column - Empty on both desktop and mobile -->
                            <td class="px-6 py-3 mobile-hide-column totals-actions-col">
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>
        </form>
    </div>
    {% endif %}
</div>

<!-- PHASE 3 CSP Compliance: Configuration for FlowGroup.js -->
<div id="flowgroup-config" style="display: none;"
     data-decimal-separator="{{ decimal_separator }}"
     data-thousand-separator="{{ thousand_separator }}"
     data-currency-symbol="{{ currency_symbol|default:'$' }}"
     data-member-role-for-period="{{ member_role_for_period }}"
     data-selected-period="{{ selected_period|default:'' }}"
     data-flow-group-id="{{ flow_group.id|default:'NEW' }}"
     data-is-credit-card="{% if flow_group.is_credit_card %}true{% else %}false{% endif %}"
     data-is-closed="{% if flow_group.is_credit_card and flow_group.closed %}true{% else %}false{% endif %}"

     data-url-toggle-kids-group-realized="{% url 'toggle_kids_group_realized_ajax' %}"
     data-url-toggle-flowgroup-recurring="{% url 'toggle_flowgroup_recurring_ajax' %}"
     data-url-toggle-credit-card-closed="{% url 'toggle_credit_card_closed_ajax' %}"
     data-url-toggle-transaction-fixed="{% url 'toggle_transaction_fixed_ajax' %}"
     data-url-save-flow-item="{% url 'save_flow_item_ajax' %}"
     data-url-delete-flow-item="{% url 'delete_flow_item_ajax' %}"
     data-url-reorder-flow-items="{% url 'reorder_flow_items_ajax' %}"
     data-url-delete-flow-group="{% url 'delete_flow_group' flow_group.id|default:0 %}"
     data-url-dashboard="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}"

     data-i18n-estimated-expenses="{% trans 'Estimated expenses' %}"
     data-i18n-exceed-budget="{% trans 'exceed the budgeted amount' %}"
     data-i18n-marked-as-given="{% trans '✓ Marked as given' %}"
     data-i18n-not-given-yet="{% trans 'Not given yet' %}"
     data-i18n-budget-marked-as-given="{% trans 'Budget marked as given to child' %}"
     data-i18n-budget-marked-as-not-given="{% trans 'Budget marked as not given' %}"
     data-i18n-error-updating-status="{% trans 'Error updating status:' %}"
     data-i18n-network-error="{% trans 'A network error occurred.' %}"
     data-i18n-group-marked-recurring="{% trans 'Group marked as recurring - will be copied to new periods' %}"
     data-i18n-group-not-recurring="{% trans 'Group is no longer recurring' %}"
     data-i18n-error-updating-recurring="{% trans 'Error updating recurring status:' %}"
     data-i18n-bill-closed="{% trans 'Bill Closed' %}"
     data-i18n-bill-marked-closed="{% trans 'Bill marked as closed and paid' %}"
     data-i18n-bill-marked-not-closed="{% trans 'Bill marked as not closed' %}"
     data-i18n-bill-open="{% trans 'Bill Open' %}"
     data-i18n-items-marked-realized="{% trans 'items marked as realized' %}"
     data-i18n-please-save-flow-group-before-closed="{% trans 'Please save the Flow Group first before marking it as closed.' %}"
     data-i18n-please-save-flow-group-before-realized="{% trans 'Please save the Flow Group first before marking it as realized.' %}"
     data-i18n-please-save-flow-group-before-recurring="{% trans 'Please save the Flow Group first before marking it as recurring.' %}"
     data-i18n-please-save-transaction-before-fixed="{% trans 'Please save the transaction first before marking it as fixed.' %}"
     data-i18n-realized="{% trans 'Realized' %}"
     data-i18n-not-realized="{% trans 'Not Realized' %}"
     data-i18n-recurring="{% trans 'Recurring' %}"
     data-i18n-not-recurring="{% trans 'Not Recurring' %}"
     data-i18n-transaction-marked-fixed="{% trans 'Transaction marked as fixed - will be copied to new periods' %}"
     data-i18n-transaction-not-fixed="{% trans 'Transaction is no longer fixed' %}"
     data-i18n-deletion-warning="{% trans 'WARNING: All transactions in this group for the current period will be permanently deleted. This action cannot be undone.' %}"
     data-i18n-confirm-delete="{% trans 'Are you sure you want to delete this Flow Group?' %}"
     data-i18n-flow-group-deleted="{% trans 'Flow Group deleted successfully' %}"
     data-i18n-error-deleting-flow-group="{% trans 'Error deleting Flow Group:' %}"
     data-i18n-confirm-delete-item="{% trans 'Are you sure you want to delete this item?' %}"
     data-i18n-description-amount-date-required="{% trans 'Description, Amount, and Date are required.' %}"
     data-i18n-duplicate-name="{% trans 'Duplicate Name' %}"
     data-i18n-another-user="{% trans 'another user' %}"
     data-i18n-flow-group-deleted-by-user="{% trans 'This FlowGroup was deleted by' %}"
     data-i18n-flow-group-deleted-title="{% trans 'FlowGroup Deleted' %}"
     data-i18n-flow-group-deleted-success="{% trans 'FlowGroup Deleted Successfully' %}"
     data-i18n-ok="{% trans 'OK' %}"
     data-i18n-network-error-saving-order="{% trans 'A network error occurred while saving order.' %}"
></div>


<!-- Mobile-specific CSS -->
<style>
    /* Hide Realized and Actions columns on mobile */
    @media (max-width: 768px) {
        .mobile-hide-column {
            display: none !important;
        }

        /* Date column optimizations for mobile */
        .date-header-mobile {
            width: 60px;
        }

        /* Make date input work as a button - tap anywhere opens calendar */
        .date-input-field {
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .date-input-field {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Make entire input clickable - calendar icon spans full width */
        .date-input-field::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        /* Hide the text but keep input functional */
        .date-input-field {
            color: transparent;
            font-size: 0;
        }

        /* Show the actual date value using custom content */
        .date-input-field::before {
            content: attr(data-display-value);
            color: #3b82f6;
            font-size: 0.875rem;
            font-weight: 500;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .dark .date-input-field::before {
            color: #60a5fa;
        }

        /* Center date display cells */
        .cell-date-display,
        .cell-date-edit {
            text-align: center;
            position: relative;
        }

        /* Show short date format on mobile, hide full date */
        .date-full {
            display: none;
        }

        .date-short {
            display: inline;
        }

        /* Swipeable row styles */
        .swipeable-row {
            position: relative;
            transition: transform 0.3s ease-out;
            will-change: transform;
        }

        /* Amount cell needs to be positioned to contain absolute buttons */
        .amount-cell-with-actions {
            position: relative;
            overflow: visible;
        }

        /* Mobile actions container (hidden behind row, revealed on swipe left) */
        .mobile-actions-btns {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            z-index: 10;
            pointer-events: none;
        }

        .swipeable-row.actions-revealed .mobile-actions-btns {
            pointer-events: auto;
        }

        .mobile-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
            border: none;
            cursor: pointer;
        }

        .mobile-action-btn.edit-btn {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-action-btn.edit-btn:active {
            background-color: #2563eb;
            transform: scale(0.95);
        }

        .mobile-action-btn.delete-btn {
            background-color: #ef4444;
            color: white;
        }

        .mobile-action-btn.delete-btn:active {
            background-color: #dc2626;
            transform: scale(0.95);
        }

        /* Mobile fixed button container (hidden behind row, revealed on swipe right) */
        .mobile-fixed-btn-container {
            position: absolute;
            left: -56px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            pointer-events: auto;  /* CRITICAL FIX: Always allow pointer events */
        }

        .mobile-fixed-btn {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
            border: none;
            cursor: pointer;
            background-color: #d1d5db;
            color: #6b7280;
        }

        .mobile-fixed-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-fixed-btn:active {
            transform: scale(0.95);
        }

        /* Realized status visual feedback */
        .row-realized {
            background-color: rgba(34, 197, 94, 0.15) !important;
        }

        .dark .row-realized {
            background-color: rgba(34, 197, 94, 0.1) !important;
        }

        .row-not-realized {
            background-color: rgba(148, 163, 184, 0.08) !important;
        }

        .dark .row-not-realized {
            background-color: rgba(148, 163, 184, 0.05) !important;
        }

        /* IMPORTANT: Inputs inside rows should NOT inherit row background color */
        .row-realized input,
        .row-realized select,
        .row-not-realized input,
        .row-not-realized select {
            background-color: transparent !important;
        }

        /* Fixed status visual feedback (thick border on mobile) */
        @media (max-width: 768px) {
            .row-fixed {
                border-left: 6px solid #3b82f6 !important;
                box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.2);
            }

            .dark .row-fixed {
                border-left-color: #60a5fa;
                box-shadow: inset 0 0 0 1px rgba(96, 165, 250, 0.25);
            }
        }

        /* Drag handle cell needs relative positioning for mobile fixed button */
        .drag-handle-cell {
            position: relative;
        }

        /* On desktop: hide overflow to prevent mobile button from showing */
        @media (min-width: 769px) {
            .drag-handle-cell {
                overflow: hidden;
            }
        }

        /* On mobile: allow overflow to show the fixed button when swiped */
        @media (max-width: 768px) {
            .drag-handle-cell {
                overflow: visible;
            }
        }

        /* Disable drag handle on mobile in display mode */
        .drag-handle-cell .drag-handle {
            cursor: default;
            opacity: 0.3;
        }

        /* Edit save icon styling */
        .edit-save-icon {
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
        }

        /* Adjust padding for mobile */
        .swipeable-row td {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .swipeable-row .px-6 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Ensure table doesn't clip buttons */
        #expense-items-body {
            overflow: visible;
        }

        tbody tr {
            overflow: visible;
        }
    }

    /* Desktop: show full date, hide short date and mobile actions */
    @media (min-width: 769px) {
        .date-full {
            display: inline;
        }

        .date-short {
            display: none;
        }

        .mobile-actions-btns {
            display: none !important;
        }

        .mobile-fixed-btn-container {
            display: none !important;
        }

        .edit-save-icon {
            display: none !important;
        }
    }

    /* Totals row responsive layout */
    /* Mobile (max-width: 768px) - Labels in MEMBER column, Values in AMOUNT column */
    @media (max-width: 768px) {
        /* Header alignment adjustments for mobile */
        .date-header-mobile {
            text-align: center !important;
        }

        .member-header-mobile {
            text-align: center !important;
        }

        /* Data alignment adjustments for mobile */
        .cell-date-display,
        .cell-date-edit {
            text-align: center !important;
        }

        .cell-member-display,
        .cell-member-edit {
            text-align: center !important;
        }

        /* Totals row - Labels in MEMBER column, Values in AMOUNT column */
        .totals-member-col {
            display: table-cell !important;
        }
        .totals-member-col > div {
            display: flex !important;
        }
        .totals-fixed-col {
            display: none !important;
        }
        .totals-amount-col {
            display: table-cell !important;
        }
        .totals-amount-desktop {
            display: none !important;
        }
        .totals-amount-mobile {
            display: flex !important;
        }
        .totals-actions-col {
            display: none !important;
        }
    }

    /* Desktop (min-width: 769px) - Labels in FIXED column, Values in AMOUNT column */
    @media (min-width: 769px) {
        .totals-member-col {
            display: table-cell !important;
        }
        .totals-member-col > div {
            display: none !important;
        }
        .totals-fixed-col {
            display: table-cell !important;
        }
        .totals-amount-col {
            display: table-cell !important;
        }
        .totals-amount-desktop {
            display: flex !important;
        }
        .totals-amount-mobile {
            display: none !important;
        }
        .totals-actions-col {
            display: table-cell !important;
        }
    }

    /* Totals row styles - Light mode */
    .totals-add-btn {
        color: #13a4ec;
    }

    .totals-add-btn:hover {
        color: #0e7ab8;
    }

    .totals-label {
        color: #6b7280;
    }

    .totals-value {
        color: #111827;
    }

    .totals-realized {
        color: #16a34a;
    }

    /* Totals row styles - Dark mode */
    .dark .totals-add-btn {
        color: #60a5fa !important;
    }

    .dark .totals-add-btn:hover {
        color: #93c5fd !important;
    }

    .dark .totals-label {
        color: #9ca3af !important;
    }

    .dark .totals-value {
        color: #ffffff !important;
    }

    .dark .totals-realized {
        color: #4ade80 !important;
    }
</style>

<!-- PHASE 3 CSP Compliance: All inline scripts moved to external files -->
<script src="{% static 'finances/js/FlowGroup.js' %}?v=20260102-009" defer></script>
<script src="{% static 'finances/js/FlowGroup_realtime.js' %}?v=20260101-003" defer></script>

{% endblock content %}