{% load i18n %}

<!-- Period Change Confirmation Modal -->
<div id="period-change-modal"
     class="fixed inset-0 z-50 overflow-y-auto hidden"
     style="display: none;">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <!-- Background overlay -->
        <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-75"
             aria-hidden="true"></div>

        <!-- Modal panel -->
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
            <!-- Header -->
            <div class="bg-amber-50 dark:bg-amber-900/20 px-4 py-3 border-b border-amber-200 dark:border-amber-800">
                <div class="flex items-center">
                    <span class="material-symbols-outlined text-amber-500 text-2xl mr-2">warning</span>
                    <h3 class="text-lg font-bold text-amber-900 dark:text-amber-200">
                        {% trans "Period Configuration Change" %}
                    </h3>
                </div>
            </div>

            <!-- Body -->
            <div class="px-4 py-3">
                <!-- Current, New and Adjustment Period Side by Side -->
                <table border="0" cellpadding="0" cellspacing="8" style="width: 100%; margin-bottom: 12px;">
                    <tr>
                        <!-- Current Configuration -->
                        <td style="width: 33.33%; vertical-align: top;">
                            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-3 border border-blue-200 dark:border-blue-700/50">
                                <h4 class="text-xs font-semibold text-blue-900 dark:text-blue-200 mb-2 flex items-center">
                                    <span class="material-symbols-outlined text-blue-500 dark:text-blue-400 text-sm mr-1">info</span>
                                    {% trans "Current" %}
                                </h4>
                                <div class="space-y-1.5 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 dark:text-blue-300">{% trans "Type:" %}</span>
                                        <span id="modal-old-period-type" class="font-medium text-blue-900 dark:text-blue-100"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 dark:text-blue-300">{% trans "Period:" %}</span>
                                        <span id="modal-old-period-dates" class="font-medium text-blue-900 dark:text-blue-100"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-blue-700 dark:text-blue-300">{% trans "Days:" %}</span>
                                        <span id="modal-old-period-days" class="font-medium text-blue-900 dark:text-blue-100"></span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- New Configuration -->
                        <td style="width: 33.33%; vertical-align: top;">
                            <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-3 border border-green-200 dark:border-green-700/50">
                                <h4 class="text-xs font-semibold text-green-900 dark:text-green-200 mb-2 flex items-center">
                                    <span class="material-symbols-outlined text-green-500 dark:text-green-400 text-sm mr-1">update</span>
                                    {% trans "New" %}
                                </h4>
                                <div class="space-y-1.5 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-green-700 dark:text-green-300">{% trans "Type:" %}</span>
                                        <span id="modal-new-period-type" class="font-medium text-green-900 dark:text-green-100"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700 dark:text-green-300">{% trans "Period:" %}</span>
                                        <span id="modal-new-period-dates" class="font-medium text-green-900 dark:text-green-100"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-green-700 dark:text-green-300">{% trans "Days:" %}</span>
                                        <span id="modal-new-period-days" class="font-medium text-green-900 dark:text-green-100"></span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- Adjustment Period (if applicable) -->
                        <td id="modal-adjustment-section" style="width: 33.33%; vertical-align: top; display: none;">
                            <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-3 border border-purple-200 dark:border-purple-700/50">
                                <h4 class="text-xs font-semibold text-purple-900 dark:text-purple-200 mb-2 flex items-center">
                                    <span class="material-symbols-outlined text-purple-500 dark:text-purple-400 text-sm mr-1">schedule</span>
                                    {% trans "Adjustment" %}
                                </h4>
                                <div class="space-y-1.5 text-xs">
                                    <div class="flex justify-between">
                                        <span class="text-purple-700 dark:text-purple-300">{% trans "Period:" %}</span>
                                        <span id="modal-adjustment-dates" class="font-medium text-purple-900 dark:text-purple-100"></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-purple-700 dark:text-purple-300">{% trans "Days:" %}</span>
                                        <span id="modal-adjustment-days" class="font-medium text-purple-900 dark:text-purple-100"></span>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>

                <!-- Impact Message -->
                <div class="mb-3">
                    <div class="bg-orange-50 dark:bg-orange-950/40 rounded-lg p-3 border border-orange-200 dark:border-orange-700/50">
                        <p id="modal-impact-message" class="text-xs text-orange-900 dark:text-orange-200"></p>
                    </div>
                </div>

                <!-- Actions List - Collapsed -->
                <div class="mb-3">
                    <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 border border-gray-200 dark:border-gray-600/50">
                        <h4 class="text-xs font-semibold text-gray-900 dark:text-gray-200 mb-2">{% trans "Actions:" %}</h4>
                        <ul class="space-y-1 text-xs text-gray-700 dark:text-gray-300">
                            <li class="flex items-start">
                                <span class="text-teal-500 dark:text-teal-400 mr-1.5">•</span>
                                <span>{% trans "Save configuration" %}</span>
                            </li>
                            <li id="modal-action-adjustment" class="flex items-start hidden">
                                <span class="text-teal-500 dark:text-teal-400 mr-1.5">•</span>
                                <span>{% trans "Create adjustment period" %}</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-teal-500 dark:text-teal-400 mr-1.5">•</span>
                                <span>{% trans "Create new period" %}</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-teal-500 dark:text-teal-400 mr-1.5">•</span>
                                <span>{% trans "Copy FlowGroups" %}</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-teal-500 dark:text-teal-400 mr-1.5">•</span>
                                <span>{% trans "Move transactions" %}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="mb-3">
                    <label class="flex items-start cursor-pointer p-3 border-2 border-gray-300 dark:border-gray-500 rounded-lg bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                        <input type="checkbox"
                               id="modal-confirmation-checkbox"
                               class="mt-0.5 h-4 w-4 text-primary border-gray-300 dark:border-gray-400 rounded focus:ring-primary">
                        <span class="ml-2 text-xs text-gray-700 dark:text-gray-200">
                            <span class="font-semibold text-gray-900 dark:text-white">
                                {% trans "I understand and confirm these changes" %}
                            </span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 dark:bg-gray-800 px-4 py-3 flex justify-end space-x-2 border-t border-gray-200 dark:border-gray-600">
                <button type="button"
                        id="modal-cancel-btn"
                        class="px-4 py-2 border border-gray-300 dark:border-gray-500 rounded-lg text-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 font-medium transition-colors">
                    {% trans "Cancel" %}
                </button>
                <button type="button"
                        id="modal-confirm-btn"
                        disabled
                        class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    {% trans "Confirm Changes" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Period Change Modal Logic
(function() {
    'use strict';

    const modal = document.getElementById('period-change-modal');
    const checkbox = document.getElementById('modal-confirmation-checkbox');
    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');

    // Enable/disable confirm button based on checkbox
    if (checkbox && confirmBtn) {
        checkbox.addEventListener('change', function() {
            confirmBtn.disabled = !this.checked;
        });
    }

    // Cancel button closes modal
    if (cancelBtn && modal) {
        cancelBtn.addEventListener('click', function() {
            closePeriodChangeModal();
        });
    }

    // Close modal function
    window.closePeriodChangeModal = function() {
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';

            // Reset checkbox
            if (checkbox) {
                checkbox.checked = false;
            }

            // Disable confirm button
            if (confirmBtn) {
                confirmBtn.disabled = true;
            }
        }
    };

    // Show modal function (called from configurations.html)
    window.showPeriodChangeModal = function(impactData) {
        if (!modal) return;

        console.log('[PERIOD MODAL] Showing modal with impact data:', impactData);

        // Translation for "days"
        const daysText = '{% trans "dias" %}';

        // Populate modal with data
        document.getElementById('modal-old-period-type').textContent = impactData.old_period_type_label;
        document.getElementById('modal-old-period-dates').textContent = impactData.current_period_label;
        document.getElementById('modal-old-period-days').textContent = impactData.current_period_days;

        document.getElementById('modal-new-period-type').textContent = impactData.new_period_type_label;
        document.getElementById('modal-new-period-dates').textContent = impactData.new_period_label;
        document.getElementById('modal-new-period-days').textContent = impactData.new_period_days;

        document.getElementById('modal-impact-message').textContent = impactData.message;

        // Show/hide adjustment section
        const adjustmentSection = document.getElementById('modal-adjustment-section');
        const adjustmentAction = document.getElementById('modal-action-adjustment');

        if (impactData.adjustment_period) {
            adjustmentSection.style.display = 'table-cell';
            adjustmentAction.classList.remove('hidden');
            document.getElementById('modal-adjustment-dates').textContent = impactData.adjustment_period_label;
            document.getElementById('modal-adjustment-days').textContent = impactData.adjustment_period_days;
        } else {
            adjustmentSection.style.display = 'none';
            adjustmentAction.classList.add('hidden');
        }

        // Show modal
        modal.classList.remove('hidden');
        modal.style.display = 'block';
    };

    // Close modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closePeriodChangeModal();
            }
        });
    }

    // ESC key closes modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
            closePeriodChangeModal();
        }
    });
})();
</script>
