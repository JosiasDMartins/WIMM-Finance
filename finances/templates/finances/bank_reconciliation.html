{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block content %}
<div class="p-6 md:p-8 lg:p-10">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden mb-6">
        <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-3">
                <a href="{% url 'dashboard' %}{% if selected_period %}?period={{ selected_period }}{% endif %}"
                   class="flex items-center text-primary hover:text-primary/80 transition-colors"
                   title="{% trans 'Back to Dashboard' %}">
                    <span class="material-symbols-outlined mr-2">arrow_back</span>
                    <span class="hidden sm:inline">{% trans "Back" %}</span>
                </a>
                <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Bank Reconciliation" %}</h2>
            </div>

            <!-- Mode Toggle -->
            <label class="flex items-center cursor-pointer">
                <span class="mr-3 text-sm text-gray-700 dark:text-gray-300">{% trans "General" %}</span>
                <div class="relative">
                    <input type="checkbox" id="mode-toggle" class="sr-only" {% if mode == 'detailed' %}checked{% endif %}
                           onchange="window.location.href='?period={{ selected_period }}&mode=' + (this.checked ? 'detailed' : 'general')">
                    <div class="block bg-gray-300 dark:bg-gray-600 w-14 h-8 rounded-full"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                </div>
                <span class="ml-3 text-sm text-gray-700 dark:text-gray-300">{% trans "Detailed (by User)" %}</span>
            </label>
        </div>
        
        <!-- Bank Balance Input Table -->
        <div class="p-4">
            <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-4">{% trans "Current Bank Balances" %}</h3>
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead>
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{% trans "Description" %}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{% trans "Date" %}</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{% trans "Amount" %}</th>
                        {% if mode == 'detailed' %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{% trans "User" %}</th>
                        {% endif %}
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="bank-balance-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for balance in bank_balances %}
                    <tr id="balance-row-{{ balance.id }}" data-balance-id="{{ balance.id }}" data-mode="display">
                        <td class="px-4 py-3">
                            <span class="cell-description-display text-sm text-[#0d171b] dark:text-white">{{ balance.description }}</span>
                            <input type="text" class="cell-description-edit hidden w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white" value="{{ balance.description }}">
                        </td>
                        <td class="px-4 py-3">
                            <span class="cell-date-display text-sm text-gray-600 dark:text-gray-400">{{ balance.date|date:"M d, Y" }}</span>
                            <input type="date" class="cell-date-edit hidden w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white" value="{{ balance.date|date:"Y-m-d" }}">
                        </td>
                        <td class="px-4 py-3 text-right">
                            <span class="cell-amount-display text-sm text-green-600 dark:text-green-500 font-semibold">{{ balance.amount|intcomma }}</span>
                            <input type="text" inputmode="decimal" class="cell-amount-edit hidden w-full px-2 py-1 text-sm border rounded text-right dark:bg-gray-700 dark:text-white" value="{{ balance.amount.amount }}">
                        </td>
                        {% if mode == 'detailed' %}
                        <td class="px-4 py-3">
                            <span class="cell-member-display text-sm text-gray-600 dark:text-gray-400" data-member-id="{{ balance.member.id|default_if_none:'' }}">{{ balance.member.user.username|default:"Family" }}</span>
                            <select class="cell-member-edit hidden w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white">
                                {% if mode != 'detailed' %}
                                <option value="">{% trans "Family" %}</option>
                                {% endif %}
                                {% for member in family_members %}
                                <option value="{{ member.id }}" {% if balance.member.id == member.id %}selected{% endif %}>{{ member.user.username }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        {% endif %}
                        <td class="px-4 py-3 text-center">
                            <div class="actions-display flex justify-center space-x-2">
                                <button type="button" onclick="toggleEditBalance('balance-row-{{ balance.id }}', true)" class="p-1 text-slate-500 hover:text-primary">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </button>
                                <button type="button" onclick="deleteBalance('{{ balance.id }}')" class="p-1 text-slate-500 hover:text-red-500">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                            <div class="actions-edit hidden flex justify-center space-x-2">
                                <button type="button" onclick="saveBalance('balance-row-{{ balance.id }}')" class="p-1 text-green-500 hover:text-green-600">
                                    <span class="material-symbols-outlined text-lg">check</span>
                                </button>
                                <button type="button" onclick="toggleEditBalance('balance-row-{{ balance.id }}', false)" class="p-1 text-slate-500 hover:text-red-500">
                                    <span class="material-symbols-outlined text-lg">close</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="balance-empty-row">
                        <td colspan="{% if mode == 'detailed' %}5{% else %}4{% endif %}" class="px-4 py-6 text-center text-gray-500 dark:text-gray-400">
                            {% trans 'No bank balances entered yet. Click "Add Bank Balance" to start.' %}
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <!-- New Row Template (hidden by default) -->
                    <tr id="new-balance-template" data-balance-id="new" data-mode="edit" style="display: none;">
                        <td class="px-4 py-3">
                            <input type="text" class="cell-description-edit w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white" placeholder="{% trans 'Bank account name' %}">
                        </td>
                        <td class="px-4 py-3">
                            <input type="date" class="cell-date-edit w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white" value="{{ start_date|date:"Y-m-d" }}">
                        </td>
                        <td class="px-4 py-3 text-right">
                            <input type="text" inputmode="decimal" class="cell-amount-edit w-full px-2 py-1 text-sm border rounded text-right dark:bg-gray-700 dark:text-white" value="0{{ decimal_separator }}00">
                        </td>
                        {% if mode == 'detailed' %}
                        <td class="px-4 py-3">
                            <select class="cell-member-edit w-full px-2 py-1 text-sm border rounded dark:bg-gray-700 dark:text-white">
                                {% for member in family_members %}
                                <option value="{{ member.id }}">{{ member.user.username }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        {% endif %}
                        <td class="px-4 py-3 text-center">
                            <div class="actions-edit flex justify-center space-x-2">
                                <button type="button" onclick="saveBalance('new-balance-template')" class="p-1 text-green-500 hover:text-green-600">
                                    <span class="material-symbols-outlined text-lg">check</span>
                                </button>
                                <button type="button" onclick="cancelNewBalance()" class="p-1 text-slate-500 hover:text-red-500">
                                    <span class="material-symbols-outlined text-lg">close</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-4 flex justify-between items-center">
                <button type="button" onclick="addNewBalance()" class="flex items-center rounded-lg bg-primary text-white text-sm font-medium px-4 py-2 hover:bg-primary/80 transition-colors">
                    <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                    {% trans "Add Bank Balance" %}
                </button>

                <div class="text-right">
                    <span class="text-sm text-gray-600 dark:text-gray-400">{% trans "Total Bank Balance:" %}</span>
                    <span id="total-bank-balance" class="text-lg font-bold text-green-600 dark:text-green-500 ml-2">
                        {{ currency_symbol }} {{ reconciliation_data.total_bank_balance|default:"0.00"|intcomma }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reconciliation Results -->
    <div id="reconciliation-results-container">
    {% if mode == 'general' %}
    <!-- General Reconciliation -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white">{% trans "General Reconciliation (Family)" %}</h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">{% trans "Total Income" %}</div>
                    <div id="reconciliation-total-income" class="text-2xl font-bold text-green-600 dark:text-green-500"> {{ currency_symbol }}{{ reconciliation_data.total_income|intcomma }}</div>
                </div>
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">{% trans "Total Expenses" %}</div>
                    <div id="reconciliation-total-expenses" class="text-2xl font-bold text-red-600 dark:text-red-500">{{ currency_symbol }} {{ reconciliation_data.total_expenses|intcomma }}</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">{% trans "Calculated Balance" %}</div>
                    <div id="reconciliation-calculated-balance" class="text-2xl font-bold {% if reconciliation_data.calculated_balance >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %}">
                        {{ currency_symbol }} {{ reconciliation_data.calculated_balance|intcomma }}
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Bank Balance" %}</div>
                        <div id="reconciliation-bank-balance" class="text-2xl font-bold text-[#0d171b] dark:text-white">{{ currency_symbol }} {{ reconciliation_data.total_bank_balance|intcomma }}</div>
                    </div>
                    <div class="text-4xl text-gray-300 dark:text-gray-600">−</div>
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Calculated Balance" %}</div>
                        <div id="reconciliation-calculated-balance-2" class="text-2xl font-bold text-[#0d171b] dark:text-white">{{ currency_symbol }} {{ reconciliation_data.calculated_balance|intcomma }}</div>
                    </div>
                    <div class="text-4xl text-gray-300 dark:text-gray-600">=</div>
                    <div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">{% trans "Discrepancy" %}</div>
                        <div id="reconciliation-discrepancy" class="text-2xl font-bold {% if reconciliation_data.discrepancy >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %}">
                            {{ currency_symbol }} {{ reconciliation_data.discrepancy|intcomma }}
                        </div>
                        <div id="reconciliation-discrepancy-percentage" class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            ({{ reconciliation_data.discrepancy_percentage|floatformat:2 }}%)
                        </div>
                    </div>
                </div>
                
                <div id="reconciliation-warning-container" class="mt-4">
                {% if reconciliation_data.has_warning %}
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4">
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-yellow-500 mr-3">warning</span>
                        <div>
                            <h4 class="text-sm font-semibold text-yellow-800 dark:text-yellow-500">{% trans "Warning: Discrepancy Detected" %}</h4>
                            <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                                {% blocktrans %}The difference between your bank balance and calculated balance is greater than {{ discrepancy_percentage_tolerance }}%. Please review your transactions.{% endblocktrans %}
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4">  
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-green-500 mr-3">check_circle</span>
                        <div>
                            <h4 class="text-sm font-semibold text-green-800 dark:text-green-500">{% trans "Reconciliation OK" %}</h4>
                            <p class="text-sm text-green-700 dark:text-green-400 mt-1">
                                {% trans "Your bank balance matches your calculated balance within acceptable limits." %}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Detailed Reconciliation (by User) -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white">{% trans "Detailed Reconciliation (by User)" %}</h3>
        </div>
        <div class="p-6 space-y-6">
            {% for member_data in reconciliation_data.members_data %}
            <div id="member-reconciliation-{{ member_data.member.id }}" class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-4">{{ member_data.member.user.username }}</h4>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">{% trans "Income" %}</div>
                        <div class="text-lg font-bold text-green-600 dark:text-green-500 reconciliation-member-income">{{ currency_symbol }} {{ member_data.income|intcomma }}</div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">{% trans "Expenses" %}</div>
                        <div class="text-lg font-bold text-red-600 dark:text-red-500 reconciliation-member-expenses">{{ currency_symbol }} {{ member_data.expenses|intcomma }}</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">{% trans "Calculated" %}</div>
                        <div class="text-lg font-bold {% if member_data.calculated_balance >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} reconciliation-member-calculated">
                            {{ currency_symbol }} {{ member_data.calculated_balance|intcomma }}
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex-1 text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400">{% trans "Bank Balance" %}</div>
                        <div class="text-xl font-bold text-[#0d171b] dark:text-white reconciliation-member-bank">{{ currency_symbol }} {{ member_data.bank_balance|intcomma }}</div>
                    </div>
                    <div class="text-2xl text-gray-300 dark:text-gray-600 mx-2">−</div>
                    <div class="flex-1 text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400">{% trans "Calculated" %}</div>
                        <div class="text-xl font-bold text-[#0d171b] dark:text-white reconciliation-member-calculated-2">{{ currency_symbol }} {{ member_data.calculated_balance|intcomma }}</div>
                    </div>
                    <div class="text-2xl text-gray-300 dark:text-gray-600 mx-2">=</div>
                    <div class="flex-1 text-center">
                        <div class="text-xs text-gray-600 dark:text-gray-400">{% trans "Discrepancy" %}</div>
                        <div class="text-xl font-bold {% if member_data.discrepancy >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} reconciliation-member-discrepancy">
                            {{ currency_symbol }} {{ member_data.discrepancy|intcomma }}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 reconciliation-member-discrepancy-percentage">
                            ({{ member_data.discrepancy_percentage|floatformat:2 }}%)
                        </div>
                    </div>
                </div>

                <div class="reconciliation-member-warning-container mt-4">
                {% if member_data.has_warning %}
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-3">
                    <div class="flex items-center">
                        <span class="material-symbols-outlined text-yellow-500 mr-2 text-base">warning</span>
                        <p class="text-xs text-yellow-700 dark:text-yellow-400">
                            {% blocktrans %}Discrepancy exceeds {{ discrepancy_percentage_tolerance }}% for this user{% endblocktrans %}
                        </p>
                    </div>
                </div>
                {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    </div>
</div>

<style>
#mode-toggle:checked ~ .block {
    background-color: #0D9488;
}
#mode-toggle:checked ~ .dot {
    transform: translateX(100%);
}
.dot {
    transition: transform 0.3s ease;
}
</style>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Money mask variables
const decimalSeparator = "{{ decimal_separator }}";
const thousandSeparator = "{{ thousand_separator }}";
const currencySymbol = "{{ currency_symbol }}";

// Money mask functions
function applyMoneyMask(event) {
    const input = event.target;
    
    // 1. Save cursor position and original value
    const originalCursorPos = input.selectionStart;
    const originalValue = input.value;

    let value = input.value;

    // Remove all non-digit characters
    value = value.replace(/\D/g, '');

    // If empty, set to 0. This case is simple.
    if (value === '') {
        input.value = '0' + decimalSeparator + '00';
        // Position cursor at end for the default zero value
        setTimeout(function() {
            input.setSelectionRange(input.value.length, input.value.length);
        }, 0);
        return;
    }

    // Convert to integer (cents)
    let cents = parseInt(value, 10);

    // Format as currency with 2 decimal places
    let integerPart = Math.floor(cents / 100).toString();
    let decimalPart = (cents % 100).toString().padStart(2, '0');

    // Add thousand separators to integer part
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

    // Set the new formatted value
    input.value = integerPart + decimalSeparator + decimalPart;

    // 3. Calculate and restore cursor position
    const newLength = input.value.length;
    const oldLength = originalValue.length;
    let newCursorPos = originalCursorPos + (newLength - oldLength);

    // Ensure cursor doesn't go to a negative position (can happen on delete)
    if (newCursorPos < 0) {
        newCursorPos = 0;
    }
    
    input.setSelectionRange(newCursorPos, newCursorPos);
}

function getRawValue(maskedValue) {
    let value = maskedValue.replace(new RegExp('\\' + thousandSeparator, 'g'), '');
    value = value.replace(decimalSeparator, '.');
    return value;
}

function formatCurrency(amount) {
    const num = parseFloat(amount);
    if (isNaN(num)) return amount;

    const parts = num.toFixed(2).split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];
    const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

    return currencySymbol + ' ' + formattedInteger + decimalSeparator + decimalPart;
}


// Initialize money mask on page load
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('input', function(event) {
        if (event.target.matches('.cell-amount-edit')) {
            applyMoneyMask(event);
        }
    });
    document.addEventListener('focus', function(event) {
        if (event.target.matches('.cell-amount-edit')) {
            if (!event.target.hasAttribute('data-first-focus-done')) {
                event.target.setAttribute('data-first-focus-done', 'true');
                setTimeout(function() {
                    event.target.setSelectionRange(event.target.value.length, event.target.value.length);
                }, 0);
            }
        }
    }, true);
    document.addEventListener('blur', function(event) {
        if (event.target.matches('.cell-amount-edit')) {
            event.target.removeAttribute('data-first-focus-done');
        }
    }, true);

    document.querySelectorAll('.cell-amount-edit').forEach(function(input) {
        if (input.value && input.value.trim() !== '') {
            let value = input.value.replace(',', '.');
            let num = parseFloat(value);
            if (!isNaN(num)) {
                let cents = Math.round(num * 100);
                let integerPart = Math.floor(cents / 100).toString();
                let decimalPart = (cents % 100).toString().padStart(2, '0');
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);
                input.value = integerPart + decimalSeparator + decimalPart;
            } else {
                input.value = '0' + decimalSeparator + '00';
            }
        } else {
            input.value = '0' + decimalSeparator + '00';
        }
    });
});

function addNewBalance() {
    const template = document.getElementById('new-balance-template');
    const emptyRow = document.getElementById('balance-empty-row');
    if (emptyRow) emptyRow.style.display = 'none';
    template.style.display = '';
    template.querySelector('.cell-description-edit').focus();
}

function cancelNewBalance() {
    const template = document.getElementById('new-balance-template');
    const tbody = document.getElementById('bank-balance-tbody');
    const emptyRow = document.getElementById('balance-empty-row');
    
    template.style.display = 'none';
    
    template.querySelector('.cell-description-edit').value = '';
    template.querySelector('.cell-amount-edit').value = '0' + decimalSeparator + '00';
    template.querySelector('.cell-date-edit').value = '{{ start_date|date:"Y-m-d" }}';
    const memberSelect = template.querySelector('.cell-member-edit');
    if (memberSelect) memberSelect.value = '';
    
    const dataRows = tbody.querySelectorAll('tr[data-balance-id]:not(#new-balance-template)');
    if (dataRows.length === 0 && emptyRow) {
        emptyRow.style.display = '';
    }
}

function toggleEditBalance(rowId, edit) {
    const row = document.getElementById(rowId);
    row.setAttribute('data-mode', edit ? 'edit' : 'display');
    
    const displayElements = row.querySelectorAll('.cell-description-display, .cell-amount-display, .cell-date-display, .cell-member-display, .actions-display');
    const editElements = row.querySelectorAll('.cell-description-edit, .cell-amount-edit, .cell-date-edit, .cell-member-edit, .actions-edit');

    displayElements.forEach(el => el.classList.toggle('hidden', edit));
    editElements.forEach(el => el.classList.toggle('hidden', !edit));

    if (edit) {
        const amountInput = row.querySelector('.cell-amount-edit');
        // Remove thousand separators first, then replace decimal separator with dot
        let rawValue = amountInput.value.replace(new RegExp('\\' + thousandSeparator, 'g'), '');
        rawValue = rawValue.replace(decimalSeparator, '.');
        const num = parseFloat(rawValue);
        if (!isNaN(num)) {
            const cents = Math.round(num * 100);
            const integerPart = Math.floor(cents / 100).toString();
            const decimalPart = (cents % 100).toString().padStart(2, '0');
            const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator) + decimalSeparator + decimalPart;
            amountInput.value = formatted;
        }
    }
}

function saveBalance(rowId) {
    const row = document.getElementById(rowId);
    const balanceId = row.getAttribute('data-balance-id');
    const isNew = balanceId === 'new';

    const description = row.querySelector('.cell-description-edit').value.trim();
    const amount = getRawValue(row.querySelector('.cell-amount-edit').value);
    const date = row.querySelector('.cell-date-edit').value;
    const memberSelect = row.querySelector('.cell-member-edit');
    const memberId = memberSelect ? memberSelect.value : null;
    
    if (!description) {
        alert("{% trans 'Please enter a description' %}");
        return;
    }
    
    const data = {
        id: isNew ? null : balanceId,
        description: description,
        amount: amount,
        date: date,
        member_id: memberId,
        period_start_date: '{{ start_date|date:"Y-m-d" }}'
    };
    
    fetch("{% url 'save_bank_balance_ajax' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (isNew) {
                location.reload(); // Simple reload for new item for now
            } else {
                updateRow(row, data);
                toggleEditBalance(rowId, false);
                updateReconciliationSummary();
            }
        } else {
            alert("{% trans 'Error saving balance:' %} " + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("{% trans 'Network error occurred' %}");
    });
}

function updateRow(row, data) {
    row.querySelector('.cell-description-display').textContent = data.description;
    row.querySelector('.cell-date-display').textContent = new Date(data.date + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    row.querySelector('.cell-amount-display').textContent = formatCurrency(data.amount);
    
    if (row.querySelector('.cell-member-display')) {
        row.querySelector('.cell-member-display').textContent = data.member_name || 'Family';
        row.querySelector('.cell-member-display').setAttribute('data-member-id', data.member_id || '');
    }

    // Update edit fields as well
    row.querySelector('.cell-description-edit').value = data.description;
    row.querySelector('.cell-date-edit').value = data.date;
    row.querySelector('.cell-amount-edit').value = data.amount;
    if (row.querySelector('.cell-member-edit')) {
        row.querySelector('.cell-member-edit').value = data.member_id || '';
    }
}

function deleteBalance(balanceId) {
    if (!confirm("{% trans 'Are you sure you want to delete this bank balance entry?' %}")) {
        return;
    }

    fetch("{% url 'delete_bank_balance_ajax' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({ id: balanceId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('balance-row-' + balanceId).remove();
            updateReconciliationSummary();
        } else {
            alert("{% trans 'Error deleting balance:' %} " + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("{% trans 'Network error occurred' %}");
    });
}

function updateReconciliationSummary() {
    const urlParams = new URLSearchParams(window.location.search);
    const period = urlParams.get('period') || '{{ start_date|date:"Y-m-d" }}';
    const mode = urlParams.get('mode') || 'general';
    const baseUrl = "{% url 'get_reconciliation_summary_ajax' %}";
    const url = `${baseUrl}?period=${period}&mode=${mode}`;

    fetch(url)
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const summary = data.reconciliation_data;
            if (summary.mode === 'general') {
                document.getElementById('reconciliation-total-income').textContent = formatCurrency(summary.total_income);
                document.getElementById('reconciliation-total-expenses').textContent = formatCurrency(summary.total_expenses);
                document.getElementById('reconciliation-calculated-balance').textContent = formatCurrency(summary.calculated_balance);
                document.getElementById('reconciliation-calculated-balance-2').textContent = formatCurrency(summary.calculated_balance);
                document.getElementById('reconciliation-bank-balance').textContent = formatCurrency(summary.total_bank_balance);
                document.getElementById('total-bank-balance').textContent = formatCurrency(summary.total_bank_balance);
                document.getElementById('reconciliation-discrepancy').textContent = formatCurrency(summary.discrepancy);
                document.getElementById('reconciliation-discrepancy-percentage').textContent = `(${parseFloat(summary.discrepancy_percentage).toFixed(2)}%)`;
                
                const discrepancy_val = parseFloat(summary.discrepancy);
                const discrepancy_el = document.getElementById('reconciliation-discrepancy');
                discrepancy_el.classList.toggle('text-green-600', discrepancy_val >= 0);
                discrepancy_el.classList.toggle('dark:text-green-500', discrepancy_val >= 0);
                discrepancy_el.classList.toggle('text-red-600', discrepancy_val < 0);
                discrepancy_el.classList.toggle('dark:text-red-500', discrepancy_val < 0);
                
                // Update warning
                const warningContainer = document.getElementById('reconciliation-warning-container');
                if (summary.has_warning) {
                    warningContainer.innerHTML = `
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-yellow-500 mr-3">warning</span>
                            <div>
                                <h4 class="text-sm font-semibold text-yellow-800 dark:text-yellow-500">{% trans "Warning: Discrepancy Detected" %}</h4>
                                <p class="text-sm text-yellow-700 dark:text-yellow-400 mt-1">
                                    {% blocktrans %}The difference between your bank balance and calculated balance is greater than {{ discrepancy_percentage_tolerance }}%. Please review your transactions.{% endblocktrans %}
                                </p>
                            </div>
                        </div>
                    </div>`;
                } else {
                    warningContainer.innerHTML = `
                    <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4">
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-green-500 mr-3">check_circle</span>
                            <div>
                                <h4 class="text-sm font-semibold text-green-800 dark:text-green-500">{% trans "Reconciliation OK" %}</h4>
                                <p class="text-sm text-green-700 dark:text-green-400 mt-1">
                                    {% trans "Your bank balance matches your calculated balance within acceptable limits." %}
                                </p>
                            </div>
                        </div>
                    </div>`;
                }

            } else { // detailed mode
                summary.members_data.forEach(memberData => {
                    const container = document.getElementById(`member-reconciliation-${memberData.member_id}`);
                    if (container) {
                        container.querySelector('.reconciliation-member-income').textContent = formatCurrency(memberData.income);
                        container.querySelector('.reconciliation-member-expenses').textContent = formatCurrency(memberData.expenses);
                        container.querySelector('.reconciliation-member-calculated').textContent = formatCurrency(memberData.calculated_balance);
                        container.querySelector('.reconciliation-member-calculated-2').textContent = formatCurrency(memberData.calculated_balance);
                        container.querySelector('.reconciliation-member-bank').textContent = formatCurrency(memberData.bank_balance);
                        container.querySelector('.reconciliation-member-discrepancy').textContent = formatCurrency(memberData.discrepancy);
                        container.querySelector('.reconciliation-member-discrepancy-percentage').textContent = `(${parseFloat(memberData.discrepancy_percentage).toFixed(2)}%)`;
                    
                        const discrepancy_val = parseFloat(memberData.discrepancy);
                        const discrepancy_el = container.querySelector('.reconciliation-member-discrepancy');
                        discrepancy_el.classList.toggle('text-green-600', discrepancy_val >= 0);
                        discrepancy_el.classList.toggle('dark:text-green-500', discrepancy_val >= 0);
                        discrepancy_el.classList.toggle('text-red-600', discrepancy_val < 0);
                        discrepancy_el.classList.toggle('dark:text-red-500', discrepancy_val < 0);

                        const warningContainer = container.querySelector('.reconciliation-member-warning-container');
                        if(memberData.has_warning) {
                             warningContainer.innerHTML = `
                            <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-3 mt-4">
                                <div class="flex items-center">
                                    <span class="material-symbols-outlined text-yellow-500 mr-2 text-base">warning</span>
                                    <p class="text-xs text-yellow-700 dark:text-yellow-400">
                                        {% blocktrans %}Discrepancy exceeds {{ discrepancy_percentage_tolerance }}% for this user{% endblocktrans %}
                                    </p>
                                </div>
                            </div>`;
                        } else {
                            warningContainer.innerHTML = '';
                        }
                    }
                });
            }
        }
    });
}

// ==============================================
// REAL-TIME SYNCHRONIZATION
// ==============================================

/**
 * Bank Reconciliation Real-time Update Handlers
 * Handles WebSocket messages for bank balance changes
 */
window.BankReconciliationRealtime = {

    /**
     * Handle bank balance created/updated from another user
     */
    updateBalance: function(balanceData) {
        console.log('[BankRecon RT] Updating balance:', balanceData);

        // Check if we're on the bank reconciliation page
        if (!document.getElementById('bank-balance-tbody')) {
            return;
        }

        const row = document.querySelector(`tr[data-balance-id="${balanceData.id}"]`);

        if (row) {
            // Update existing row using the data format expected by updateRow()
            const data = {
                description: balanceData.description,
                amount: balanceData.amount,
                date: balanceData.date,
                member_id: balanceData.member_id,
                member_name: balanceData.member_name
            };

            updateRow(row, data);

            // Highlight the updated row
            if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
                window.RealtimeUI.utils.highlightElement(row, 2000);
            }
        } else {
            // New balance created by another user - reload page to show it
            console.log('[BankRecon RT] New balance detected, reloading page');
            location.reload();
        }

        // Update reconciliation totals
        if (typeof updateReconciliationSummary === 'function') {
            updateReconciliationSummary();
        }
    },

    /**
     * Handle bank balance deleted by another user
     */
    deleteBalance: function(balanceId) {
        console.log('[BankRecon RT] Deleting balance:', balanceId);

        const row = document.querySelector(`tr[data-balance-id="${balanceId}"]`);
        if (row) {
            // Fade out animation
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';

            setTimeout(() => {
                if (row.parentNode) {
                    row.parentNode.removeChild(row);

                    // Check if table is empty
                    const tbody = document.getElementById('bank-balance-tbody');
                    const dataRows = tbody.querySelectorAll('tr[data-balance-id]:not(#new-balance-template)');
                    if (dataRows.length === 0) {
                        const emptyRow = document.getElementById('balance-empty-row');
                        if (emptyRow) {
                            emptyRow.style.display = '';
                        }
                    }
                }
            }, 300);
        }

        // Update reconciliation totals
        if (typeof updateReconciliationSummary === 'function') {
            updateReconciliationSummary();
        }
    }
};

// Listen for real-time bank balance events
document.addEventListener('realtime:bankbalance:updated', function(event) {
    if (window.BankReconciliationRealtime && window.BankReconciliationRealtime.updateBalance) {
        window.BankReconciliationRealtime.updateBalance(event.detail.data);
    }
});

document.addEventListener('realtime:bankbalance:deleted', function(event) {
    if (window.BankReconciliationRealtime && window.BankReconciliationRealtime.deleteBalance) {
        window.BankReconciliationRealtime.deleteBalance(event.detail.data.id);
    }
});

console.log('[BankReconciliationRealtime] Loaded successfully');
</script>
{% endblock %}