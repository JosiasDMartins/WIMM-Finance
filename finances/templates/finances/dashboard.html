{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load l10n %}

{% block content %}
<!-- Dashboard Configuration (passed to external JS files) -->
<div id="dashboard-config" style="display: none;"
     data-income-flowgroup-id="{{ income_flow_group_id }}"
     data-member-role="{{ member_role_for_period }}"
     data-decimal-separator="{{ decimal_separator }}"
     data-thousand-separator="{{ thousand_separator }}"
     data-currency-symbol="{{ currency_symbol }}"
     data-periods-history='{{ periods_history_json|safe }}'
     data-url-delete-item="{% url 'delete_flow_item_ajax' %}"
     data-url-save-item="{% url 'save_flow_item_ajax' %}"
     data-url-reorder-income="{% url 'reorder_income_items_ajax' %}"
     data-url-reorder-flowgroups="{% url 'reorder_flow_groups_ajax' %}"
     data-url-balance-summary="{% url 'get_balance_summary_ajax' %}"
     data-url-ytd-metrics="{% url 'get_ytd_metrics_ajax' %}"
     data-i18n-delete-confirm="{% trans 'Are you sure you want to delete this item?' %}"
     data-i18n-description-required="{% trans 'Description, Amount, and Date are required.' %}"
     data-i18n-error-saving="{% trans 'Error saving item:' %}"
     data-i18n-error-deleting="{% trans 'Error deleting item:' %}"
     data-i18n-error-network="{% trans 'A network error occurred.' %}"
     data-i18n-error-saving-order="{% trans 'Error saving order:' %}"
     data-i18n-network-error-order="{% trans 'A network error occurred while saving order.' %}"
     data-i18n-error-saving-income="{% trans 'Error saving income:' %}"
     data-i18n-error-updating-status="{% trans 'Error updating income status:' %}"
     data-i18n-only-parents-change="{% trans 'Only Parents/Admins can change this status' %}"
     data-i18n-others="{% trans 'Others' %}"
     data-i18n-total-expenses="{% trans 'Total Expenses' %}"
     data-i18n-trend="{% trans 'Trend' %}"
     data-i18n-over-budget="{% trans '⚠ Over budget' %}"
     data-i18n-no-expense-groups="{% trans 'No expense groups defined. Click \"Add Group\" to start.' %}">
</div>
<div class="p-6 md:p-8 lg:p-10">
    <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm mb-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <!-- Charts Section -->
            <div class="lg:col-span-2 flex flex-col">
                <div class="grid grid-cols-3 gap-3">
                    <div class="flex flex-col">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Top Expenses" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%; overflow: visible;">
                            <div style="position: relative; height: 200px; width: 100%; max-width: 280px;">
                                <canvas id="expensesPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bar Chart -->
                    <div class="flex flex-col col-span-2">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Expense History (Last 12 Periods)" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%;">
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="expensesBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Card -->
            <div class="flex flex-col">
                <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3">{% trans "Key Metrics (YTD)" %}</h3>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3 space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Income" %}</span>
                        <span id="ytd-income-value" class="text-sm font-bold text-green-600 dark:text-green-500">{{ currency_symbol }} {{ ytd_metrics.ytd_income|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Savings" %}</span>
                        <span id="ytd-savings-value" class="text-sm font-bold {% if ytd_metrics.ytd_savings >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %}">{{ currency_symbol }} {{ ytd_metrics.ytd_savings|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Investments" %}</span>
                        <span class="text-sm font-bold text-blue-600 dark:text-blue-500">{{ currency_symbol }} {{ ytd_metrics.ytd_investments|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Highest Expense" %}</span>
                        <span class="text-sm font-bold text-red-600 dark:text-red-500" id="metric-highest">$ 0.00</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Income Commitment" %}</span>
                        <span class="text-sm font-bold" id="metric-commitment">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

        <div class="lg:col-span-3 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Expense Flow Groups" %}</h2>
                    {% if member_role_for_period == 'CHILD' %}
                        {% if child_can_create_groups %}
                            <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                                {% trans "Add Group" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                            <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                            {% trans "Add Group" %}
                        </a>
                    {% endif %}
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Group" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Estimated" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                {% if member_role_for_period in 'PARENT,ADMIN' %}
                                    {% trans "Realized" %}
                                {% else %}
                                    {% trans "Spent Total" %}
                                {% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody id="expense-groups-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for group in expense_groups %}
                        <tr {% if group.is_child_group %}style="color: #DAA520;"{% elif not group.is_accessible %}class="opacity-50"{% endif %} data-group-id="{{ group.id }}" data-order="{{ group.order }}" data-accessible="{{ group.is_accessible|yesno:'true,false' }}" data-group-url="{% url 'edit_flow_group' group.id %}{% if selected_period %}?period={{ selected_period }}{% endif %}" draggable="true" class="draggable-row cursor-default hover:bg-gray-50 dark:hover:bg-gray-700/30 {% if group.is_accessible %}group-row-clickable{% endif %}">
                            <td class="px-2 py-4 text-center drag-handle-cell">
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                            </td>
                            <td class="py-4 px-4 text-sm {% if not group.is_child_group and group.is_accessible %}text-[#0d171b] dark:text-white{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% endif %}">
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span>{{ group.name }}</span>
                                        {% if group.is_child_group %}
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-1 rounded-full mobile-hide-badge">{% trans "Child Group" %}</span>
                                        {% endif %}
                                        {% if not group.is_accessible %}
                                            <span class="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full mobile-hide-badge">{% trans "No Access" %}</span>
                                        {% endif %}
                                    </div>
                                    {% if group.budget_warning %}
                                        <div class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">{% trans "⚠ Over budget" %}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif group.budget_warning %}text-yellow-600 dark:text-yellow-500 font-semibold{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-gray-500 dark:text-gray-400{% endif %} text-right group-estimated" data-value="{{ group.total_estimated }}">{{ currency_symbol }} {{ group.total_estimated|intcomma }}</td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif group.is_credit_card and not group.closed %}text-orange-600 dark:text-orange-500 font-semibold{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-red-600 dark:text-red-500{% endif %} text-right group-realized" data-value="{{ group.total_spent|default:'0.00' }}">
                                {% if group.is_kids_group and member_role_for_period in 'PARENT,ADMIN' %}
                                    {% if group.realized %}
                                        {{ group.budgeted_amount|floatformat:2|intcomma }} ( {{ group.child_expenses|default:"0.00"|floatformat:2|intcomma }} )
                                    {% else %}
                                        ({{ currency_symbol }} {{ group.child_expenses|default:"0.00"|floatformat:2|intcomma }})
                                    {% endif %}
                                {% elif group.is_credit_card and not group.closed %}
                                    {{ currency_symbol }} {{ group.credit_card_pending|default:"0.00"|intcomma }} *
                                {% else %}
                                    {{ currency_symbol }} {{ group.total_spent|default:"0.00"|intcomma }}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="py-4 px-4 text-center text-gray-500">{% trans "No expense groups defined. Click \"Add Group\" to start." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Recent Income" %}</h2>
                    <button type="button" data-action="add-new-row" data-type="income" class="flex items-center rounded-lg bg-green-500 text-white text-sm font-medium leading-normal p-2 hover:bg-green-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                        {% trans "Add Income" %}
                    </button>
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Description" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Date" %}</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Amount" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">✓</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="income-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% comment %} Kids Income Entries for CHILD role {% endcomment %}
                        {% if member_role_for_period == 'CHILD' %}
                            {% for kids_income in kids_income_entries %}
                                <tr id="income-item-{{ kids_income.id }}" data-item-id="{{ kids_income.id }}" data-realized="{{ kids_income.realized|yesno:'true,false' }}" data-date="{{ kids_income.date|date:'Y-m-d' }}" data-amount="{{ kids_income.amount }}" data-kids-income="true" class="hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                    <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                        <div class="cell-description-display">{{ kids_income.description }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                        <div class="cell-date-display">{{ kids_income.date|date:"d/m" }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-center">
                                        <button type="button" data-action="show-alert" data-message="{% trans 'Only Parents/Admins can change this status' %}" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-not-allowed opacity-60 {% if kids_income.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}" title="{% trans "Only Parents/Admins can change this" %}">
                                            <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if kids_income.realized %}translate-x-4{% endif %}"></span>
                                        </button>
                                    </td>

                                    <td class="py-3 px-3 text-sm text-right {% if kids_income.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %}">
                                        <div class="cell-amount-display"> {{ kids_income.amount|intcomma }}</div>
                                    </td>

                                    <td class="px-2 py-3 text-center whitespace-nowrap">
                                        <div class="actions-display">
                                            <span class="text-xs text-gray-400">{% trans "Kids Budget" %}</span>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        {% comment %} Regular Income Transactions {% endcomment %}
                        {% for transaction in recent_income_transactions %}
                            <tr id="income-item-{{ transaction.id }}"
                                data-item-id="{{ transaction.id }}"
                                data-mode="display"
                                data-realized="{{ transaction.realized|yesno:'true,false' }}"
                                data-is-fixed="{{ transaction.is_fixed|yesno:'true,false' }}"
                                data-date="{{ transaction.date|date:'Y-m-d' }}"
                                data-amount="{{ transaction.amount.amount }}"
                                class="swipeable-row-income {% if transaction.realized %}row-realized-income{% else %}row-not-realized-income{% endif %} hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="income-item-{{ transaction.id }}">
                                    <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing">drag_indicator</span>
                                    <button type="button" data-action="save" data-item-id="income-item-{{ transaction.id }}" class="edit-save-icon-income" style="display: none;">
                                        <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                    </button>
                                </td>

                                <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                    <div class="cell-description-display">{{ transaction.description }}</div>
                                    <div class="cell-description-edit hidden">
                                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="{{ transaction.description }}">
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                    <div class="cell-date-display">{{ transaction.date|date:"d/m" }}</div>
                                    <div class="cell-date-edit hidden">
                                        <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="{{ transaction.date|date:'Y-m-d' }}">
                                    </div>
                                </td>

                                <td class="py-3 px-3 text-sm text-right {% if transaction.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %} amount-cell-with-actions">
                                    <div class="cell-amount-display">{{ transaction.amount|intcomma }}</div>
                                    <div class="cell-amount-edit hidden">
                                        <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="{{ transaction.amount.amount|floatformat:2 }}">
                                    </div>

                                    <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                                    <div class="mobile-actions-btns-income">
                                        <button type="button" data-action="edit" data-item-id="income-item-{{ transaction.id }}" class="mobile-action-btn-income edit-btn-income">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button type="button" data-action="delete" data-item-id="income-item-{{ transaction.id }}" class="mobile-action-btn-income delete-btn-income">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-center mobile-hide-column">
                                    <button type="button" data-toggle="income-realized" data-item-id="income-item-{{ transaction.id }}" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                        <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-4{% endif %}"></span>
                                    </button>
                                </td>

                                <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                                        <div class="actions-display flex justify-center gap-1">
                                            <button type="button" data-action="edit" data-item-id="income-item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                                            <button type="button" data-action="delete" data-item-id="income-item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                                        </div>
                                        <div class="actions-edit hidden flex justify-center gap-1">
                                            <button type="button" data-action="save" data-item-id="income-item-{{ transaction.id }}" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                            <button type="button" data-action="cancel" data-item-id="income-item-{{ transaction.id }}" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                        </div>
                                </td>
                            </tr>
                        {% empty %}
                            {% if member_role_for_period != 'CHILD' or not kids_income_entries %}
                                <tr id="income-empty-row">
                                    <td colspan="6" class="py-4 px-4 text-center text-gray-500">{% trans "No income transactions recorded yet." %}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} Child Manual Income for PARENTS/ADMINS {% endcomment %}
                        {% if member_role_for_period in 'PARENT,ADMIN' %}
                            {% for child_id, child_data in children_manual_income.items %}
                                <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50 child-manual-income-row relative" data-child-id="{{ child_id }}">
                                    <td class="py-3 px-3 text-sm font-medium" style="color: #DAA520;">
                                        {{ child_data.member.user.first_name|default:child_data.member.user.username }}
                                    </td>
                                    <td class="py-3 px-2 text-xs text-center" style="color: #DAA520;">
                                        <span class="text-xs">{% trans "Manual" %}</span>
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <span class="text-xs text-gray-400">-</span>
                                    </td>
                                    <td class="py-3 px-3 text-sm text-right font-medium" style="color: #DAA520;">
                                        {{ currency_symbol }} {{ child_data.total|intcomma }}
                                    </td>
                                    <td class="px-2 py-3 text-center">
                                        <span class="text-xs" style="color: #DAA520;">{% trans "Child Income" %}</span>
                                    </td>
                                    
                                    {% comment %} Tooltip with transaction details {% endcomment %}
                                    <div class="child-income-tooltip absolute z-50 hidden bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg" style="top: 100%; left: 0; min-width: 300px; margin-top: 4px;">
                                        <div class="font-semibold mb-2 border-b border-gray-700 pb-1">{% blocktrans with name=child_data.member.user.first_name|default:child_data.member.user.username %}{{ name }}'s Manual Income:{% endblocktrans %}</div>
                                        {% for trans in child_data.transactions %}
                                            <div class="flex justify-between py-1">
                                                <span>{{ trans.description }}</span>
                                                <span class="font-medium">{{ currency_symbol }} {{ trans.amount|intcomma }}</span>
                                            </div>
                                        {% endfor %}
                                        <div class="flex justify-between pt-2 mt-2 border-t border-gray-700 font-semibold">
                                            <span>{% trans "Total:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.total|intcomma }}</span>
                                        </div>
                                        <div class="flex justify-between pt-1 text-green-400">
                                            <span>{% trans "Realized:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.realized_total|intcomma }}</span>
                                        </div>
                                    </div>
                                </tr>
                            {% endfor %}
                        {% endif %}                        
                        <tr id="new-income-template" data-item-id="NEW" data-mode="edit" class="swipeable-row-income hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                            <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="new-income-template">
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing" style="display: none;">drag_indicator</span>
                                <button type="button" data-action="save-new-income" class="edit-save-icon-income">
                                    <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                </button>
                            </td>

                            <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                <div class="cell-description-display" style="display: none;"></div>
                                <div class="cell-description-edit">
                                    <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" placeholder="{% trans "Description" %}">
                                </div>
                            </td>

                            <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                <div class="cell-date-display" style="display: none;"></div>
                                <div class="cell-date-edit">
                                    <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="{{ today_date }}" data-display-value="{{ today_date|date:'d/m' }}">
                                </div>
                            </td>

                            <td class="py-3 px-3 text-sm text-right text-gray-400 dark:text-gray-500 amount-cell-with-actions">
                                <div class="cell-amount-display" style="display: none;"></div>
                                <div class="cell-amount-edit">
                                    <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="0{{ decimal_separator }}00">
                                </div>

                                <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                                <div class="mobile-actions-btns-income">
                                    <button type="button" data-action="save-new-income" class="mobile-action-btn-income edit-btn-income">
                                        <span class="material-symbols-outlined">check</span>
                                    </button>
                                    <button type="button" data-action="cancel-new-income" class="mobile-action-btn-income delete-btn-income">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </td>

                            <td class="py-3 px-2 text-center mobile-hide-column">
                                <div class="income-realized-toggle-new relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer">
                                    <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                                </div>
                            </td>

                            <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                                <div class="actions-display" style="display: none;"></div>
                                <div class="actions-edit flex justify-center gap-1">
                                    <button type="button" data-action="save-new-income" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                    <button type="button" data-action="cancel-new-income" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Balance Sheet" %}</h2>
                    <a href="{% url 'bank_reconciliation' %}{% if selected_period %}?period={{ selected_period }}{% endif %}"
                       class="flex items-center rounded-lg bg-primary text-white text-sm font-medium px-3 py-2 hover:bg-primary/80 transition-colors">
                        <span class="material-symbols-outlined text-base mr-1">account_balance</span>
                        {% trans "Bank Reconciliation" %}
                    </a>
                </div> 
                
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white"></td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Estimated" %}</td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Realized" %}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Income" %}</td>
                            <td id="balance-estimated-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_income|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_realized_income|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Expenses" %}</td>
                            <td id="balance-estimated-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_expense|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_realized_expense|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-bold">{% trans "Result" %}</td>
                            <td id="balance-estimated-result" class="py-4 px-4 text-sm {% if summary_totals.estimated_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.estimated_result|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-result" class="py-4 px-4 text-sm {% if summary_totals.realized_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.realized_result|default:"0.00"|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>             
            </div>
        </div> 
    </div>
</div>

<script src="{% static 'finances/js/chart.umd.min.js' %}" defer></script>
<script src="{% static 'finances/js/dashboard.js' %}?v=20260102-001" defer></script>
<script src="{% static 'finances/js/dashboard_realtime.js' %}?v=20260101-001" defer></script>

<!-- REMOVED INLINE SCRIPTS - CSP Phase 3 Complete -->
<!-- All JavaScript code moved to external files for CSP compliance -->
<!-- Original inline script was here (lines 448-2285) - Now in dashboard.js -->

<style>
    /* Mobile-specific CSS for Dashboard */
    @media (max-width: 768px) {
        /* Hide columns on mobile */
        .mobile-hide-column {
            display: none !important;
        }

        /* Hide badges on mobile to save space */
        .mobile-hide-badge {
            display: none !important;
        }

        /* ========== INCOME TABLE MOBILE STYLES ========== */

        /* Swipeable row styles */
        .swipeable-row-income {
            position: relative;
            transition: transform 0.3s ease-out;
            will-change: transform;
        }

        /* Amount cell needs to be positioned to contain absolute buttons */
        .amount-cell-with-actions {
            position: relative;
            overflow: visible;
        }

        /* Mobile actions container (hidden behind row, revealed on swipe left) */
        .mobile-actions-btns-income {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            z-index: 10;
            pointer-events: none;
        }

        .swipeable-row-income.actions-revealed-income .mobile-actions-btns-income {
            pointer-events: auto;
        }

        .mobile-action-btn-income {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
            border: none;
            cursor: pointer;
        }

        .mobile-action-btn-income.edit-btn-income {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-action-btn-income.edit-btn-income:active {
            background-color: #2563eb;
            transform: scale(0.95);
        }

        .mobile-action-btn-income.delete-btn-income {
            background-color: #ef4444;
            color: white;
        }

        .mobile-action-btn-income.delete-btn-income:active {
            background-color: #dc2626;
            transform: scale(0.95);
        }

        /* Realized status visual feedback */
        .row-realized-income {
            background-color: rgba(34, 197, 94, 0.15) !important;
        }

        .dark .row-realized-income {
            background-color: rgba(34, 197, 94, 0.1) !important;
        }

        .row-not-realized-income {
            background-color: rgba(148, 163, 184, 0.08) !important;
        }

        .dark .row-not-realized-income {
            background-color: rgba(148, 163, 184, 0.05) !important;
        }

        /* Disable drag handle on mobile in display mode */
        .drag-handle-cell-income .drag-handle-income {
            cursor: default;
            opacity: 0.3;
        }

        /* Edit save icon styling */
        .edit-save-icon-income {
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
        }

        /* Ensure table doesn't clip buttons */
        #income-items-body {
            overflow: visible;
        }

        tbody tr {
            overflow: visible;
        }

        /* Make date input work as a button - tap anywhere opens calendar */
        .date-input-field-income {
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .date-input-field-income {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Make entire input clickable - calendar icon spans full width */
        .date-input-field-income::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        /* Hide the text but keep input functional */
        .date-input-field-income {
            color: transparent;
            font-size: 0;
        }

        /* Show the actual date value using custom content */
        .date-input-field-income::before {
            content: attr(data-display-value);
            color: #3b82f6;
            font-size: 0.75rem;
            font-weight: 500;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .dark .date-input-field-income::before {
            color: #60a5fa;
        }

        /* Position parent cell for absolute positioning */
        .cell-date-edit {
            position: relative;
        }
    }

    /* Desktop: hide mobile action buttons */
    @media (min-width: 769px) {
        .mobile-actions-btns-income {
            display: none !important;
        }

        .edit-save-icon-income {
            display: none !important;
        }
    }
</style>


{% endblock content %}