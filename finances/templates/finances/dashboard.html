{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load l10n %}

{% block content %}
<div class="p-6 md:p-8 lg:p-10">
    <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm mb-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <!-- Charts Section -->
            <div class="lg:col-span-2 flex flex-col">
                <div class="grid grid-cols-3 gap-3">
                    <div class="flex flex-col">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Top Expenses" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%; overflow: visible;">
                            <div style="position: relative; height: 200px; width: 100%; max-width: 280px;">
                                <canvas id="expensesPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bar Chart -->
                    <div class="flex flex-col col-span-2">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Expense History (Last 12 Periods)" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%;">
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="expensesBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Card -->
            <div class="flex flex-col">
                <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3">{% trans "Key Metrics (YTD)" %}</h3>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3 space-y-2" style="height: 220px;">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Income" %}</span>
                        <span class="text-sm font-bold text-green-600 dark:text-green-500">{{ currency_symbol }} {{ ytd_metrics.ytd_income|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Savings" %}</span>
                        <span class="text-sm font-bold {% if ytd_metrics.ytd_savings >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %}">{{ currency_symbol }} {{ ytd_metrics.ytd_savings|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Investments" %}</span>
                        <span class="text-sm font-bold text-blue-600 dark:text-blue-500">{{ currency_symbol }} {{ ytd_metrics.ytd_investments|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Highest Expense" %}</span>
                        <span class="text-sm font-bold text-red-600 dark:text-red-500" id="metric-highest">$ 0.00</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Income Commitment" %}</span>
                        <span class="text-sm font-bold" id="metric-commitment">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

        <div class="lg:col-span-3 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Expense Flow Groups" %}</h2>
                    {% if member_role_for_period == 'CHILD' %}
                        {% if child_can_create_groups %}
                            <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                                {% trans "Add Group" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                            <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                            {% trans "Add Group" %}
                        </a>
                    {% endif %}
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Group" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Estimated" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                {% if member_role_for_period in 'PARENT,ADMIN' %}
                                    {% trans "Realized" %}
                                {% else %}
                                    {% trans "Spent Total" %}
                                {% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody id="expense-groups-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for group in expense_groups %}
                        <tr {% if group.is_child_group %}style="color: #DAA520;"{% elif not group.is_accessible %}class="opacity-50"{% endif %} data-group-id="{{ group.id }}" data-order="{{ group.order }}" data-accessible="{{ group.is_accessible|yesno:'true,false' }}" data-group-url="{% url 'edit_flow_group' group.id %}{% if selected_period %}?period={{ selected_period }}{% endif %}" draggable="true" class="draggable-row cursor-default hover:bg-gray-50 dark:hover:bg-gray-700/30 {% if group.is_accessible %}group-row-clickable{% endif %}">
                            <td class="px-2 py-4 text-center drag-handle-cell">
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                            </td>
                            <td class="py-4 px-4 text-sm {% if not group.is_child_group and group.is_accessible %}text-[#0d171b] dark:text-white{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% endif %}">
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span>{{ group.name }}</span>
                                        {% if group.is_child_group %}
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-1 rounded-full mobile-hide-badge">{% trans "Child Group" %}</span>
                                        {% endif %}
                                        {% if not group.is_accessible %}
                                            <span class="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full mobile-hide-badge">{% trans "No Access" %}</span>
                                        {% endif %}
                                    </div>
                                    {% if group.budget_warning %}
                                        <div class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">{% trans "⚠ Over budget" %}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif group.budget_warning %}text-yellow-600 dark:text-yellow-500 font-semibold{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-gray-500 dark:text-gray-400{% endif %} text-right group-estimated" data-value="{{ group.total_estimated }}">{{ currency_symbol }} {{ group.total_estimated|intcomma }}</td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-red-600 dark:text-red-500{% endif %} text-right group-realized" data-value="{{ group.total_spent|default:'0.00' }}">
                                {% if group.is_kids_group and member_role_for_period in 'PARENT,ADMIN' %}
                                    {% if group.realized %}
                                        {{ group.budgeted_amount|intcomma }} ( {{ group.child_expenses|default:"0.00"|intcomma }})
                                    {% else %}
                                        ({{ currency_symbol }} {{ group.child_expenses|default:"0.00"|intcomma }})
                                    {% endif %}
                                {% else %}
                                    {{ currency_symbol }} {{ group.total_spent|default:"0.00"|intcomma }}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="py-4 px-4 text-center text-gray-500">{% trans "No expense groups defined. Click \"Add Group\" to start." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Recent Income" %}</h2>
                    <button type="button" onclick="addNewIncomeRow()" class="flex items-center rounded-lg bg-green-500 text-white text-sm font-medium leading-normal p-2 hover:bg-green-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                        {% trans "Add Income" %}
                    </button>
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 35%;">{% trans "Description" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 20%;">{% trans "Date" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 10%;">✓</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 20%;">{% trans "Amount" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 15%;">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="income-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% comment %} Kids Income Entries for CHILD role {% endcomment %}
                        {% if member_role_for_period == 'CHILD' %}
                            {% for kids_income in kids_income_entries %}
                                <tr id="income-item-{{ kids_income.id }}" data-item-id="{{ kids_income.id }}" data-realized="{{ kids_income.realized|yesno:'true,false' }}" data-date="{{ kids_income.date|date:'Y-m-d' }}" data-amount="{{ kids_income.amount }}" data-kids-income="true" class="hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                    <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                        <div class="cell-description-display">{{ kids_income.description }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                        <div class="cell-date-display">{{ kids_income.date|date:"d/m" }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-center">
                                        <button type="button" onclick="alert('{% trans "Only Parents/Admins can change this status" %}')" class="income-realized-toggle relative inline-block w-8 h-5 transition duration-200 ease-in-out rounded-full cursor-not-allowed opacity-60 {% if kids_income.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}" title="{% trans "Only Parents/Admins can change this" %}">
                                            <span class="absolute left-0 inline-block w-3 h-3 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if kids_income.realized %}translate-x-3{% endif %}"></span>
                                        </button>
                                    </td>

                                    <td class="py-3 px-3 text-sm text-right {% if kids_income.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %}">
                                        <div class="cell-amount-display"> {{ kids_income.amount|intcomma }}</div>
                                    </td>

                                    <td class="px-2 py-3 text-center whitespace-nowrap">
                                        <div class="actions-display">
                                            <span class="text-xs text-gray-400">{% trans "Kids Budget" %}</span>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        {% comment %} Regular Income Transactions {% endcomment %}
                        {% for transaction in recent_income_transactions %}
                            <tr id="income-item-{{ transaction.id }}" data-item-id="{{ transaction.id }}" data-realized="{{ transaction.realized|yesno:'true,false' }}" data-date="{{ transaction.date|date:'Y-m-d' }}" data-amount="{{ transaction.amount.amount }}" class="hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                    <div class="cell-description-display">{{ transaction.description }}</div>
                                    <div class="cell-description-edit hidden">
                                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="{{ transaction.description }}">
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                    <div class="cell-date-display">{{ transaction.date|date:"d/m" }}</div>
                                    <div class="cell-date-edit hidden">
                                        <input type="date" data-field="date" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="{{ transaction.date|date:'Y-m-d' }}">
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-center">
                                    <button type="button" onclick="toggleIncomeRealized('income-item-{{ transaction.id }}')" class="income-realized-toggle relative inline-block w-8 h-5 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                        <span class="absolute left-0 inline-block w-3 h-3 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-3{% endif %}"></span>
                                    </button>
                                </td>

                                <td class="py-3 px-3 text-sm text-right {% if transaction.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %}">
                                    <div class="cell-amount-display"> {{ transaction.amount|intcomma }}</div>
                                    <div class="cell-amount-edit hidden">
                                        <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="{{ transaction.amount.amount|floatformat:2 }}">
                                    </div>
                                </td>

                                <td class="px-2 py-3 text-center whitespace-nowrap">
                                        <div class="actions-display flex justify-center gap-1">
                                            <button type="button" onclick="toggleEditMode('income-item-{{ transaction.id }}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                                            <button type="button" onclick="deleteItem('income-item-{{ transaction.id }}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                                        </div>
                                        <div class="actions-edit hidden flex justify-center gap-1">
                                            <button type="button" onclick="saveItem('income-item-{{ transaction.id }}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                            <button type="button" onclick="toggleEditMode('income-item-{{ transaction.id }}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                        </div>
                                </td>
                            </tr>
                        {% empty %}
                            {% if member_role_for_period != 'CHILD' or not kids_income_entries %}
                                <tr id="income-empty-row">
                                    <td colspan="5" class="py-4 px-4 text-center text-gray-500">{% trans "No income transactions recorded yet." %}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} Child Manual Income for PARENTS/ADMINS {% endcomment %}
                        {% if member_role_for_period in 'PARENT,ADMIN' %}
                            {% for child_id, child_data in children_manual_income.items %}
                                <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50 child-manual-income-row relative" data-child-id="{{ child_id }}">
                                    <td class="py-3 px-3 text-sm font-medium" style="color: #DAA520;">
                                        {{ child_data.member.user.first_name|default:child_data.member.user.username }}
                                    </td>
                                    <td class="py-3 px-2 text-xs text-center" style="color: #DAA520;">
                                        <span class="text-xs">{% trans "Manual" %}</span>
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <span class="text-xs text-gray-400">-</span>
                                    </td>
                                    <td class="py-3 px-3 text-sm text-right font-medium" style="color: #DAA520;">
                                        {{ currency_symbol }} {{ child_data.total|intcomma }}
                                    </td>
                                    <td class="px-2 py-3 text-center">
                                        <span class="text-xs" style="color: #DAA520;">{% trans "Child Income" %}</span>
                                    </td>
                                    
                                    {% comment %} Tooltip with transaction details {% endcomment %}
                                    <div class="child-income-tooltip absolute z-50 hidden bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg" style="top: 100%; left: 0; min-width: 300px; margin-top: 4px;">
                                        <div class="font-semibold mb-2 border-b border-gray-700 pb-1">{% blocktrans with name=child_data.member.user.first_name|default:child_data.member.user.username %}{{ name }}'s Manual Income:{% endblocktrans %}</div>
                                        {% for trans in child_data.transactions %}
                                            <div class="flex justify-between py-1">
                                                <span>{{ trans.description }}</span>
                                                <span class="font-medium">{{ currency_symbol }} {{ trans.amount|intcomma }}</span>
                                            </div>
                                        {% endfor %}
                                        <div class="flex justify-between pt-2 mt-2 border-t border-gray-700 font-semibold">
                                            <span>{% trans "Total:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.total|intcomma }}</span>
                                        </div>
                                        <div class="flex justify-between pt-1 text-green-400">
                                            <span>{% trans "Realized:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.realized_total|intcomma }}</span>
                                        </div>
                                    </div>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        
                        <tr id="new-income-template" data-item-id="NEW" data-mode="edit" class="hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                            <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" placeholder="{% trans "Description" %}">
                            </td>

                            <td class="py-3 px-2 text-xs text-gray-500">
                                <input type="date" data-field="date" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="{{ today_date }}">
                            </td>

                            <td class="py-3 px-2 text-center">
                                <div class="income-realized-toggle-new relative inline-block w-8 h-5 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer">
                                    <span class="absolute left-0 inline-block w-3 h-3 mt-1 ml-1 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                                </div>
                            </td>

                            <td class="py-3 px-3 text-right" colspan="2">
                                <div class="flex items-center justify-end gap-2">
                                    <input type="number" step="0.01" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="0.00">
                                    <button type="button" onclick="saveIncomeItem('new-income-template')" class="p-1 text-green-500 hover:text-green-600"><span class="material-symbols-outlined text-base">check</span></button>
                                    <button type="button" onclick="cancelNewIncomeRow('new-income-template')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-base">close</span></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Balance Sheet" %}</h2>
                    <a href="{% url 'bank_reconciliation' %}{% if selected_period %}?period={{ selected_period }}{% endif %}"
                       class="flex items-center rounded-lg bg-primary text-white text-sm font-medium px-3 py-2 hover:bg-primary/80 transition-colors">
                        <span class="material-symbols-outlined text-base mr-1">account_balance</span>
                        {% trans "Bank Reconciliation" %}
                    </a>
                </div> 
                
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white"></td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Estimated" %}</td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Realized" %}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Income" %}</td>
                            <td id="balance-estimated-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_income|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_realized_income|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Expenses" %}</td>
                            <td id="balance-estimated-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_expense|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_realized_expense|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-bold">{% trans "Result" %}</td>
                            <td id="balance-estimated-result" class="py-4 px-4 text-sm {% if summary_totals.estimated_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.estimated_result|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-result" class="py-4 px-4 text-sm {% if summary_totals.realized_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.realized_result|default:"0.00"|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>             
            </div>
        </div> 
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Utility for getting CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Income flow group ID (passed from backend)
    const incomeFlowGroupId = "{{ income_flow_group_id }}";
    
    // Member role (for conditional logic)
    const memberRoleForPeriod = "{{ member_role_for_period }}";

    // Locale-specific separators from backend
    const decimalSeparator = "{{ decimal_separator }}";
    const thousandSeparator = "{{ thousand_separator }}";

    // Function to format number as currency for display
    function formatCurrency(amount) {
        // Parse the amount to ensure it's a number
        const num = parseFloat(amount);
        if (isNaN(num)) return amount;

        // Format to 2 decimal places
        const parts = num.toFixed(2).split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1];

        // Add thousand separators to integer part
        const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

        // Combine with decimal separator
        return formattedInteger + decimalSeparator + decimalPart;
    }

    // === CHARTS INITIALIZATION ===
    
    // Chart.js default colors
    const chartColors = [
        'rgb(239, 68, 68)',   // red-500
        'rgb(249, 115, 22)',  // orange-500
        'rgb(234, 179, 8)',   // yellow-500
        'rgb(34, 197, 94)',   // green-500
        'rgb(59, 130, 246)',  // blue-500
        'rgb(168, 85, 247)',  // purple-500
        'rgb(236, 72, 153)',  // pink-500
    ];
    
    let pieChart, barChart;
    
    // Initialize Pie Chart
    function initPieChart() {
        const ctx = document.getElementById('expensesPieChart');
        if (!ctx) return;
        
        const expenseData = getTop3ExpensesData();
        
        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: expenseData.labels,
                datasets: [{
                    data: expenseData.values,
                    backgroundColor: chartColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: $${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 5,
                        right: 5,
                        top: 5,
                        bottom: 5
                    }
                }
            }
        });
    }
    
    // Calculate linear regression for trend line
    function calculateTrendLine(values) {
        const n = values.length;
        if (n === 0) return [];
        
        const xValues = values.map((_, i) => i);
        const sumX = xValues.reduce((a, b) => a + b, 0);
        const sumY = values.reduce((a, b) => a + b, 0);
        const sumXY = xValues.reduce((sum, x, i) => sum + x * values[i], 0);
        const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        return xValues.map(x => slope * x + intercept);
    }
    
    // Initialize Bar Chart with dynamic colors and trend line
    function initBarChart() {
        const ctx = document.getElementById('expensesBarChart');
        if (!ctx) return;
        
        const barData = {{ periods_history_json|safe }};
        
        // Calculate bar colors based on income commitment
        const barColors = barData.colors || barData.values.map(() => 'rgb(239, 68, 68)');
        
        // Calculate trend line
        const trendLine = calculateTrendLine(barData.values);
        
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: barData.labels,
                datasets: [
                    {
                        label: '{% trans "Total Expenses" %}',
                        data: barData.values,
                        backgroundColor: barColors,
                        borderColor: barColors.map(color => color.replace('rgb', 'rgba').replace(')', ', 0.8)')),
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "Trend" %}',
                        data: trendLine,
                        type: 'line',
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 9
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 10
                            },
                            boxWidth: 12,
                            padding: 8
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Total: $' + formatCurrency(context.parsed.y);
                                } else {
                                    return 'Trend: $' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 5,
                        right: 5,
                        top: 5,
                        bottom: 5
                    }
                }
            }
        });
    }
    
    // Get Top 3 Expenses Data (based on realized values only)
    function getTop3ExpensesData() {
        const expenseRows = document.querySelectorAll('tbody tr[data-group-id]');
        const expenses = [];

        expenseRows.forEach(row => {
            // Get the first cell (after drag handle) which contains the group name
            const nameCell = row.querySelectorAll('td')[1]; // Second td (index 1)
            const nameText = nameCell.textContent.trim();
            // Get only the first line (group name) before any badges/labels
            const name = nameText.split('\n')[0].trim();

            // Use only realized values for the chart
            const realizedValue = parseFloat(row.querySelector('.group-realized').getAttribute('data-value')) || 0;

            if (realizedValue > 0) {
                expenses.push({ name, value: realizedValue });
            }
        });

        // Sort by value descending
        expenses.sort((a, b) => b.value - a.value);

        // Get top 3
        const top3 = expenses.slice(0, 3);
        const others = expenses.slice(3).reduce((sum, item) => sum + item.value, 0);

        const labels = top3.map(e => e.name);
        const values = top3.map(e => e.value);

        if (others > 0) {
            labels.push('{% trans "Others" %}');
            values.push(others);
        }

        return { labels, values };
    }
    
    // Update Pie Chart
    function updatePieChart() {
        if (!pieChart) return;
        
        const expenseData = getTop3ExpensesData();
        pieChart.data.labels = expenseData.labels;
        pieChart.data.datasets[0].data = expenseData.values;
        pieChart.update('none');
    }
    
    // Update metrics card (only dynamic values)
    function updateMetrics() {
        // Highest expense (from current period)
        const expenseRows = document.querySelectorAll('tbody tr[data-group-id]');
        let highestExpense = 0;
        expenseRows.forEach(row => {
            const realizedValue = parseFloat(row.querySelector('.group-realized').getAttribute('data-value')) || 0;
            if (realizedValue > highestExpense) {
                highestExpense = realizedValue;
            }
        });
        document.getElementById('metric-highest').textContent = '$ ' + formatCurrency(highestExpense);

        // Current commitment percentage (current period only)
        const incomeElem = document.getElementById('balance-realized-income');
        const expenseElem = document.getElementById('balance-realized-expense');

        if (!incomeElem || !expenseElem) {
            console.error('Balance elements not found');
            return;
        }

        // Remove all non-numeric characters except decimal point and minus sign
        const realizedIncomeText = incomeElem.textContent.replace(/[^\d.-]/g, '');
        const realizedExpenseText = expenseElem.textContent.replace(/[^\d.-]/g, '');

        const realizedIncome = parseFloat(realizedIncomeText) || 0;
        const realizedExpense = parseFloat(realizedExpenseText) || 0;

        const commitment = realizedIncome > 0 ? (realizedExpense / realizedIncome * 100) : 0;
        const commitmentElem = document.getElementById('metric-commitment');
        commitmentElem.textContent = commitment.toFixed(1) + '%';

        if (commitment >= 98) {
            commitmentElem.classList.remove('text-green-600', 'dark:text-green-500', 'text-yellow-600', 'dark:text-yellow-500');
            commitmentElem.classList.add('text-red-600', 'dark:text-red-500');
        } else if (commitment >= 90) {
            commitmentElem.classList.remove('text-green-600', 'dark:text-green-500', 'text-red-600', 'dark:text-red-500');
            commitmentElem.classList.add('text-yellow-600', 'dark:text-yellow-500');
        } else {
            commitmentElem.classList.remove('text-red-600', 'dark:text-red-500', 'text-yellow-600', 'dark:text-yellow-500');
            commitmentElem.classList.add('text-green-600', 'dark:text-green-500');
        }
    }
    
    // Initialize charts on page load
    document.addEventListener('DOMContentLoaded', function() {
        initPieChart();
        initBarChart();
        updateMetrics();
    });
    
    // === END CHARTS ===

    // Function to update balance sheet
    function updateBalanceSheet() {
        // Calculate totals from all income rows (excluding kids income for children)
        let estimatedIncome = 0;
        let realizedIncome = 0;
        
        document.querySelectorAll('#income-items-body tr[data-item-id]').forEach(row => {
            if (row.id === 'new-income-template' || row.id === 'income-empty-row') return;
            
            // Skip child manual income rows in balance calculation
            if (row.classList.contains('child-manual-income-row')) return;
            
            const amount = parseFloat(row.getAttribute('data-amount')) || 0;
            const isRealized = row.getAttribute('data-realized') === 'true';
            
            estimatedIncome += amount;
            if (isRealized) {
                realizedIncome += amount;
            }
        });
        
        // Update balance display
        document.getElementById('balance-estimated-income').textContent = '$ ' + formatCurrency(estimatedIncome);
        document.getElementById('balance-realized-income').textContent = '$ ' + formatCurrency(realizedIncome);
        
        // Get expense values (already set from backend)
        const estimatedExpenseText = document.getElementById('balance-estimated-expense').textContent.replace('$', '').replace(/,/g, '').trim();
        const realizedExpenseText = document.getElementById('balance-realized-expense').textContent.replace('$', '').replace(/,/g, '').trim();
        const estimatedExpense = parseFloat(estimatedExpenseText) || 0;
        const realizedExpense = parseFloat(realizedExpenseText) || 0;
        
        // Calculate results
        const estimatedResult = estimatedIncome - estimatedExpense;
        const realizedResult = realizedIncome - realizedExpense;
        
        // Update result cells
        const estResultCell = document.getElementById('balance-estimated-result');
        const realResultCell = document.getElementById('balance-realized-result');
        
        estResultCell.textContent = '$ ' + formatCurrency(estimatedResult);
        realResultCell.textContent = '$ ' + formatCurrency(realizedResult);
        
        // Update colors
        if (estimatedResult >= 0) {
            estResultCell.className = 'py-4 px-4 text-sm text-green-600 dark:text-green-500 font-bold';
        } else {
            estResultCell.className = 'py-4 px-4 text-sm text-red-600 dark:text-red-500 font-bold';
        }
        
        if (realizedResult >= 0) {
            realResultCell.className = 'py-4 px-4 text-sm text-green-600 dark:text-green-500 font-bold';
        } else {
            realResultCell.className = 'py-4 px-4 text-sm text-red-600 dark:text-red-500 font-bold';
        }
        
        // Update metrics
        updateMetrics();
    }

    // Function to add a new income row
    function addNewIncomeRow() {
        const emptyRow = document.getElementById('income-empty-row');
        if (emptyRow) {
            emptyRow.remove();
        }
        
        const templateRow = document.getElementById('new-income-template');
        if (templateRow && templateRow.classList.contains('hidden')) {
            templateRow.classList.remove('hidden');
            templateRow.querySelector('input[data-field="description"]').focus();
        } else if (templateRow) {
            templateRow.querySelector('input[data-field="description"]').focus();
        }
    }
    
    // Function to toggle income realized status
    function toggleIncomeRealized(rowId) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') return;
        
        // Check if this is a kids income (should not be toggled)
        if (row.getAttribute('data-kids-income') === 'true') {
            alert('{% trans "Only Parents/Admins can change this status" %}');
            return;
        }
        
        // Get current status from data attribute
        const currentStatus = row.getAttribute('data-realized') === 'true';
        const newStatus = !currentStatus;
        
        // Get other field values
        const description = row.querySelector('.cell-description-display').textContent.trim();
        const fullDate = row.getAttribute('data-date');
        const amount = row.getAttribute('data-amount');
        
        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': transactionId,
            'description': description,
            'amount': amount,
            'date': fullDate,
            'realized': newStatus,
        };

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = row.querySelector('.income-realized-toggle');
                const toggleCircle = toggleBtn.querySelector('span');
                const amountCell = row.querySelector('.cell-amount-display').parentElement;
                
                // Update data attribute
                row.setAttribute('data-realized', data.realized ? 'true' : 'false');
                
                if (data.realized) {
                    toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    toggleBtn.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-3');
                    amountCell.classList.remove('text-gray-400', 'dark:text-gray-500');
                    amountCell.classList.add('text-green-600', 'dark:text-green-500');
                } else {
                    toggleBtn.classList.remove('bg-green-500');
                    toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-3');
                    amountCell.classList.remove('text-green-600', 'dark:text-green-500');
                    amountCell.classList.add('text-gray-400', 'dark:text-gray-500');
                }
                
                // Update balance sheet
                updateBalanceSheet();
            } else {
                alert('{% trans "Error updating income status:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to save new income item
    function saveIncomeItem(rowId) {
        const row = document.getElementById(rowId);
        
        // Check toggle state
        const toggleNew = row.querySelector('.income-realized-toggle-new');
        const realizedValue = toggleNew.classList.contains('bg-green-500');
        
        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': null,
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': row.querySelector('input[data-field="amount"]').value,
            'date': row.querySelector('input[data-field="date"]').value,
            'realized': realizedValue,
            'is_child_manual': memberRoleForPeriod === 'CHILD',  // Flag for child manual income
        };
        
        if (!data.description || !data.amount || !data.date) {
            alert("{% trans 'Description, Amount, and Date are required.' %}");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('{% trans "Error saving income:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }
    
    // Function to cancel new income row
    function cancelNewIncomeRow(rowId) {
        const row = document.getElementById(rowId);
        row.classList.add('hidden');
        row.querySelector('input[data-field="description"]').value = '';
        row.querySelector('input[data-field="amount"]').value = '0.00';
        
        // Reset toggle
        const toggleNew = row.querySelector('.income-realized-toggle-new');
        const toggleCircle = toggleNew.querySelector('span');
        toggleNew.classList.remove('bg-green-500');
        toggleNew.classList.add('bg-gray-300', 'dark:bg-gray-600');
        toggleCircle.classList.remove('translate-x-3');
    }
    
    // Add click handler for new income toggle
    document.addEventListener('DOMContentLoaded', function() {
        const toggleNew = document.querySelector('.income-realized-toggle-new');
        if (toggleNew) {
            toggleNew.addEventListener('click', function() {
                const toggleCircle = this.querySelector('span');
                if (this.classList.contains('bg-green-500')) {
                    this.classList.remove('bg-green-500');
                    this.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-3');
                } else {
                    this.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    this.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-3');
                }
            });
        }
        
        // Tooltip functionality for child manual income
        const childIncomeRows = document.querySelectorAll('.child-manual-income-row');
        childIncomeRows.forEach(row => {
            const tooltip = row.querySelector('.child-income-tooltip');
            
            row.addEventListener('mouseenter', function() {
                tooltip.classList.remove('hidden');
            });
            
            row.addEventListener('mouseleave', function() {
                tooltip.classList.add('hidden');
            });
        });
    });

    // Function to delete an item
    function deleteItem(rowId) {
        if (!confirm('{% trans "Are you sure you want to delete this item?" %}')) return;
        
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') {
            cancelNewRow(rowId);
            return;
        }

        fetch("{% url 'delete_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({'transaction_id': transactionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                row.remove();
                updateBalanceSheet();
                updatePieChart();
            } else {
                alert('{% trans "Error deleting item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to format amount for input field based on user's locale
    function formatAmountForInput(amount) {
        // Convert to number and format with 2 decimals
        const num = parseFloat(amount);
        if (isNaN(num)) return amount;

        // Format to 2 decimal places and replace decimal separator
        // decimalSeparator comes from backend template context
        return num.toFixed(2).replace('.', decimalSeparator);
    }

    // Function to toggle between display and edit mode
    function toggleEditMode(rowId, startEdit) {
        const row = document.getElementById(rowId);
        if (!row) return;

        const displayElements = row.querySelectorAll('.actions-display, .cell-description-display, .cell-date-display, .cell-amount-display');
        const editElements = row.querySelectorAll('.actions-edit, .cell-description-edit, .cell-date-edit, .cell-amount-edit');

        displayElements.forEach(el => el.classList.toggle('hidden', startEdit));
        editElements.forEach(el => el.classList.toggle('hidden', !startEdit));

        row.setAttribute('data-mode', startEdit ? 'edit' : 'display');
        if(startEdit) {
             row.querySelector('.cell-description-edit input').focus();
        }
    }

    // Function to save edited item
    function saveItem(rowId) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        const realizedStatus = row.getAttribute('data-realized') === 'true';
        
        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': transactionId,
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': row.querySelector('input[data-field="amount"]').value,
            'date': row.querySelector('input[data-field="date"]').value,
            'realized': realizedStatus,
        };
        
        if (!data.description || !data.amount || !data.date) {
            alert("{% trans 'Description, Amount, and Date are required.' %}");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update row data
                row.setAttribute('data-amount', data.amount);
                row.querySelector('.cell-description-display').textContent = data.description;
                // Use currency_symbol from backend response
                const currencySymbol = data.currency_symbol || '{{ currency_symbol }}';
                row.querySelector('.cell-amount-display').textContent = currencySymbol + ' ' + formatCurrency(data.amount);
                row.querySelector('.cell-date-display').textContent = new Date(data.date).toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'});
                
                // Update inputs
                row.querySelector('input[data-field="description"]').value = data.description;
                row.querySelector('input[data-field="amount"]').value = formatAmountForInput(data.amount);
                row.querySelector('input[data-field="date"]').value = data.date;
                row.setAttribute('data-date', data.date);
                
                toggleEditMode(rowId, false);
                updateBalanceSheet();
            } else {
                alert('{% trans "Error saving item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }
    
    // === DRAG AND DROP REORDERING FOR EXPENSE GROUPS ===
    
    let draggedRow = null;
    let draggedOverRow = null;
    
    // Initialize drag and drop on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
        initializeClickableRows();
    });
    
    function initializeDragAndDrop() {
        const tbody = document.getElementById('expense-groups-tbody');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.draggable-row');

        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });
    }

    function initializeClickableRows() {
        const tbody = document.getElementById('expense-groups-tbody');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.group-row-clickable');

        rows.forEach(row => {
            // Make row clickable (except drag handle)
            row.addEventListener('click', function(e) {
                // Don't navigate if clicking on drag handle
                if (e.target.closest('.drag-handle-cell') || e.target.closest('.drag-handle')) {
                    return;
                }

                const url = this.getAttribute('data-group-url');
                if (url) {
                    window.location.href = url;
                }
            });

            // Add cursor pointer on hover (except drag handle)
            row.addEventListener('mouseover', function(e) {
                if (!e.target.closest('.drag-handle-cell') && !e.target.closest('.drag-handle')) {
                    this.style.cursor = 'pointer';
                }
            });

            row.addEventListener('mouseout', function(e) {
                this.style.cursor = 'default';
            });
        });

        // Prevent drag on non-drag-handle clicks
        const dragHandles = tbody.querySelectorAll('.drag-handle');
        dragHandles.forEach(handle => {
            handle.addEventListener('mousedown', function(e) {
                const row = this.closest('tr');
                if (row) {
                    row.setAttribute('draggable', 'true');
                }
            });
        });

        // Disable dragging when not on handle
        rows.forEach(row => {
            row.addEventListener('mousedown', function(e) {
                if (!e.target.closest('.drag-handle-cell') && !e.target.closest('.drag-handle')) {
                    this.setAttribute('draggable', 'false');
                } else {
                    this.setAttribute('draggable', 'true');
                }
            });
        });
    }
    
    function handleDragStart(e) {
        draggedRow = this;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragEnter(e) {
        if (this !== draggedRow) {
            this.classList.add('border-t-2', 'border-primary');
            draggedOverRow = this;
        }
    }
    
    function handleDragLeave(e) {
        this.classList.remove('border-t-2', 'border-primary');
    }
    
    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        if (draggedRow !== this) {
            // Get the tbody
            const tbody = document.getElementById('expense-groups-tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));
            
            const draggedIndex = allRows.indexOf(draggedRow);
            const targetIndex = allRows.indexOf(this);
            
            // Move the dragged row
            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedRow, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedRow, this);
            }
            
            // Save new order to backend
            saveGroupsOrder();
        }
        
        return false;
    }
    
    function handleDragEnd(e) {
        this.style.opacity = '1';
        
        // Remove all drag-related classes
        const rows = document.querySelectorAll('tr.draggable-row');
        rows.forEach(row => {
            row.classList.remove('border-t-2', 'border-primary');
        });
        
        draggedRow = null;
        draggedOverRow = null;
    }
    
    function saveGroupsOrder() {
        const tbody = document.getElementById('expense-groups-tbody');
        const rows = tbody.querySelectorAll('tr.draggable-row');
        
        const orderData = [];
        rows.forEach((row, index) => {
            const groupId = row.getAttribute('data-group-id');
            orderData.push({
                id: groupId,
                order: index + 1
            });
        });
        
        fetch("{% url 'reorder_flow_groups_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ groups: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Order saved successfully');
                // Optionally update pie chart if order affects display
                updatePieChart();
            } else {
                console.error('Error saving order:', data.error);
                alert('{% trans "Error saving order:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred while saving order." %}');
        });
    }

    // Mobile date input optimization for Recent Income
    (function initMobileDateInputs() {
        'use strict';

        const isMobile = window.matchMedia('(max-width: 768px)').matches;

        if (!isMobile) {
            return; // Only run on mobile devices
        }

        console.log('[MOBILE INCOME] Initializing mobile date inputs');

        // Add change event listener to all income date inputs to update display value
        const dateInputs = document.querySelectorAll('.date-input-field-income');
        dateInputs.forEach(input => {
            // Set initial display value
            const dateValue = input.value; // YYYY-MM-DD format
            if (dateValue) {
                const [year, month, day] = dateValue.split('-');
                const displayValue = `${day}/${month}`;
                input.setAttribute('data-display-value', displayValue);
            }

            // Update display value when date changes
            input.addEventListener('change', function() {
                const dateValue = this.value; // YYYY-MM-DD format
                if (dateValue) {
                    const [year, month, day] = dateValue.split('-');
                    const displayValue = `${day}/${month}`;
                    this.setAttribute('data-display-value', displayValue);
                    console.log('[MOBILE INCOME DATE] Updated display value:', displayValue);
                }
            });
        });
    })();
</script>

<style>
    /* Mobile-specific CSS for Dashboard */
    @media (max-width: 768px) {
        /* Hide badges on mobile to save space */
        .mobile-hide-badge {
            display: none !important;
        }

        /* Make date input work as a button - tap anywhere opens calendar */
        .date-input-field-income {
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .date-input-field-income {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Make entire input clickable - calendar icon spans full width */
        .date-input-field-income::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        /* Hide the text but keep input functional */
        .date-input-field-income {
            color: transparent;
            font-size: 0;
        }

        /* Show the actual date value using custom content */
        .date-input-field-income::before {
            content: attr(data-display-value);
            color: #3b82f6;
            font-size: 0.75rem;
            font-weight: 500;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .dark .date-input-field-income::before {
            color: #60a5fa;
        }

        /* Position parent cell for absolute positioning */
        .cell-date-edit {
            position: relative;
        }
    }
</style>

{% endblock content %}
