{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}
{% load l10n %}

{% block content %}
<div class="p-6 md:p-8 lg:p-10">
    <div class="bg-white dark:bg-gray-800 p-3 rounded-xl shadow-sm mb-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <!-- Charts Section -->
            <div class="lg:col-span-2 flex flex-col">
                <div class="grid grid-cols-3 gap-3">
                    <div class="flex flex-col">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Top Expenses" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%; overflow: visible;">
                            <div style="position: relative; height: 200px; width: 100%; max-width: 280px;">
                                <canvas id="expensesPieChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bar Chart -->
                    <div class="flex flex-col col-span-2">
                        <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3 text-center">{% trans "Expense History (Last 12 Periods)" %}</h3>
                        <div class="flex items-center justify-center" style="height: 220px; width: 100%;">
                            <div style="position: relative; height: 200px; width: 100%;">
                                <canvas id="expensesBarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Card -->
            <div class="flex flex-col">
                <h3 class="text-lg font-semibold text-[#0d171b] dark:text-white mb-3">{% trans "Key Metrics (YTD)" %}</h3>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-3 space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Income" %}</span>
                        <span class="text-sm font-bold text-green-600 dark:text-green-500">{{ currency_symbol }} {{ ytd_metrics.ytd_income|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Savings" %}</span>
                        <span class="text-sm font-bold {% if ytd_metrics.ytd_savings >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %}">{{ currency_symbol }} {{ ytd_metrics.ytd_savings|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "YTD Investments" %}</span>
                        <span class="text-sm font-bold text-blue-600 dark:text-blue-500">{{ currency_symbol }} {{ ytd_metrics.ytd_investments|floatformat:2|intcomma }}</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Highest Expense" %}</span>
                        <span class="text-sm font-bold text-red-600 dark:text-red-500" id="metric-highest">$ 0.00</span>
                    </div>
                    <div class="h-px bg-gray-300 dark:bg-gray-600"></div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400">{% trans "Income Commitment" %}</span>
                        <span class="text-sm font-bold" id="metric-commitment">0%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

        <div class="lg:col-span-3 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Expense Flow Groups" %}</h2>
                    {% if member_role_for_period == 'CHILD' %}
                        {% if child_can_create_groups %}
                            <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                                <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                                {% trans "Add Group" %}
                            </a>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'add_flow_group' %}{% if selected_period %}?period={{ selected_period }}{% endif %}" class="flex items-center rounded-lg bg-red-500 text-white text-sm font-medium leading-normal p-2 hover:bg-red-600 transition-colors shadow-sm">
                            <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                            {% trans "Add Group" %}
                        </a>
                    {% endif %}
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Group" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Estimated" %}</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                {% if member_role_for_period in 'PARENT,ADMIN' %}
                                    {% trans "Realized" %}
                                {% else %}
                                    {% trans "Spent Total" %}
                                {% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody id="expense-groups-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% for group in expense_groups %}
                        <tr {% if group.is_child_group %}style="color: #DAA520;"{% elif not group.is_accessible %}class="opacity-50"{% endif %} data-group-id="{{ group.id }}" data-order="{{ group.order }}" data-accessible="{{ group.is_accessible|yesno:'true,false' }}" data-group-url="{% url 'edit_flow_group' group.id %}{% if selected_period %}?period={{ selected_period }}{% endif %}" draggable="true" class="draggable-row cursor-default hover:bg-gray-50 dark:hover:bg-gray-700/30 {% if group.is_accessible %}group-row-clickable{% endif %}">
                            <td class="px-2 py-4 text-center drag-handle-cell">
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                            </td>
                            <td class="py-4 px-4 text-sm {% if not group.is_child_group and group.is_accessible %}text-[#0d171b] dark:text-white{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% endif %}">
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <span>{{ group.name }}</span>
                                        {% if group.is_child_group %}
                                            <span class="text-xs bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300 px-2 py-1 rounded-full mobile-hide-badge">{% trans "Child Group" %}</span>
                                        {% endif %}
                                        {% if not group.is_accessible %}
                                            <span class="text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full mobile-hide-badge">{% trans "No Access" %}</span>
                                        {% endif %}
                                    </div>
                                    {% if group.budget_warning %}
                                        <div class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">{% trans "⚠ Over budget" %}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif group.budget_warning %}text-yellow-600 dark:text-yellow-500 font-semibold{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-gray-500 dark:text-gray-400{% endif %} text-right group-estimated" data-value="{{ group.total_estimated }}">{{ currency_symbol }} {{ group.total_estimated|intcomma }}</td>
                            <td class="py-4 px-4 text-sm {% if group.is_child_group %}font-medium{% elif group.is_credit_card and not group.closed %}text-orange-600 dark:text-orange-500 font-semibold{% elif not group.is_accessible %}text-gray-400 dark:text-gray-500{% else %}text-red-600 dark:text-red-500{% endif %} text-right group-realized" data-value="{{ group.total_spent|default:'0.00' }}">
                                {% if group.is_kids_group and member_role_for_period in 'PARENT,ADMIN' %}
                                    {% if group.realized %}
                                        {{ group.budgeted_amount|intcomma }} ( {{ group.child_expenses|default:"0.00"|intcomma }} )
                                    {% else %}
                                        ({{ currency_symbol }} {{ group.child_expenses|default:"0.00"|intcomma }})
                                    {% endif %}
                                {% elif group.is_credit_card and not group.closed %}
                                    {{ currency_symbol }} {{ group.credit_card_pending|default:"0.00"|intcomma }} *
                                {% else %}
                                    {{ currency_symbol }} {{ group.total_spent|default:"0.00"|intcomma }}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="py-4 px-4 text-center text-gray-500">{% trans "No expense groups defined. Click \"Add Group\" to start." %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Recent Income" %}</h2>
                    <button type="button" onclick="addNewIncomeRow()" class="flex items-center rounded-lg bg-green-500 text-white text-sm font-medium leading-normal p-2 hover:bg-green-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined text-lg mr-1">add_circle</span>
                        {% trans "Add Income" %}
                    </button>
                </div>
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead>
                        <tr>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider" style="width: 40px;"></th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Description" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Date" %}</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">{% trans "Amount" %}</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">✓</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mobile-hide-column">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="income-items-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                        {% comment %} Kids Income Entries for CHILD role {% endcomment %}
                        {% if member_role_for_period == 'CHILD' %}
                            {% for kids_income in kids_income_entries %}
                                <tr id="income-item-{{ kids_income.id }}" data-item-id="{{ kids_income.id }}" data-realized="{{ kids_income.realized|yesno:'true,false' }}" data-date="{{ kids_income.date|date:'Y-m-d' }}" data-amount="{{ kids_income.amount }}" data-kids-income="true" class="hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                    <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                        <div class="cell-description-display">{{ kids_income.description }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                        <div class="cell-date-display">{{ kids_income.date|date:"d/m" }}</div>
                                    </td>

                                    <td class="py-3 px-2 text-center">
                                        <button type="button" onclick="alert('{% trans "Only Parents/Admins can change this status" %}')" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-not-allowed opacity-60 {% if kids_income.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}" title="{% trans "Only Parents/Admins can change this" %}">
                                            <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if kids_income.realized %}translate-x-4{% endif %}"></span>
                                        </button>
                                    </td>

                                    <td class="py-3 px-3 text-sm text-right {% if kids_income.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %}">
                                        <div class="cell-amount-display"> {{ kids_income.amount|intcomma }}</div>
                                    </td>

                                    <td class="px-2 py-3 text-center whitespace-nowrap">
                                        <div class="actions-display">
                                            <span class="text-xs text-gray-400">{% trans "Kids Budget" %}</span>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        {% comment %} Regular Income Transactions {% endcomment %}
                        {% for transaction in recent_income_transactions %}
                            <tr id="income-item-{{ transaction.id }}"
                                data-item-id="{{ transaction.id }}"
                                data-mode="display"
                                data-realized="{{ transaction.realized|yesno:'true,false' }}"
                                data-is-fixed="{{ transaction.is_fixed|yesno:'true,false' }}"
                                data-date="{{ transaction.date|date:'Y-m-d' }}"
                                data-amount="{{ transaction.amount.amount }}"
                                class="swipeable-row-income {% if transaction.realized %}row-realized-income{% else %}row-not-realized-income{% endif %} hover:bg-slate-50 dark:hover:bg-gray-700/50">

                                <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="income-item-{{ transaction.id }}">
                                    <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing">drag_indicator</span>
                                    <button type="button" onclick="saveItem('income-item-{{ transaction.id }}')" class="edit-save-icon-income" style="display: none;">
                                        <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                    </button>
                                </td>

                                <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                    <div class="cell-description-display">{{ transaction.description }}</div>
                                    <div class="cell-description-edit hidden">
                                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="{{ transaction.description }}">
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                    <div class="cell-date-display">{{ transaction.date|date:"d/m" }}</div>
                                    <div class="cell-date-edit hidden">
                                        <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="{{ transaction.date|date:'Y-m-d' }}">
                                    </div>
                                </td>

                                <td class="py-3 px-3 text-sm text-right {% if transaction.realized %}text-green-600 dark:text-green-500{% else %}text-gray-400 dark:text-gray-500{% endif %} amount-cell-with-actions">
                                    <div class="cell-amount-display">{{ transaction.amount|intcomma }}</div>
                                    <div class="cell-amount-edit hidden">
                                        <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="{{ transaction.amount.amount|floatformat:2 }}">
                                    </div>

                                    <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                                    <div class="mobile-actions-btns-income">
                                        <button type="button" onclick="toggleEditMode('income-item-{{ transaction.id }}', true)" class="mobile-action-btn-income edit-btn-income">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button type="button" onclick="deleteItem('income-item-{{ transaction.id }}')" class="mobile-action-btn-income delete-btn-income">
                                            <span class="material-symbols-outlined">delete</span>
                                        </button>
                                    </div>
                                </td>

                                <td class="py-3 px-2 text-center mobile-hide-column">
                                    <button type="button" onclick="toggleIncomeRealized('income-item-{{ transaction.id }}')" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer {% if transaction.realized %}bg-green-500{% else %}bg-gray-300 dark:bg-gray-600{% endif %}">
                                        <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full {% if transaction.realized %}translate-x-4{% endif %}"></span>
                                    </button>
                                </td>

                                <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                                        <div class="actions-display flex justify-center gap-1">
                                            <button type="button" onclick="toggleEditMode('income-item-{{ transaction.id }}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                                            <button type="button" onclick="deleteItem('income-item-{{ transaction.id }}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                                        </div>
                                        <div class="actions-edit hidden flex justify-center gap-1">
                                            <button type="button" onclick="saveItem('income-item-{{ transaction.id }}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                            <button type="button" onclick="toggleEditMode('income-item-{{ transaction.id }}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                        </div>
                                </td>
                            </tr>
                        {% empty %}
                            {% if member_role_for_period != 'CHILD' or not kids_income_entries %}
                                <tr id="income-empty-row">
                                    <td colspan="6" class="py-4 px-4 text-center text-gray-500">{% trans "No income transactions recorded yet." %}</td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        
                        {% comment %} Child Manual Income for PARENTS/ADMINS {% endcomment %}
                        {% if member_role_for_period in 'PARENT,ADMIN' %}
                            {% for child_id, child_data in children_manual_income.items %}
                                <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50 child-manual-income-row relative" data-child-id="{{ child_id }}">
                                    <td class="py-3 px-3 text-sm font-medium" style="color: #DAA520;">
                                        {{ child_data.member.user.first_name|default:child_data.member.user.username }}
                                    </td>
                                    <td class="py-3 px-2 text-xs text-center" style="color: #DAA520;">
                                        <span class="text-xs">{% trans "Manual" %}</span>
                                    </td>
                                    <td class="py-3 px-2 text-center">
                                        <span class="text-xs text-gray-400">-</span>
                                    </td>
                                    <td class="py-3 px-3 text-sm text-right font-medium" style="color: #DAA520;">
                                        {{ currency_symbol }} {{ child_data.total|intcomma }}
                                    </td>
                                    <td class="px-2 py-3 text-center">
                                        <span class="text-xs" style="color: #DAA520;">{% trans "Child Income" %}</span>
                                    </td>
                                    
                                    {% comment %} Tooltip with transaction details {% endcomment %}
                                    <div class="child-income-tooltip absolute z-50 hidden bg-gray-900 text-white text-xs rounded-lg p-3 shadow-lg" style="top: 100%; left: 0; min-width: 300px; margin-top: 4px;">
                                        <div class="font-semibold mb-2 border-b border-gray-700 pb-1">{% blocktrans with name=child_data.member.user.first_name|default:child_data.member.user.username %}{{ name }}'s Manual Income:{% endblocktrans %}</div>
                                        {% for trans in child_data.transactions %}
                                            <div class="flex justify-between py-1">
                                                <span>{{ trans.description }}</span>
                                                <span class="font-medium">{{ currency_symbol }} {{ trans.amount|intcomma }}</span>
                                            </div>
                                        {% endfor %}
                                        <div class="flex justify-between pt-2 mt-2 border-t border-gray-700 font-semibold">
                                            <span>{% trans "Total:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.total|intcomma }}</span>
                                        </div>
                                        <div class="flex justify-between pt-1 text-green-400">
                                            <span>{% trans "Realized:" %}</span>
                                            <span>{{ currency_symbol }} {{ child_data.realized_total|intcomma }}</span>
                                        </div>
                                    </div>
                                </tr>
                            {% endfor %}
                        {% endif %}                        
                        <tr id="new-income-template" data-item-id="NEW" data-mode="edit" class="swipeable-row-income hover:bg-slate-50 dark:hover:bg-gray-700/50 hidden">
                            <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="new-income-template">
                                <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing" style="display: none;">drag_indicator</span>
                                <button type="button" onclick="saveIncomeItem('new-income-template')" class="edit-save-icon-income">
                                    <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                                </button>
                            </td>

                            <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                                <div class="cell-description-display" style="display: none;"></div>
                                <div class="cell-description-edit">
                                    <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" placeholder="{% trans "Description" %}">
                                </div>
                            </td>

                            <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                                <div class="cell-date-display" style="display: none;"></div>
                                <div class="cell-date-edit">
                                    <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="{{ today_date }}" data-display-value="{{ today_date|date:'d/m' }}">
                                </div>
                            </td>

                            <td class="py-3 px-3 text-sm text-right text-gray-400 dark:text-gray-500 amount-cell-with-actions">
                                <div class="cell-amount-display" style="display: none;"></div>
                                <div class="cell-amount-edit">
                                    <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="0{{ decimal_separator }}00">
                                </div>

                                <!-- Mobile action buttons (hidden behind row, revealed on swipe) -->
                                <div class="mobile-actions-btns-income">
                                    <button type="button" onclick="saveIncomeItem('new-income-template')" class="mobile-action-btn-income edit-btn-income">
                                        <span class="material-symbols-outlined">check</span>
                                    </button>
                                    <button type="button" onclick="cancelNewIncomeRow('new-income-template')" class="mobile-action-btn-income delete-btn-income">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </td>

                            <td class="py-3 px-2 text-center mobile-hide-column">
                                <div class="income-realized-toggle-new relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer">
                                    <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full"></span>
                                </div>
                            </td>

                            <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                                <div class="actions-display" style="display: none;"></div>
                                <div class="actions-edit flex justify-center gap-1">
                                    <button type="button" onclick="saveIncomeItem('new-income-template')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                    <button type="button" onclick="cancelNewIncomeRow('new-income-template')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-bold text-[#0d171b] dark:text-white">{% trans "Balance Sheet" %}</h2>
                    <a href="{% url 'bank_reconciliation' %}{% if selected_period %}?period={{ selected_period }}{% endif %}"
                       class="flex items-center rounded-lg bg-primary text-white text-sm font-medium px-3 py-2 hover:bg-primary/80 transition-colors">
                        <span class="material-symbols-outlined text-base mr-1">account_balance</span>
                        {% trans "Bank Reconciliation" %}
                    </a>
                </div> 
                
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white"></td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Estimated" %}</td>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-semibold">{% trans "Realized" %}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Income" %}</td>
                            <td id="balance-estimated-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_income|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-income" class="py-4 px-4 text-sm text-green-600 dark:text-green-500">{{ currency_symbol }} {{ summary_totals.total_realized_income|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">{% trans "Expenses" %}</td>
                            <td id="balance-estimated-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_budgeted_expense|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-expense" class="py-4 px-4 text-sm text-red-600 dark:text-red-500">{{ currency_symbol }} {{ summary_totals.total_realized_expense|default:"0.00"|intcomma }}</td>
                        </tr>
                        <tr>
                            <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white font-bold">{% trans "Result" %}</td>
                            <td id="balance-estimated-result" class="py-4 px-4 text-sm {% if summary_totals.estimated_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.estimated_result|default:"0.00"|intcomma }}</td>
                            <td id="balance-realized-result" class="py-4 px-4 text-sm {% if summary_totals.realized_result >= 0 %}text-green-600 dark:text-green-500{% else %}text-red-600 dark:text-red-500{% endif %} font-bold">{{ currency_symbol }} {{ summary_totals.realized_result|default:"0.00"|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>             
            </div>
        </div> 
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Utility for getting CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Income flow group ID (passed from backend)
    const incomeFlowGroupId = "{{ income_flow_group_id }}";
    
    // Member role (for conditional logic)
    const memberRoleForPeriod = "{{ member_role_for_period }}";

    // Locale-specific separators from backend
    const decimalSeparator = "{{ decimal_separator }}";
    const thousandSeparator = "{{ thousand_separator }}";
    console.log('[INIT] decimalSeparator:', decimalSeparator, 'thousandSeparator:', thousandSeparator);

    // Function to format number as currency for display
    function formatCurrency(amount) {
        // Parse the amount to ensure it's a number
        const num = parseFloat(amount);
        if (isNaN(num)) return amount;

        // Format to 2 decimal places
        const parts = num.toFixed(2).split('.');
        const integerPart = parts[0];
        const decimalPart = parts[1];

        // Add thousand separators to integer part
        const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

        // Combine with decimal separator
        return formattedInteger + decimalSeparator + decimalPart;
    }

    // Function to parse localized currency string back to number
    function parseCurrency(text) {
        if (!text) return 0;

        // Remove currency symbol and whitespace
        let cleanText = text.replace(/[^\d.,\-]/g, '');

        // Replace thousand separator with empty string
        // Replace decimal separator with dot for parseFloat
        cleanText = cleanText.replace(new RegExp('\\' + thousandSeparator, 'g'), '');
        cleanText = cleanText.replace(new RegExp('\\' + decimalSeparator, 'g'), '.');

        const num = parseFloat(cleanText);
        return isNaN(num) ? 0 : num;
    }

    // === CHARTS INITIALIZATION ===
    
    // Chart.js default colors
    const chartColors = [
        'rgb(239, 68, 68)',   // red-500
        'rgb(249, 115, 22)',  // orange-500
        'rgb(234, 179, 8)',   // yellow-500
        'rgb(34, 197, 94)',   // green-500
        'rgb(59, 130, 246)',  // blue-500
        'rgb(168, 85, 247)',  // purple-500
        'rgb(236, 72, 153)',  // pink-500
    ];
    
    let pieChart, barChart;
    
    // Initialize Pie Chart
    function initPieChart() {
        const ctx = document.getElementById('expensesPieChart');
        if (!ctx) return;
        
        const expenseData = getTop3ExpensesData();
        
        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: expenseData.labels,
                datasets: [{
                    data: expenseData.values,
                    backgroundColor: chartColors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: $${formatCurrency(value)} (${percentage}%)`;
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 5,
                        right: 5,
                        top: 5,
                        bottom: 5
                    }
                }
            }
        });
    }
    
    // Calculate linear regression for trend line
    function calculateTrendLine(values) {
        const n = values.length;
        if (n === 0) return [];
        
        const xValues = values.map((_, i) => i);
        const sumX = xValues.reduce((a, b) => a + b, 0);
        const sumY = values.reduce((a, b) => a + b, 0);
        const sumXY = xValues.reduce((sum, x, i) => sum + x * values[i], 0);
        const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        return xValues.map(x => slope * x + intercept);
    }
    
    // Initialize Bar Chart with dynamic colors and trend line
    function initBarChart() {
        const ctx = document.getElementById('expensesBarChart');
        if (!ctx) return;
        
        const barData = {{ periods_history_json|safe }};
        
        // Calculate bar colors based on income commitment
        const barColors = barData.colors || barData.values.map(() => 'rgb(239, 68, 68)');
        
        // Calculate trend line
        const trendLine = calculateTrendLine(barData.values);
        
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: barData.labels,
                datasets: [
                    {
                        label: '{% trans "Total Expenses" %}',
                        data: barData.values,
                        backgroundColor: barColors,
                        borderColor: barColors.map(color => color.replace('rgb', 'rgba').replace(')', ', 0.8)')),
                        borderWidth: 1
                    },
                    {
                        label: '{% trans "Trend" %}',
                        data: trendLine,
                        type: 'line',
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 9
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                size: 10
                            },
                            boxWidth: 12,
                            padding: 8
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Total: $' + formatCurrency(context.parsed.y);
                                } else {
                                    return 'Trend: $' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 5,
                        right: 5,
                        top: 5,
                        bottom: 5
                    }
                }
            }
        });
    }
    
    // Get Top 3 Expenses Data (based on realized values only)
    function getTop3ExpensesData() {
        const expenseRows = document.querySelectorAll('tbody tr[data-group-id]');
        const expenses = [];

        expenseRows.forEach(row => {
            // Get the first cell (after drag handle) which contains the group name
            const nameCell = row.querySelectorAll('td')[1]; // Second td (index 1)
            const nameText = nameCell.textContent.trim();
            // Get only the first line (group name) before any badges/labels
            const name = nameText.split('\n')[0].trim();

            // Use only realized values for the chart
            const realizedValue = parseFloat(row.querySelector('.group-realized').getAttribute('data-value')) || 0;

            if (realizedValue > 0) {
                expenses.push({ name, value: realizedValue });
            }
        });

        // Sort by value descending
        expenses.sort((a, b) => b.value - a.value);

        // Get top 3
        const top3 = expenses.slice(0, 3);
        const others = expenses.slice(3).reduce((sum, item) => sum + item.value, 0);

        const labels = top3.map(e => e.name);
        const values = top3.map(e => e.value);

        if (others > 0) {
            labels.push('{% trans "Others" %}');
            values.push(others);
        }

        return { labels, values };
    }
    
    // Update Pie Chart
    function updatePieChart() {
        if (!pieChart) return;
        
        const expenseData = getTop3ExpensesData();
        pieChart.data.labels = expenseData.labels;
        pieChart.data.datasets[0].data = expenseData.values;
        pieChart.update('none');
    }
    
    // Update metrics card (only dynamic values)
    function updateMetrics() {
        // Highest expense (from current period)
        const expenseRows = document.querySelectorAll('tbody tr[data-group-id]');
        let highestExpense = 0;
        expenseRows.forEach(row => {
            const realizedValue = parseFloat(row.querySelector('.group-realized').getAttribute('data-value')) || 0;
            if (realizedValue > highestExpense) {
                highestExpense = realizedValue;
            }
        });
        document.getElementById('metric-highest').textContent = '$ ' + formatCurrency(highestExpense);

        // Current commitment percentage (current period only)
        const incomeElem = document.getElementById('balance-realized-income');
        const expenseElem = document.getElementById('balance-realized-expense');

        if (!incomeElem || !expenseElem) {
            console.error('Balance elements not found');
            return;
        }

        // Parse localized currency values
        const realizedIncome = parseCurrency(incomeElem.textContent);
        const realizedExpense = parseCurrency(expenseElem.textContent);

        const commitment = realizedIncome > 0 ? (realizedExpense / realizedIncome * 100) : 0;
        const commitmentElem = document.getElementById('metric-commitment');
        commitmentElem.textContent = commitment.toFixed(1) + '%';

        if (commitment >= 98) {
            commitmentElem.classList.remove('text-green-600', 'dark:text-green-500', 'text-yellow-600', 'dark:text-yellow-500');
            commitmentElem.classList.add('text-red-600', 'dark:text-red-500');
        } else if (commitment >= 90) {
            commitmentElem.classList.remove('text-green-600', 'dark:text-green-500', 'text-red-600', 'dark:text-red-500');
            commitmentElem.classList.add('text-yellow-600', 'dark:text-yellow-500');
        } else {
            commitmentElem.classList.remove('text-red-600', 'dark:text-red-500', 'text-yellow-600', 'dark:text-yellow-500');
            commitmentElem.classList.add('text-green-600', 'dark:text-green-500');
        }
    }
    
    // Money mask functions
    function applyMoneyMask(event) {
        const input = event.target;
        
        // 1. Save cursor position and original value
        const originalCursorPos = input.selectionStart;
        const originalValue = input.value;

        let value = input.value;

        // Remove all non-digit characters
        value = value.replace(/\D/g, '');

        // If empty, set to 0. This case is simple.
        if (value === '') {
            input.value = '0' + decimalSeparator + '00';
            // Position cursor at end for the default zero value
            setTimeout(function() {
                input.setSelectionRange(input.value.length, input.value.length);
            }, 0);
            return;
        }

        // Convert to integer (cents)
        let cents = parseInt(value, 10);

        // Format as currency with 2 decimal places
        let integerPart = Math.floor(cents / 100).toString();
        let decimalPart = (cents % 100).toString().padStart(2, '0');

        // Add thousand separators to integer part
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

        // Set the new formatted value
        input.value = integerPart + decimalSeparator + decimalPart;

        // 3. Calculate and restore cursor position
        const newLength = input.value.length;
        const oldLength = originalValue.length;
        let newCursorPos = originalCursorPos + (newLength - oldLength);

        // Ensure cursor doesn't go to a negative position (can happen on delete)
        if (newCursorPos < 0) {
            newCursorPos = 0;
        }
        
        input.setSelectionRange(newCursorPos, newCursorPos);
    }

    function getRawValue(maskedValue) {
        // Remove thousand separators and replace decimal separator with dot
        console.log('[getRawValue] Input:', maskedValue);
        console.log('[getRawValue] thousandSeparator:', thousandSeparator, 'decimalSeparator:', decimalSeparator);
        let value = maskedValue.replace(new RegExp('\\' + thousandSeparator, 'g'), '');
        console.log('[getRawValue] After removing thousand sep:', value);
        value = value.replace(decimalSeparator, '.');
        console.log('[getRawValue] Final output:', value);
        return value;
    }

    // Initialize charts on page load
    document.addEventListener('DOMContentLoaded', function() {
        initPieChart();
        initBarChart();
        updateMetrics();

        // Add money mask to all amount fields using event delegation
        document.addEventListener('input', function(event) {
            if (event.target.matches('input[data-field="amount"]')) {
                applyMoneyMask(event);
            }
        });

        // CORREÇÃO: Cursor orientado à direita apenas no primeiro clique/foco
        // Após o primeiro foco, permitir seleção livre
        document.addEventListener('focus', function(event) {
            if (event.target.matches('input[data-field="amount"]')) {
                // Verificar se é o primeiro foco (campo não tem flag de já focado)
                if (!event.target.hasAttribute('data-first-focus-done')) {
                    // Primeiro foco: mover cursor para o final
                    event.target.setAttribute('data-first-focus-done', 'true');
                    setTimeout(function() {
                        event.target.setSelectionRange(event.target.value.length, event.target.value.length);
                    }, 0);
                }
                // Cliques subsequentes: permitir seleção livre (não fazer nada)
            }
        }, true);


        // CORREÇÃO: Resetar flags quando o campo perde o foco
        // Isso garante que ao voltar ao campo, será tratado como primeiro foco novamente
        document.addEventListener('blur', function(event) {
            if (event.target.matches('input[data-field="amount"]')) {
                event.target.removeAttribute('data-first-focus-done');
            }
        }, true);

        // CORREÇÃO: Remover bloqueio de teclas de navegação
        // Agora o usuário pode usar setas para navegar livremente após o primeiro foco
        // (Código de bloqueio de arrow keys REMOVIDO)

        // Initialize existing amount fields with money mask on page load
        document.querySelectorAll('input[data-field="amount"]').forEach(function(input) {
            if (input.value && input.value.trim() !== '') {
                let value = input.value.replace(',', '.');
                let num = parseFloat(value);
                if (!isNaN(num)) {
                    let cents = Math.round(num * 100);
                    let integerPart = Math.floor(cents / 100).toString();
                    let decimalPart = (cents % 100).toString().padStart(2, '0');
                    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);
                    input.value = integerPart + decimalSeparator + decimalPart;
                } else {
                    input.value = '0' + decimalSeparator + '00';
                }
            } else {
                input.value = '0' + decimalSeparator + '00';
            }
        });
    });
    
    // === END CHARTS ===

    function updateBalanceSheet() {
        // Fetch updated balance from backend
        const urlParams = new URLSearchParams(window.location.search);
        const period = urlParams.get('period') || '';
        const url = "{% url 'get_balance_summary_ajax' %}" + (period ? `?period=${period}` : '');

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const balance = data.balance;
                const symbol = balance.currency_symbol || '$';

                // Update income
                document.getElementById('balance-estimated-income').textContent = symbol + ' ' + formatCurrency(parseFloat(balance.estimated_income));
                document.getElementById('balance-realized-income').textContent = symbol + ' ' + formatCurrency(parseFloat(balance.realized_income));

                // Update expense
                document.getElementById('balance-estimated-expense').textContent = symbol + ' ' + formatCurrency(parseFloat(balance.estimated_expense));
                document.getElementById('balance-realized-expense').textContent = symbol + ' ' + formatCurrency(parseFloat(balance.realized_expense));

                // Update result
                const estimatedResult = parseFloat(balance.estimated_result);
                const realizedResult = parseFloat(balance.realized_result);

                const estResultCell = document.getElementById('balance-estimated-result');
                const realResultCell = document.getElementById('balance-realized-result');

                estResultCell.textContent = symbol + ' ' + formatCurrency(estimatedResult);
                realResultCell.textContent = symbol + ' ' + formatCurrency(realizedResult);

                // Update colors
                if (estimatedResult >= 0) {
                    estResultCell.className = 'py-4 px-4 text-sm text-green-600 dark:text-green-500 font-bold';
                } else {
                    estResultCell.className = 'py-4 px-4 text-sm text-red-600 dark:text-red-500 font-bold';
                }

                if (realizedResult >= 0) {
                    realResultCell.className = 'py-4 px-4 text-sm text-green-600 dark:text-green-500 font-bold';
                } else {
                    realResultCell.className = 'py-4 px-4 text-sm text-red-600 dark:text-red-500 font-bold';
                }

                // Update metrics
                updateMetrics();
            } else {
                console.error('Error fetching balance:', data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
        });
    }

    // Function to add a new income row
    function addNewIncomeRow() {
        const emptyRow = document.getElementById('income-empty-row');
        if (emptyRow) {
            emptyRow.remove();
        }
        
        const templateRow = document.getElementById('new-income-template');
        if (templateRow && templateRow.classList.contains('hidden')) {
            templateRow.classList.remove('hidden');
            templateRow.querySelector('input[data-field="description"]').focus();
        } else if (templateRow) {
            templateRow.querySelector('input[data-field="description"]').focus();
        }
    }
    
    // Function to toggle income realized status
    function toggleIncomeRealized(rowId) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');

        if (transactionId === 'NEW') return;

        // Check if this is a kids income (should not be toggled)
        if (row.getAttribute('data-kids-income') === 'true') {
            alert('{% trans "Only Parents/Admins can change this status" %}');
            return;
        }

        // Get current status from data attribute
        const currentStatus = row.getAttribute('data-realized') === 'true';
        const newStatus = !currentStatus;

        // Get other field values
        const description = row.querySelector('.cell-description-display').textContent.trim();
        const fullDate = row.getAttribute('data-date');

        // Get amount from edit input field and convert from masked format
        const amountInput = row.querySelector('.cell-amount-edit input[data-field="amount"]');
        const amountText = getRawValue(amountInput.value);
        const isFixed = row.getAttribute('data-is-fixed') === 'true';

        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': transactionId,
            'description': description,
            'amount': amountText,
            'date': fullDate,
            'realized': newStatus,
            'is_fixed': isFixed,
        };

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update toggle visual state
                const toggleBtn = row.querySelector('.income-realized-toggle');
                const toggleCircle = toggleBtn.querySelector('span');
                const amountDisplay = row.querySelector('.cell-amount-display');
                const amountCell = amountDisplay.parentElement;

                // Update data attributes
                row.setAttribute('data-realized', data.realized ? 'true' : 'false');
                row.setAttribute('data-amount', data.amount);

                // Update amount display with currency symbol
                if (data.amount && data.currency_symbol) {
                    amountDisplay.textContent = data.currency_symbol + ' ' + formatCurrency(data.amount);
                }

                // Update amount input field
                const amountInput = row.querySelector('input[data-field="amount"]');
                if (amountInput && data.amount) {
                    amountInput.value = formatAmountForInput(data.amount);
                }

                if (data.realized) {
                    toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    toggleBtn.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-4');
                    amountCell.classList.remove('text-gray-400', 'dark:text-gray-500');
                    amountCell.classList.add('text-green-600', 'dark:text-green-500');
                    // Update row background color
                    row.classList.remove('row-not-realized-income');
                    row.classList.add('row-realized-income');
                } else {
                    toggleBtn.classList.remove('bg-green-500');
                    toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-4');
                    amountCell.classList.remove('text-green-600', 'dark:text-green-500');
                    amountCell.classList.add('text-gray-400', 'dark:text-gray-500');
                    // Update row background color
                    row.classList.remove('row-realized-income');
                    row.classList.add('row-not-realized-income');
                }

                // Update balance sheet
                updateBalanceSheet();
            } else {
                alert('{% trans "Error updating income status:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to save new income item
    function saveIncomeItem(rowId) {
        const row = document.getElementById(rowId);

        // Check toggle state
        const toggleNew = row.querySelector('.income-realized-toggle-new');
        const realizedValue = toggleNew.classList.contains('bg-green-500');

        const amountValue = getRawValue(row.querySelector('input[data-field="amount"]').value);

        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': null,
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': amountValue,  // Send raw value, backend handles locale
            'date': row.querySelector('input[data-field="date"]').value,
            'realized': realizedValue,
            'is_child_manual': memberRoleForPeriod === 'CHILD',  // Flag for child manual income
        };

        if (!data.description || !data.amount || !data.date) {
            alert("{% trans 'Description, Amount, and Date are required.' %}");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Hide the new income template
                row.classList.add('hidden');

                // Create new row element based on existing income row structure
                const tbody = document.getElementById('income-items-body');
                const newRowId = 'income-item-' + data.transaction_id;

                // Clone the template structure but make it a regular row
                const newRowHTML = `
                    <tr id="${newRowId}"
                        data-item-id="${data.transaction_id}"
                        data-mode="display"
                        data-realized="${data.realized ? 'true' : 'false'}"
                        data-date="${data.date}"
                        data-amount="${data.amount}"
                        class="swipeable-row-income ${data.realized ? 'row-realized-income' : 'row-not-realized-income'} hover:bg-slate-50 dark:hover:bg-gray-700/50">

                        <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="${newRowId}">
                            <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing">drag_indicator</span>
                            <button type="button" onclick="saveItem('${newRowId}')" class="edit-save-icon-income" style="display: none;">
                                <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                            </button>
                        </td>

                        <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                            <div class="cell-description-display">${data.description}</div>
                            <div class="cell-description-edit hidden">
                                <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="${data.description}">
                            </div>
                        </td>

                        <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                            <div class="cell-date-display">${new Date(data.date).toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'})}</div>
                            <div class="cell-date-edit hidden">
                                <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="${data.date}">
                            </div>
                        </td>

                        <td class="py-3 px-3 text-sm text-right ${data.realized ? 'text-green-600 dark:text-green-500' : 'text-gray-400 dark:text-gray-500'} amount-cell-with-actions">
                            <div class="cell-amount-display">${data.currency_symbol} ${formatCurrency(data.amount)}</div>
                            <div class="cell-amount-edit hidden">
                                <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="${formatAmountForInput(data.amount)}">
                            </div>

                            <div class="mobile-actions-btns-income">
                                <button type="button" onclick="toggleEditMode('${newRowId}', true)" class="mobile-action-btn-income edit-btn-income">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button type="button" onclick="deleteItem('${newRowId}')" class="mobile-action-btn-income delete-btn-income">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </td>

                        <td class="py-3 px-2 text-center mobile-hide-column">
                            <button type="button" onclick="toggleIncomeRealized('${newRowId}')" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer ${data.realized ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'}">
                                <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full ${data.realized ? 'translate-x-4' : ''}"></span>
                            </button>
                        </td>

                        <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                            <div class="actions-display flex justify-center gap-1">
                                <button type="button" onclick="toggleEditMode('${newRowId}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                                <button type="button" onclick="deleteItem('${newRowId}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                            </div>
                            <div class="actions-edit hidden flex justify-center gap-1">
                                <button type="button" onclick="saveItem('${newRowId}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                                <button type="button" onclick="toggleEditMode('${newRowId}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                            </div>
                        </td>
                    </tr>`;

                // Insert the new row at the beginning of tbody (after kids entries if any)
                const firstRegularRow = tbody.querySelector('tr[id^="income-item-"]:not([id="new-income-template"])');
                if (firstRegularRow) {
                    firstRegularRow.insertAdjacentHTML('beforebegin', newRowHTML);
                } else {
                    // If no regular rows exist, insert before the template
                    row.insertAdjacentHTML('beforebegin', newRowHTML);
                }

                // Reset the template row
                cancelNewIncomeRow('new-income-template');

                // Update balance sheet
                updateBalanceSheet();
            } else {
                alert('{% trans "Error saving income:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }
    
    // Function to cancel new income row
    function cancelNewIncomeRow(rowId) {
        const row = document.getElementById(rowId);
        row.classList.add('hidden');
        row.querySelector('input[data-field="description"]').value = '';
        row.querySelector('input[data-field="amount"]').value = '0' + decimalSeparator + '00';
        
        // Reset toggle
        const toggleNew = row.querySelector('.income-realized-toggle-new');
        const toggleCircle = toggleNew.querySelector('span');
        toggleNew.classList.remove('bg-green-500');
        toggleNew.classList.add('bg-gray-300', 'dark:bg-gray-600');
        toggleCircle.classList.remove('translate-x-3');
    }
    
    // Add click handler for new income toggle
    document.addEventListener('DOMContentLoaded', function() {
        const toggleNew = document.querySelector('.income-realized-toggle-new');
        if (toggleNew) {
            toggleNew.addEventListener('click', function() {
                const toggleCircle = this.querySelector('span');
                if (this.classList.contains('bg-green-500')) {
                    this.classList.remove('bg-green-500');
                    this.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    toggleCircle.classList.remove('translate-x-3');
                } else {
                    this.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    this.classList.add('bg-green-500');
                    toggleCircle.classList.add('translate-x-3');
                }
            });
        }
        
        // Tooltip functionality for child manual income
        const childIncomeRows = document.querySelectorAll('.child-manual-income-row');
        childIncomeRows.forEach(row => {
            const tooltip = row.querySelector('.child-income-tooltip');
            
            row.addEventListener('mouseenter', function() {
                tooltip.classList.remove('hidden');
            });
            
            row.addEventListener('mouseleave', function() {
                tooltip.classList.add('hidden');
            });
        });
    });

    // Function to delete an item
    async function deleteItem(rowId) {
        const confirmed = await confirm('{% trans "Are you sure you want to delete this item?" %}');
        if (!confirmed) return;

        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        
        if (transactionId === 'NEW') {
            cancelNewRow(rowId);
            return;
        }

        fetch("{% url 'delete_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({'transaction_id': transactionId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                row.remove();
                updateBalanceSheet();
                updatePieChart();
            } else {
                alert('{% trans "Error deleting item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }

    // Function to format amount for input field based on user's locale
    function formatAmountForInput(amount) {
        // Convert to number and apply money mask format
        const num = parseFloat(amount);
        if (isNaN(num)) return '0' + decimalSeparator + '00';

        // Convert to cents
        let cents = Math.round(num * 100);

        // Format with mask
        let integerPart = Math.floor(cents / 100).toString();
        let decimalPart = (cents % 100).toString().padStart(2, '0');
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, thousandSeparator);

        return integerPart + decimalSeparator + decimalPart;
    }

    // Function to toggle between display and edit mode
    function toggleEditMode(rowId, startEdit) {
        const row = document.getElementById(rowId);
        if (!row) return;

        const displayElements = row.querySelectorAll('.actions-display, .cell-description-display, .cell-date-display, .cell-amount-display');
        const editElements = row.querySelectorAll('.actions-edit, .cell-description-edit, .cell-date-edit, .cell-amount-edit');

        displayElements.forEach(el => el.classList.toggle('hidden', startEdit));
        editElements.forEach(el => el.classList.toggle('hidden', !startEdit));

        row.setAttribute('data-mode', startEdit ? 'edit' : 'display');

        // Mobile: Reset row position when entering/exiting edit mode
        if (window.matchMedia('(max-width: 768px)').matches) {
            row.style.transform = 'translateX(0)';
            row.classList.remove('actions-revealed-income');

            // Toggle drag handle visibility based on edit mode
            const dragHandle = row.querySelector('.drag-handle-cell-income');
            if (dragHandle) {
                const dragIcon = dragHandle.querySelector('.drag-handle-income');
                const checkIcon = dragHandle.querySelector('.edit-save-icon-income');

                if (startEdit) {
                    // Show check icon, hide drag icon
                    if (dragIcon) dragIcon.style.display = 'none';
                    if (checkIcon) checkIcon.style.display = 'inline-block';

                    // Update date input display value for mobile button-style input
                    const dateInput = row.querySelector('.date-input-field-income');
                    if (dateInput) {
                        const dateValue = dateInput.value; // YYYY-MM-DD format
                        if (dateValue) {
                            const [year, month, day] = dateValue.split('-');
                            const displayValue = `${day}/${month}`;
                            dateInput.setAttribute('data-display-value', displayValue);
                        }
                    }
                } else {
                    // Show drag icon, hide check icon
                    if (dragIcon) dragIcon.style.display = 'inline-block';
                    if (checkIcon) checkIcon.style.display = 'none';
                }
            }
        }

        if(startEdit) {
             row.querySelector('.cell-description-edit input').focus();
        }
    }

    // Function to save edited item
    function saveItem(rowId) {
        const row = document.getElementById(rowId);
        const transactionId = row.getAttribute('data-item-id');
        const realizedStatus = row.getAttribute('data-realized') === 'true';

        const amountInput = row.querySelector('input[data-field="amount"]');
        const amountText = getRawValue(amountInput.value);

        const data = {
            'flow_group_id': incomeFlowGroupId,
            'transaction_id': transactionId,
            'description': row.querySelector('input[data-field="description"]').value,
            'amount': amountText,  // Send raw value in standard format
            'date': row.querySelector('input[data-field="date"]').value,
            'realized': realizedStatus,
        };
        
        if (!data.description || !data.amount || !data.date) {
            alert("{% trans 'Description, Amount, and Date are required.' %}");
            return;
        }

        fetch("{% url 'save_flow_item_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update row data
                row.setAttribute('data-amount', data.amount);
                row.querySelector('.cell-description-display').textContent = data.description;
                // Use currency_symbol from backend response
                const currencySymbol = data.currency_symbol || '{{ currency_symbol }}';
                row.querySelector('.cell-amount-display').textContent = currencySymbol + ' ' + formatCurrency(data.amount);
                row.querySelector('.cell-date-display').textContent = new Date(data.date).toLocaleDateString('en-GB', {day: '2-digit', month: '2-digit'});
                
                // Update inputs
                row.querySelector('input[data-field="description"]').value = data.description;
                row.querySelector('input[data-field="amount"]').value = formatAmountForInput(data.amount);
                row.querySelector('input[data-field="date"]').value = data.date;
                row.setAttribute('data-date', data.date);
                
                toggleEditMode(rowId, false);
                updateBalanceSheet();
            } else {
                alert('{% trans "Error saving item:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred." %}');
        });
    }
    
    // === DRAG AND DROP REORDERING FOR EXPENSE GROUPS ===
    
    let draggedRow = null;
    let draggedOverRow = null;
    
    // Initialize drag and drop on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
        initializeClickableRows();
        initializeDragAndDropIncome();
    });
    
    function initializeDragAndDrop() {
        const tbody = document.getElementById('expense-groups-tbody');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.draggable-row');

        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('dragenter', handleDragEnter);
            row.addEventListener('dragleave', handleDragLeave);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });
    }

    function initializeClickableRows() {
        const tbody = document.getElementById('expense-groups-tbody');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.group-row-clickable');

        rows.forEach(row => {
            // Make row clickable (except drag handle)
            row.addEventListener('click', function(e) {
                // Don't navigate if clicking on drag handle
                if (e.target.closest('.drag-handle-cell') || e.target.closest('.drag-handle')) {
                    return;
                }

                const url = this.getAttribute('data-group-url');
                if (url) {
                    window.location.href = url;
                }
            });

            // Add cursor pointer on hover (except drag handle)
            row.addEventListener('mouseover', function(e) {
                if (!e.target.closest('.drag-handle-cell') && !e.target.closest('.drag-handle')) {
                    this.style.cursor = 'pointer';
                }
            });

            row.addEventListener('mouseout', function(e) {
                this.style.cursor = 'default';
            });
        });

        // Prevent drag on non-drag-handle clicks
        const dragHandles = tbody.querySelectorAll('.drag-handle');
        dragHandles.forEach(handle => {
            handle.addEventListener('mousedown', function(e) {
                const row = this.closest('tr');
                if (row) {
                    row.setAttribute('draggable', 'true');
                }
            });

            // CORREÇÃO: Touch support for mobile drag
            handle.addEventListener('touchstart', function(e) {
                const row = this.closest('tr');
                if (row) {
                    row.setAttribute('draggable', 'true');
                    handleTouchDragStartGroups(e, row);
                }
            }, { passive: false });
        });

        // Disable dragging when not on handle
        rows.forEach(row => {
            row.addEventListener('mousedown', function(e) {
                if (!e.target.closest('.drag-handle-cell') && !e.target.closest('.drag-handle')) {
                    this.setAttribute('draggable', 'false');
                } else {
                    this.setAttribute('draggable', 'true');
                }
            });

            // CORREÇÃO: Adicionar touch event listeners para mobile
            row.addEventListener('touchmove', handleTouchDragMoveGroups, { passive: false });
            row.addEventListener('touchend', handleTouchDragEndGroups, { passive: false });
        });
    }

    // CORREÇÃO: Variáveis para mobile drag de FlowGroups
    let touchDraggedGroupRow = null;
    let touchStartYGroups = 0;
    let touchCurrentYGroups = 0;

    function handleTouchDragStartGroups(e, row) {
        if (!e.target.closest('.drag-handle')) return;

        e.preventDefault();
        touchDraggedGroupRow = row;
        touchStartYGroups = e.touches[0].clientY;
        touchCurrentYGroups = touchStartYGroups;

        // Visual feedback
        row.style.opacity = '0.4';
        row.classList.add('dragging');

        // Disable pointer events on other rows to prevent conflicts
        document.querySelectorAll('tr.draggable-row').forEach(r => {
            if (r !== row) {
                r.style.pointerEvents = 'none';
            }
        });
    }

    function handleTouchDragMoveGroups(e) {
        if (!touchDraggedGroupRow) return;
        if (this !== touchDraggedGroupRow) return;

        e.preventDefault();
        touchCurrentYGroups = e.touches[0].clientY;

        const deltaY = touchCurrentYGroups - touchStartYGroups;

        // Find the row under the touch point
        const elementBelow = document.elementFromPoint(
            e.touches[0].clientX,
            e.touches[0].clientY
        );

        const rowBelow = elementBelow ? elementBelow.closest('tr.draggable-row') : null;

        // Remove previous highlights
        document.querySelectorAll('tr.draggable-row').forEach(r => {
            r.classList.remove('border-t-2', 'border-primary', 'border-b-2');
        });

        // Highlight the target row
        if (rowBelow && rowBelow !== touchDraggedGroupRow) {
            if (deltaY > 0) {
                // Dragging down
                rowBelow.classList.add('border-b-2', 'border-primary');
            } else {
                // Dragging up
                rowBelow.classList.add('border-t-2', 'border-primary');
            }
        }

        // Visual feedback - move the row
        touchDraggedGroupRow.style.transform = `translateY(${deltaY}px)`;
    }

    function handleTouchDragEndGroups(e) {
        if (!touchDraggedGroupRow) return;
        if (this !== touchDraggedGroupRow) return;

        e.preventDefault();

        const deltaY = touchCurrentYGroups - touchStartYGroups;

        const rect = touchDraggedGroupRow.getBoundingClientRect();
        const centerX = rect.left + (rect.width / 2);

        touchDraggedGroupRow.style.visibility = 'hidden';
        const elementBelow = document.elementFromPoint(centerX, touchCurrentYGroups);
        touchDraggedGroupRow.style.visibility = '';

        let targetRow = elementBelow ? elementBelow.closest('tr.draggable-row') : null;

        if (!targetRow) {
            const tbody = document.getElementById('expense-groups-tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));

            let closestRow = null;
            let closestDistance = Infinity;

            allRows.forEach(function(row) {
                if (row === touchDraggedGroupRow) return;

                const rowRect = row.getBoundingClientRect();
                const rowCenterY = rowRect.top + (rowRect.height / 2);
                const distance = Math.abs(touchCurrentYGroups - rowCenterY);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestRow = row;
                }
            });

            if (closestRow) {
                targetRow = closestRow;
            }
        }

        // Perform the drop
        if (targetRow && targetRow !== touchDraggedGroupRow) {
            const tbody = document.getElementById('expense-groups-tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));

            const draggedIndex = allRows.indexOf(touchDraggedGroupRow);
            const targetIndex = allRows.indexOf(targetRow);

            // Move the row
            if (deltaY > 0) {
                // Dragging down - insert after target
                targetRow.parentNode.insertBefore(touchDraggedGroupRow, targetRow.nextSibling);
            } else {
                // Dragging up - insert before target
                targetRow.parentNode.insertBefore(touchDraggedGroupRow, targetRow);
            }

            // Save new order to backend
            saveGroupsOrder();
        }

        // Reset visual feedback
        touchDraggedGroupRow.style.opacity = '1';
        touchDraggedGroupRow.style.transform = '';
        touchDraggedGroupRow.classList.remove('dragging');

        // Re-enable pointer events on all rows
        document.querySelectorAll('tr.draggable-row').forEach(r => {
            r.style.pointerEvents = '';
        });

        // Remove all highlights
        document.querySelectorAll('tr.draggable-row').forEach(r => {
            r.classList.remove('border-t-2', 'border-primary', 'border-b-2');
        });

        // Reset variables
        touchDraggedGroupRow = null;
        touchStartYGroups = 0;
        touchCurrentYGroups = 0;
    }
    
    function handleDragStart(e) {
        draggedRow = this;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }
    
    function handleDragEnter(e) {
        if (this !== draggedRow) {
            this.classList.add('border-t-2', 'border-primary');
            draggedOverRow = this;
        }
    }
    
    function handleDragLeave(e) {
        this.classList.remove('border-t-2', 'border-primary');
    }
    
    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        if (draggedRow !== this) {
            // Get the tbody
            const tbody = document.getElementById('expense-groups-tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr.draggable-row'));
            
            const draggedIndex = allRows.indexOf(draggedRow);
            const targetIndex = allRows.indexOf(this);
            
            // Move the dragged row
            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedRow, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedRow, this);
            }
            
            // Save new order to backend
            saveGroupsOrder();
        }
        
        return false;
    }
    
    function handleDragEnd(e) {
        this.style.opacity = '1';
        
        // Remove all drag-related classes
        const rows = document.querySelectorAll('tr.draggable-row');
        rows.forEach(row => {
            row.classList.remove('border-t-2', 'border-primary');
        });
        
        draggedRow = null;
        draggedOverRow = null;
    }
    
    function saveGroupsOrder() {
        const tbody = document.getElementById('expense-groups-tbody');
        const rows = tbody.querySelectorAll('tr.draggable-row');
        
        const orderData = [];
        rows.forEach((row, index) => {
            const groupId = row.getAttribute('data-group-id');
            orderData.push({
                id: groupId,
                order: index + 1
            });
        });
        
        fetch("{% url 'reorder_flow_groups_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ groups: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Order saved successfully');
                // Optionally update pie chart if order affects display
                updatePieChart();
            } else {
                console.error('Error saving order:', data.error);
                alert('{% trans "Error saving order:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred while saving order." %}');
        });
    }

    // ========== DRAG AND DROP FOR INCOME ITEMS ========== 
    let draggedIncomeRow = null;
    let draggedOverIncomeRow = null;

    function initializeDragAndDropIncome() {
        const tbody = document.getElementById('income-items-body');
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr.swipeable-row-income');

        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStartIncome);
            row.addEventListener('dragover', handleDragOverIncome);
            row.addEventListener('dragenter', handleDragEnterIncome);
            row.addEventListener('dragleave', handleDragLeaveIncome);
            row.addEventListener('drop', handleDropIncome);
            row.addEventListener('dragend', handleDragEndIncome);
        });

        // Enable drag only from drag handle
        const dragHandles = tbody.querySelectorAll('.drag-handle-income');
        dragHandles.forEach(handle => {
            handle.addEventListener('mousedown', function(e) {
                const row = this.closest('tr');
                if (row && row.dataset.mode !== 'edit') {
                    row.setAttribute('draggable', 'true');
                }
            });

            // CORREÇÃO: Touch support for mobile drag
            handle.addEventListener('touchstart', function(e) {
                const row = this.closest('tr');
                if (row && row.dataset.mode !== 'edit') {
                    row.setAttribute('draggable', 'true');
                    handleTouchDragStartIncome(e, row);
                }
            }, { passive: false });
        });

        // Disable dragging when not on handle or in edit mode
        rows.forEach(row => {
            row.addEventListener('mousedown', function(e) {
                if (this.dataset.mode === 'edit' ||
                    (!e.target.closest('.drag-handle-cell-income') && !e.target.closest('.drag-handle-income'))) {
                    this.setAttribute('draggable', 'false');
                } else {
                    this.setAttribute('draggable', 'true');
                }
            });

            // CORREÇÃO: Adicionar touch event listeners para mobile
            row.addEventListener('touchmove', handleTouchDragMoveIncome, { passive: false });
            row.addEventListener('touchend', handleTouchDragEndIncome, { passive: false });
        });
    }

    // CORREÇÃO: Variáveis para mobile drag de income
    let touchDraggedIncomeRow = null;
    let touchStartYIncome = 0;
    let touchCurrentYIncome = 0;

    function handleTouchDragStartIncome(e, row) {
        // Ignore if in edit mode or not on drag handle
        if (row.dataset.mode === 'edit') return;
        if (!e.target.closest('.drag-handle-income')) return;

        e.preventDefault();
        touchDraggedIncomeRow = row;
        touchStartYIncome = e.touches[0].clientY;
        touchCurrentYIncome = touchStartYIncome;

        // Visual feedback
        row.style.opacity = '0.4';
        row.classList.add('dragging');

        // Disable pointer events on other rows to prevent conflicts
        document.querySelectorAll('tr.swipeable-row-income').forEach(r => {
            if (r !== row) {
                r.style.pointerEvents = 'none';
            }
        });
    }

    function handleTouchDragMoveIncome(e) {
        if (!touchDraggedIncomeRow) return;
        if (this !== touchDraggedIncomeRow) return;

        e.preventDefault();
        touchCurrentYIncome = e.touches[0].clientY;

        const deltaY = touchCurrentYIncome - touchStartYIncome;

        // Find the row under the touch point
        const elementBelow = document.elementFromPoint(
            e.touches[0].clientX,
            e.touches[0].clientY
        );

        const rowBelow = elementBelow ? elementBelow.closest('tr.swipeable-row-income') : null;

        // Remove previous highlights
        document.querySelectorAll('tr.swipeable-row-income').forEach(r => {
            r.classList.remove('border-t-2', 'border-primary', 'border-b-2');
        });

        // Highlight the target row
        if (rowBelow && rowBelow !== touchDraggedIncomeRow && rowBelow.id !== 'new-income-template') {
            if (deltaY > 0) {
                // Dragging down
                rowBelow.classList.add('border-b-2', 'border-primary');
            } else {
                // Dragging up
                rowBelow.classList.add('border-t-2', 'border-primary');
            }
        }

        // Visual feedback - move the row
        touchDraggedIncomeRow.style.transform = `translateY(${deltaY}px)`;
    }

    function handleTouchDragEndIncome(e) {
        if (!touchDraggedIncomeRow) return;
        if (this !== touchDraggedIncomeRow) return;

        e.preventDefault();

        const deltaY = touchCurrentYIncome - touchStartYIncome;

        const rect = touchDraggedIncomeRow.getBoundingClientRect();
        const centerX = rect.left + (rect.width / 2);

        touchDraggedIncomeRow.style.visibility = 'hidden';
        const elementBelow = document.elementFromPoint(centerX, touchCurrentYIncome);
        touchDraggedIncomeRow.style.visibility = '';

        let targetRow = elementBelow ? elementBelow.closest('tr.swipeable-row-income') : null;

        if (!targetRow) {
            const tbody = document.getElementById('income-items-body');
            const allRows = Array.from(tbody.querySelectorAll('tr.swipeable-row-income:not(#new-income-template)'));

            let closestRow = null;
            let closestDistance = Infinity;

            allRows.forEach(function(row) {
                if (row === touchDraggedIncomeRow) return;

                const rowRect = row.getBoundingClientRect();
                const rowCenterY = rowRect.top + (rowRect.height / 2);
                const distance = Math.abs(touchCurrentYIncome - rowCenterY);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestRow = row;
                }
            });

            if (closestRow) {
                targetRow = closestRow;
            }
        }

        // Perform the drop
        if (targetRow && targetRow !== touchDraggedIncomeRow && targetRow.id !== 'new-income-template') {
            const tbody = document.getElementById('income-items-body');
            const allRows = Array.from(tbody.querySelectorAll('tr.swipeable-row-income'));

            const draggedIndex = allRows.indexOf(touchDraggedIncomeRow);
            const targetIndex = allRows.indexOf(targetRow);

            // Move the row
            if (deltaY > 0) {
                // Dragging down - insert after target
                targetRow.parentNode.insertBefore(touchDraggedIncomeRow, targetRow.nextSibling);
            } else {
                // Dragging up - insert before target
                targetRow.parentNode.insertBefore(touchDraggedIncomeRow, targetRow);
            }

            // Save new order to backend
            saveIncomeItemsOrder();
        }

        // Reset visual feedback
        touchDraggedIncomeRow.style.opacity = '1';
        touchDraggedIncomeRow.style.transform = '';
        touchDraggedIncomeRow.classList.remove('dragging');

        // Re-enable pointer events on all rows
        document.querySelectorAll('tr.swipeable-row-income').forEach(r => {
            r.style.pointerEvents = '';
        });

        // Remove all highlights
        document.querySelectorAll('tr.swipeable-row-income').forEach(r => {
            r.classList.remove('border-t-2', 'border-primary', 'border-b-2');
        });

        // Reset variables
        touchDraggedIncomeRow = null;
        touchStartYIncome = 0;
        touchCurrentYIncome = 0;
    }

    function handleDragStartIncome(e) {
        draggedIncomeRow = this;
        this.style.opacity = '0.4';
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    }

    function handleDragOverIncome(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnterIncome(e) {
        if (this !== draggedIncomeRow) {
            this.classList.add('border-t-2', 'border-primary');
            draggedOverIncomeRow = this;
        }
    }

    function handleDragLeaveIncome(e) {
        this.classList.remove('border-t-2', 'border-primary');
    }

    function handleDropIncome(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedIncomeRow !== this) {
            const tbody = document.getElementById('income-items-body');
            const allRows = Array.from(tbody.querySelectorAll('tr.swipeable-row-income'));

            const draggedIndex = allRows.indexOf(draggedIncomeRow);
            const targetIndex = allRows.indexOf(this);

            // Move the dragged row
            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedIncomeRow, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedIncomeRow, this);
            }

            // Save new order to backend
            saveIncomeItemsOrder();
        }

        return false;
    }

    function handleDragEndIncome(e) {
        this.style.opacity = '1';

        // Remove all drag-related classes
        const rows = document.querySelectorAll('tr.swipeable-row-income');
        rows.forEach(row => {
            row.classList.remove('border-t-2', 'border-primary');
        });

        draggedIncomeRow = null;
        draggedOverIncomeRow = null;
    }

    function saveIncomeItemsOrder() {
        const tbody = document.getElementById('income-items-body');
        const rows = tbody.querySelectorAll('tr.swipeable-row-income');

        const orderData = [];
        rows.forEach((row, index) => {
            // CORREÇÃO: Ignorar template row (new-income-template ou qualquer id que não comece com income-item-)
            if (!row.id.startsWith('income-item-')) {
                return;
            }
            const itemId = row.id.replace('income-item-', '');
            if (itemId && itemId !== 'NEW' && !isNaN(itemId)) {
                orderData.push({
                    id: parseInt(itemId),
                    order: index + 1
                });
            }
        });

        fetch("{% url 'reorder_income_items_ajax' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ items: orderData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Income order saved successfully');
            } else {
                console.error('Error saving income order:', data.error);
                alert('{% trans "Error saving order:" %} ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            alert('{% trans "A network error occurred while saving order." %}');
        });
    }

    // ========== MOBILE-SPECIFIC FUNCTIONALITY FOR INCOME ========== 
    // Initialize mobile swipe and tap functionality for income items
    (function initMobileIncomeFeatures() {
        'use strict';

        const isMobile = window.matchMedia('(max-width: 768px)').matches;

        if (!isMobile) {
            console.log('[MOBILE INCOME] Not mobile viewport, skipping mobile features');
            return; // Only run on mobile devices
        }

        console.log('[MOBILE INCOME] Initializing mobile features for income items');
        const swipeableRows = document.querySelectorAll('.swipeable-row-income');
        console.log('[MOBILE INCOME] Found', swipeableRows.length, 'swipeable rows');

        swipeableRows.forEach(row => {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let startTime = 0;
            const swipeThreshold = 60; // Minimum pixels to trigger swipe
            const tapTimeThreshold = 200; // Max ms for tap detection

            // CORREÇÃO: Variáveis para detectar drag vertical vs swipe horizontal
            let startY = 0;
            let currentY = 0;
            let isDragMode = false; // true = vertical drag, false = horizontal swipe
            let isDecided = false; // se já decidimos o modo

            // Touch start
            row.addEventListener('touchstart', (e) => {
                // CORREÇÃO: Se começou no drag handle, NÃO processar swipe
                const isDragHandle = e.target.closest('.drag-handle-income');
                if (isDragHandle) {
                    // Drag handle vai cuidar, não processar swipe aqui
                    return;
                }

                // Ignore if touching action buttons or check icon
                if (e.target.closest('.mobile-action-btn-income')) return;
                if (e.target.closest('.edit-save-icon-income')) return;

                startX = e.touches[0].clientX;
                currentX = startX;
                startY = e.touches[0].clientY;
                currentY = startY;
                startTime = Date.now();
                isDragging = false;
                isDecided = false;
                isDragMode = false;
            }, { passive: true });

            // Touch move
            row.addEventListener('touchmove', (e) => {
                // Se já decidiu que é drag, ignora swipe
                if (isDragMode) return;

                if (e.target.closest('.mobile-action-btn-income')) return;
                if (e.target.closest('.edit-save-icon-income')) return;

                currentX = e.touches[0].clientX;
                currentY = e.touches[0].clientY;
                const deltaX = currentX - startX;
                const deltaY = currentY - startY;

                // Processar apenas swipe horizontal
                // In edit mode: allow swipe right to cancel
                if (row.dataset.mode === 'edit') {
                    if (deltaX > 0) {
                        isDragging = true;
                        const translateX = Math.min(deltaX, 120);
                        row.style.transform = `translateX(${translateX}px)`;
                        row.style.transition = 'none';
                    }
                } else {
                    // In display mode: allow swipe left to reveal actions
                    if (deltaX < 0) {
                        isDragging = true;
                        const translateX = Math.max(deltaX, -120);
                        row.style.transform = `translateX(${translateX}px)`;
                        row.style.transition = 'none';
                    }
                }
            }, { passive: true });

            // Touch end
            row.addEventListener('touchend', (e) => {
                // Se foi drag, não processar swipe
                if (isDragMode) return;

                const deltaX = currentX - startX;
                const deltaTime = Date.now() - startTime;
                row.style.transition = 'transform 0.3s ease-out';

                // In edit mode: swipe right to cancel
                if (row.dataset.mode === 'edit') {
                    if (deltaX > swipeThreshold) {
                        console.log('[MOBILE INCOME SWIPE] Canceling edit mode for:', row.id);
                        toggleEditMode(row.id, false);
                    } else {
                        row.style.transform = 'translateX(0)';
                    }
                } else {
                    // Tap detection for realized toggle
                    if (!isDragging && Math.abs(deltaX) < 10 && deltaTime < tapTimeThreshold) {
                        const rowId = row.id;
                        console.log('[MOBILE INCOME TAP] Toggling realized:', rowId);
                        toggleIncomeRealized(rowId);
                    }
                    // Swipe left to reveal actions
                    else if (deltaX < -swipeThreshold) {
                        row.style.transform = 'translateX(-120px)';
                        row.classList.add('actions-revealed-income');
                    } else {
                        row.style.transform = 'translateX(0)';
                        row.classList.remove('actions-revealed-income');
                    }
                }

                isDragging = false;
                isDecided = false;
                isDragMode = false;
            }, { passive: true });

            // Close actions when tapping outside
            document.addEventListener('touchstart', (e) => {
                if (!row.contains(e.target) && row.classList.contains('actions-revealed-income')) {
                    row.style.transform = 'translateX(0)';
                    row.classList.remove('actions-revealed-income');
                }
            }, { passive: true });
        });

        // Add change event listener to all income date inputs to update display value
        const dateInputs = document.querySelectorAll('.date-input-field-income');
        dateInputs.forEach(input => {
            // Set initial display value
            const dateValue = input.value; // YYYY-MM-DD format
            if (dateValue) {
                const [year, month, day] = dateValue.split('-');
                const displayValue = `${day}/${month}`;
                input.setAttribute('data-display-value', displayValue);
            }

            // Update display value when date changes
            input.addEventListener('change', function() {
                const dateValue = this.value; // YYYY-MM-DD format
                if (dateValue) {
                    const [year, month, day] = dateValue.split('-');
                    const displayValue = `${day}/${month}`;
                    this.setAttribute('data-display-value', displayValue);
                    console.log('[MOBILE INCOME DATE] Updated display value:', displayValue);
                }
            });
        });
    })();

    // Note: normalizeDecimalInput function removed - backend now handles all locale parsing

    // Mobile keyboard handling - scroll input into view when keyboard opens
    function initMobileKeyboardHandling() {
        // Só executa em mobile
        if (window.innerWidth > 768) return;

        const inputs = document.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                // Timeout para aguardar teclado aparecer
                setTimeout(() => {
                    if (window.visualViewport) {
                        const keyboardHeight = window.innerHeight - window.visualViewport.height;

                        if (keyboardHeight > 50) { // Teclado está visível
                            this.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center',
                                inline: 'nearest'
                            });
                        }
                    } else {
                        // Fallback para browsers sem visualViewport API
                        this.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                    }
                }, 300); // Aguarda 300ms para teclado aparecer
            });
        });
    }

    // Inicializar quando DOM carregar
    document.addEventListener('DOMContentLoaded', function() {
        initMobileKeyboardHandling();
    });
</script>

<style>
    /* Mobile-specific CSS for Dashboard */
    @media (max-width: 768px) {
        /* Hide columns on mobile */
        .mobile-hide-column {
            display: none !important;
        }

        /* Hide badges on mobile to save space */
        .mobile-hide-badge {
            display: none !important;
        }

        /* ========== INCOME TABLE MOBILE STYLES ========== */

        /* Swipeable row styles */
        .swipeable-row-income {
            position: relative;
            transition: transform 0.3s ease-out;
            will-change: transform;
        }

        /* Amount cell needs to be positioned to contain absolute buttons */
        .amount-cell-with-actions {
            position: relative;
            overflow: visible;
        }

        /* Mobile actions container (hidden behind row, revealed on swipe left) */
        .mobile-actions-btns-income {
            position: absolute;
            right: -120px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            z-index: 10;
            pointer-events: none;
        }

        .swipeable-row-income.actions-revealed-income .mobile-actions-btns-income {
            pointer-events: auto;
        }

        .mobile-action-btn-income {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            pointer-events: auto;
            border: none;
            cursor: pointer;
        }

        .mobile-action-btn-income.edit-btn-income {
            background-color: #3b82f6;
            color: white;
        }

        .mobile-action-btn-income.edit-btn-income:active {
            background-color: #2563eb;
            transform: scale(0.95);
        }

        .mobile-action-btn-income.delete-btn-income {
            background-color: #ef4444;
            color: white;
        }

        .mobile-action-btn-income.delete-btn-income:active {
            background-color: #dc2626;
            transform: scale(0.95);
        }

        /* Realized status visual feedback */
        .row-realized-income {
            background-color: rgba(34, 197, 94, 0.15) !important;
        }

        .dark .row-realized-income {
            background-color: rgba(34, 197, 94, 0.1) !important;
        }

        .row-not-realized-income {
            background-color: rgba(148, 163, 184, 0.08) !important;
        }

        .dark .row-not-realized-income {
            background-color: rgba(148, 163, 184, 0.05) !important;
        }

        /* Disable drag handle on mobile in display mode */
        .drag-handle-cell-income .drag-handle-income {
            cursor: default;
            opacity: 0.3;
        }

        /* Edit save icon styling */
        .edit-save-icon-income {
            border: none;
            background: transparent;
            padding: 0;
            cursor: pointer;
        }

        /* Ensure table doesn't clip buttons */
        #income-items-body {
            overflow: visible;
        }

        tbody tr {
            overflow: visible;
        }

        /* Make date input work as a button - tap anywhere opens calendar */
        .date-input-field-income {
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 0.25rem;
            border-radius: 0.375rem;
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .dark .date-input-field-income {
            background-color: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        /* Make entire input clickable - calendar icon spans full width */
        .date-input-field-income::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
            cursor: pointer;
        }

        /* Hide the text but keep input functional */
        .date-input-field-income {
            color: transparent;
            font-size: 0;
        }

        /* Show the actual date value using custom content */
        .date-input-field-income::before {
            content: attr(data-display-value);
            color: #3b82f6;
            font-size: 0.75rem;
            font-weight: 500;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .dark .date-input-field-income::before {
            color: #60a5fa;
        }

        /* Position parent cell for absolute positioning */
        .cell-date-edit {
            position: relative;
        }
    }

    /* Desktop: hide mobile action buttons */
    @media (min-width: 769px) {
        .mobile-actions-btns-income {
            display: none !important;
        }

        .edit-save-icon-income {
            display: none !important;
        }
    }
</style>

<script>
/**
 * Real-time Updates for Dashboard
 * Handles WebSocket broadcasts to update the income transactions list
 */
(function() {
    'use strict';

    // Dashboard Real-time Updates Namespace
    window.DashboardRealtime = {
        /**
         * Add new transaction to the list
         */
        addTransaction: function(transactionData) {
            console.log('[Dashboard RT] Adding new transaction:', transactionData);

            // Check if transaction is income type (since dashboard shows income)
            if (!transactionData.is_income) {
                console.log('[Dashboard RT] Transaction is not income, skipping');
                return;
            }

            const tbody = document.getElementById('income-items-body');
            if (!tbody) {
                console.warn('[Dashboard RT] Income tbody not found');
                return;
            }

            // Check if transaction already exists (avoid duplicates)
            const existingRow = document.getElementById(`income-item-${transactionData.id}`);
            if (existingRow) {
                console.log('[Dashboard RT] Transaction already exists, updating instead');
                this.updateTransaction(transactionData);
                return;
            }

            // Create new row
            const newRow = this._createTransactionRow(transactionData);

            // Insert at the beginning of tbody
            tbody.insertBefore(newRow, tbody.firstChild);

            // Add fade-in animation
            setTimeout(() => {
                newRow.style.transition = 'background-color 0.5s ease';
                newRow.style.backgroundColor = '';
            }, 100);

            console.log('[Dashboard RT] Transaction added successfully');
        },

        /**
         * Update existing transaction
         */
        updateTransaction: function(transactionData) {
            const row = document.getElementById(`income-item-${transactionData.id}`);
            if (!row) {
                return;
            }

            try {
                // Update description
                const descDisplay = row.querySelector('.cell-description-display');
                if (descDisplay) {
                    descDisplay.textContent = transactionData.description;
                }
                const descInput = row.querySelector('input[data-field="description"]');
                if (descInput) {
                    descInput.value = transactionData.description;
                }

                // Update date
                if (transactionData.date) {
                    const dateDisplay = row.querySelector('.cell-date-display');
                    if (dateDisplay) {
                        const dateObj = new Date(transactionData.date);
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        dateDisplay.textContent = `${day}/${month}`;
                    }
                    const dateInput = row.querySelector('input[data-field="date"]');
                    if (dateInput) {
                        dateInput.value = transactionData.date;
                    }
                    row.dataset.date = transactionData.date;
                }

                // Update amount
                if (transactionData.amount) {
                    const amountDisplay = row.querySelector('.cell-amount-display');
                    if (amountDisplay) {
                        const formattedAmount = window.RealtimeUI.utils.formatCurrency(transactionData.amount);
                        amountDisplay.textContent = formattedAmount;
                    }
                    const amountInput = row.querySelector('input[data-field="amount"]');
                    if (amountInput && typeof formatAmountForInput === 'function') {
                        amountInput.value = formatAmountForInput(transactionData.amount);
                    } else if (amountInput) {
                        amountInput.value = transactionData.amount;
                    }
                    row.dataset.amount = transactionData.amount;
                }

                // Update is_fixed
                if (typeof transactionData.is_fixed !== 'undefined') {
                    row.dataset.isFixed = transactionData.is_fixed ? 'true' : 'false';
                }

                // Update realized status
                if (typeof transactionData.realized !== 'undefined') {
                    row.dataset.realized = transactionData.realized ? 'true' : 'false';

                    // Update row background class
                    if (transactionData.realized) {
                        row.classList.remove('row-not-realized-income');
                        row.classList.add('row-realized-income');
                    } else {
                        row.classList.remove('row-realized-income');
                        row.classList.add('row-not-realized-income');
                    }

                    // Update toggle button
                    const toggleBtn = row.querySelector('.income-realized-toggle');
                    if (toggleBtn) {
                        if (transactionData.realized) {
                            toggleBtn.classList.add('bg-green-500');
                            toggleBtn.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                        } else {
                            toggleBtn.classList.remove('bg-green-500');
                            toggleBtn.classList.add('bg-gray-300', 'dark:bg-gray-600');
                        }

                        const toggleSpan = toggleBtn.querySelector('span');
                        if (toggleSpan) {
                            if (transactionData.realized) {
                                toggleSpan.classList.add('translate-x-4');
                            } else {
                                toggleSpan.classList.remove('translate-x-4');
                            }
                        }
                    }

                    // Update amount cell color (4th column)
                    const amountCell = row.querySelector('td:nth-child(4)');
                    if (amountCell) {
                        if (transactionData.realized) {
                            amountCell.classList.add('text-green-600', 'dark:text-green-500');
                            amountCell.classList.remove('text-gray-400', 'dark:text-gray-500');
                        } else {
                            amountCell.classList.remove('text-green-600', 'dark:text-green-500');
                            amountCell.classList.add('text-gray-400', 'dark:text-gray-500');
                        }
                    }
                }

                // Highlight the updated row to show it changed
                if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
                    window.RealtimeUI.utils.highlightElement(row, 2000);
                } else {
                    row.style.backgroundColor = 'rgba(250, 204, 21, 0.3)';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 2000);
                }

                // Update balance sheet, key metrics, and charts
                if (typeof updateBalanceSheet === 'function') {
                    updateBalanceSheet();
                }
            } catch (error) {
                console.error('[Dashboard RT] Error updating transaction:', error);
            }
        },

        /**
         * Remove transaction from the list
         */
        removeTransaction: function(transactionId) {
            console.log('[Dashboard RT] Removing transaction:', transactionId);

            const row = document.getElementById(`income-item-${transactionId}`);
            if (!row) {
                console.warn('[Dashboard RT] Transaction row not found');
                return;
            }

            // Fade out animation
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';

            setTimeout(() => {
                if (row.parentNode) {
                    row.parentNode.removeChild(row);
                    console.log('[Dashboard RT] Transaction removed successfully');
                }
            }, 300);
        },

        /**
         * Create a new transaction row element
         * @private
         */
        _createTransactionRow: function(data) {
            const tr = document.createElement('tr');
            tr.id = `income-item-${data.id}`;
            tr.dataset.itemId = data.id;
            tr.dataset.mode = 'display';
            tr.dataset.realized = data.realized ? 'true' : 'false';
            tr.dataset.isFixed = data.is_fixed ? 'true' : 'false';
            tr.dataset.date = data.date;
            tr.dataset.amount = data.amount;
            tr.className = `swipeable-row-income ${data.realized ? 'row-realized-income' : 'row-not-realized-income'} hover:bg-slate-50 dark:hover:bg-gray-700/50`;
            tr.style.backgroundColor = 'rgba(34, 197, 94, 0.1)'; // Initial highlight

            // Format date for display
            let dateDisplay = '';
            if (data.date) {
                const dateObj = new Date(data.date);
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                dateDisplay = `${day}/${month}`;
            }

            // Format amount
            const formattedAmount = window.RealtimeUI.utils.formatCurrency(data.amount);

            tr.innerHTML = `
                <td class="px-2 py-4 text-center drag-handle-cell-income" data-row-id="income-item-${data.id}">
                    <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle-income cursor-grab active:cursor-grabbing">drag_indicator</span>
                    <button type="button" onclick="saveItem('income-item-${data.id}')" class="edit-save-icon-income" style="display: none;">
                        <span class="material-symbols-outlined text-green-500 text-2xl">check_circle</span>
                    </button>
                </td>

                <td class="py-3 px-3 text-sm text-[#0d171b] dark:text-white">
                    <div class="cell-description-display"></div>
                    <div class="cell-description-edit hidden">
                        <input type="text" data-field="description" class="w-full border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs p-1" value="${data.description}">
                    </div>
                </td>

                <td class="py-3 px-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                    <div class="cell-date-display">${dateDisplay}</div>
                    <div class="cell-date-edit hidden">
                        <input type="date" data-field="date" class="w-full border-b border-primary dark:text-white dark:bg-gray-800 bg-transparent focus:outline-none focus:ring-0 text-xs p-1 date-input-field-income" value="${data.date}">
                    </div>
                </td>

                <td class="py-3 px-3 text-sm text-right ${data.realized ? 'text-green-600 dark:text-green-500' : 'text-gray-400 dark:text-gray-500'} amount-cell-with-actions">
                    <div class="cell-amount-display">${formattedAmount}</div>
                    <div class="cell-amount-edit hidden">
                        <input type="text" inputmode="decimal" data-field="amount" class="w-20 border-b border-primary bg-transparent focus:outline-none focus:ring-0 text-xs text-right p-1" value="${data.amount}">
                    </div>

                    <div class="mobile-actions-btns-income">
                        <button type="button" onclick="toggleEditMode('income-item-${data.id}', true)" class="mobile-action-btn-income edit-btn-income">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button type="button" onclick="deleteItem('income-item-${data.id}')" class="mobile-action-btn-income delete-btn-income">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </td>

                <td class="py-3 px-2 text-center mobile-hide-column">
                    <button type="button" onclick="toggleIncomeRealized('income-item-${data.id}')" class="income-realized-toggle relative inline-block w-10 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer ${data.realized ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'}">
                        <span class="absolute left-1 top-1 inline-block w-4 h-4 transition-transform duration-200 ease-in-out transform bg-white rounded-full ${data.realized ? 'translate-x-4' : ''}"></span>
                    </button>
                </td>

                <td class="px-2 py-3 text-center whitespace-nowrap mobile-hide-column">
                    <div class="actions-display flex justify-center gap-1">
                        <button type="button" onclick="toggleEditMode('income-item-${data.id}', true)" class="p-1 text-slate-500 hover:text-primary"><span class="material-symbols-outlined text-lg">edit</span></button>
                        <button type="button" onclick="deleteItem('income-item-${data.id}')" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">delete</span></button>
                    </div>
                    <div class="actions-edit hidden flex justify-center gap-1">
                        <button type="button" onclick="saveItem('income-item-${data.id}')" class="p-1 text-primary hover:text-primary/80"><span class="material-symbols-outlined text-lg">check</span></button>
                        <button type="button" onclick="toggleEditMode('income-item-${data.id}', false)" class="p-1 text-slate-500 hover:text-red-500"><span class="material-symbols-outlined text-lg">close</span></button>
                    </div>
                </td>
            `;

            // Set description using textContent for security
            tr.querySelector('.cell-description-display').textContent = data.description;

            return tr;
        },

        /**
         * Add new FlowGroup to the Expense Groups table
         */
        addFlowGroup: function(flowgroupData) {
            console.log('[Dashboard RT] Adding new FlowGroup:', flowgroupData);

            const tbody = document.getElementById('expense-groups-tbody');
            if (!tbody) {
                console.warn('[Dashboard RT] Expense groups tbody not found');
                return;
            }

            // Check if FlowGroup already exists (avoid duplicates)
            const existingRow = tbody.querySelector(`tr[data-group-id="${flowgroupData.id}"]`);
            if (existingRow) {
                console.log('[Dashboard RT] FlowGroup already exists, updating instead');
                this.updateFlowGroup(flowgroupData);
                return;
            }

            // Create new row (simplified version - real implementation would match template exactly)
            const newRow = document.createElement('tr');
            newRow.dataset.groupId = flowgroupData.id;
            newRow.dataset.order = flowgroupData.order || 0;
            newRow.dataset.accessible = 'true';
            newRow.className = 'draggable-row cursor-default hover:bg-gray-50 dark:hover:bg-gray-700/30 group-row-clickable';
            newRow.draggable = true;

            const currencySymbol = window.currencySymbol || 'R$';
            const estimatedFormatted = window.RealtimeUI.utils.formatCurrency(flowgroupData.budgeted_amount || '0.00');
            const realizedFormatted = window.RealtimeUI.utils.formatCurrency('0.00');

            newRow.innerHTML = `
                <td class="px-2 py-4 text-center drag-handle-cell">
                    <span class="material-symbols-outlined text-gray-400 dark:text-gray-500 drag-handle cursor-grab active:cursor-grabbing">drag_indicator</span>
                </td>
                <td class="py-4 px-4 text-sm text-[#0d171b] dark:text-white">
                    <div class="flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                            <span>${flowgroupData.name}</span>
                        </div>
                    </div>
                </td>
                <td class="py-4 px-4 text-sm text-gray-500 dark:text-gray-400 text-right group-estimated" data-value="0.00">
                    ${estimatedFormatted}
                </td>
                <td class="py-4 px-4 text-sm text-red-600 dark:text-red-500 text-right group-realized" data-value="0.00">
                    ${realizedFormatted}
                </td>
            `;

            // Insert at the end (before "empty" message row if exists)
            const emptyRow = tbody.querySelector('tr td[colspan]');
            if (emptyRow) {
                emptyRow.parentElement.remove();
            }
            tbody.appendChild(newRow);

            // Add highlight animation
            if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
                window.RealtimeUI.utils.highlightElement(newRow, 2000);
            }

            // Update balance sheet
            if (typeof updateBalanceSheet === 'function') {
                updateBalanceSheet();
            }

            // Update pie chart
            if (typeof updatePieChart === 'function') {
                updatePieChart();
            }

            console.log('[Dashboard RT] FlowGroup added successfully');
        },

        /**
         * Update existing FlowGroup in the Expense Groups table
         */
        updateFlowGroup: function(flowgroupData) {
            console.log('[Dashboard RT] Updating FlowGroup:', flowgroupData);

            const row = document.querySelector(`tr[data-group-id="${flowgroupData.id}"]`);
            if (!row) {
                console.warn('[Dashboard RT] FlowGroup row not found');
                return;
            }

            try {
                // Update name (2nd column)
                const nameCell = row.querySelector('td:nth-child(2) span');
                if (nameCell) {
                    nameCell.textContent = flowgroupData.name;
                }

                // Check for budget warning
                const budgetedAmount = parseFloat(flowgroupData.budgeted_amount) || 0;
                const totalEstimated = parseFloat(flowgroupData.total_estimated) || 0;
                const hasBudgetWarning = totalEstimated > budgetedAmount;

                // Update estimated (3rd column) with budget warning logic
                const estimatedCell = row.querySelector('.group-estimated');
                if (estimatedCell) {
                    // Show budgeted_amount normally, or total_estimated if over budget
                    const displayValue = hasBudgetWarning ? flowgroupData.total_estimated : flowgroupData.budgeted_amount;
                    const formattedEstimated = window.RealtimeUI.utils.formatCurrency(displayValue || '0.00');
                    estimatedCell.textContent = formattedEstimated;
                    estimatedCell.dataset.value = displayValue || '0.00';

                    // Update CSS classes for budget warning
                    estimatedCell.classList.remove('text-gray-500', 'dark:text-gray-400', 'text-yellow-600', 'dark:text-yellow-500', 'font-semibold');
                    if (hasBudgetWarning) {
                        estimatedCell.classList.add('text-yellow-600', 'dark:text-yellow-500', 'font-semibold');
                    } else {
                        estimatedCell.classList.add('text-gray-500', 'dark:text-gray-400');
                    }
                }

                // Update or add budget warning message
                const nameContainer = row.querySelector('td:nth-child(2) .flex.flex-col');
                if (nameContainer) {
                    // Remove existing warning if present
                    const existingWarning = nameContainer.querySelector('.text-xs.text-yellow-600');
                    if (existingWarning) {
                        existingWarning.remove();
                    }

                    // Add warning if over budget
                    if (hasBudgetWarning) {
                        const warningDiv = document.createElement('div');
                        warningDiv.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-medium';
                        warningDiv.textContent = '{% trans "⚠ Over budget" %}';
                        nameContainer.appendChild(warningDiv);
                    }
                }

                // Update realized (4th column)
                const realizedCell = row.querySelector('.group-realized');
                if (realizedCell) {
                    const formattedRealized = window.RealtimeUI.utils.formatCurrency(flowgroupData.total_realized || '0.00');
                    realizedCell.textContent = formattedRealized;
                    realizedCell.dataset.value = flowgroupData.total_realized || '0.00';
                }

                // Highlight the updated row
                if (window.RealtimeUI && window.RealtimeUI.utils && window.RealtimeUI.utils.highlightElement) {
                    window.RealtimeUI.utils.highlightElement(row, 2000);
                }

                // Update balance sheet
                if (typeof updateBalanceSheet === 'function') {
                    updateBalanceSheet();
                }

                // Update pie chart
                if (typeof updatePieChart === 'function') {
                    updatePieChart();
                }
            } catch (error) {
                console.error('[Dashboard RT] Error updating FlowGroup:', error);
            }
        },

        /**
         * Remove FlowGroup from the Expense Groups table
         */
        removeFlowGroup: function(flowgroupId) {
            console.log('[Dashboard RT] Removing FlowGroup:', flowgroupId);

            const row = document.querySelector(`tr[data-group-id="${flowgroupId}"]`);
            if (!row) {
                console.warn('[Dashboard RT] FlowGroup row not found');
                return;
            }

            // Fade out animation
            row.style.transition = 'opacity 0.3s ease';
            row.style.opacity = '0';

            setTimeout(() => {
                if (row.parentNode) {
                    row.parentNode.removeChild(row);

                    // Check if table is now empty, add "No groups" message
                    const tbody = document.getElementById('expense-groups-tbody');
                    if (tbody && tbody.children.length === 0) {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.setAttribute('colspan', '4');
                        emptyCell.className = 'py-4 px-4 text-center text-gray-500';
                        emptyCell.textContent = '{% trans "No expense groups defined. Click \"Add Group\" to start." %}';
                        emptyRow.appendChild(emptyCell);
                        tbody.appendChild(emptyRow);
                    }

                    // Update balance sheet
                    if (typeof updateBalanceSheet === 'function') {
                        updateBalanceSheet();
                    }

                    // Update pie chart
                    if (typeof updatePieChart === 'function') {
                        updatePieChart();
                    }

                    console.log('[Dashboard RT] FlowGroup removed successfully');
                }
            }, 300);
        },

        /**
         * Reorder FlowGroups in the table
         */
        reorderFlowGroups: function(groupsData) {
            console.log('[Dashboard RT] Reordering FlowGroups:', groupsData);

            const tbody = document.getElementById('expense-groups-tbody');
            if (!tbody) {
                console.warn('[Dashboard RT] Expense groups tbody not found');
                return;
            }

            // Create a map of group_id -> order
            const orderMap = {};
            groupsData.forEach(function(group) {
                orderMap[group.id] = group.order;
            });

            // Update data-order attributes
            const rows = Array.from(tbody.querySelectorAll('tr[data-group-id]'));
            rows.forEach(function(row) {
                const groupId = row.dataset.groupId;
                if (orderMap[groupId]) {
                    row.dataset.order = orderMap[groupId];
                }
            });

            // Sort rows by order
            rows.sort(function(a, b) {
                const orderA = parseInt(a.dataset.order) || 0;
                const orderB = parseInt(b.dataset.order) || 0;
                return orderA - orderB;
            });

            // Re-append rows in new order
            rows.forEach(function(row) {
                tbody.appendChild(row);
            });

            console.log('[Dashboard RT] FlowGroups reordered successfully');
        }
    };

    console.log('[Dashboard RT] Real-time updates initialized');
})();
</script>

{% endblock content %}