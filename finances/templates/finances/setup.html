{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>SweetMoney - Initial Setup</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0D9488",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101c22",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-teal-50 to-blue-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl">
        
        {% if needs_migration %}
        <!-- Migration in Progress Card -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-8 text-white text-center">
                <div class="flex justify-center mb-4">
                    <span class="material-symbols-outlined text-6xl animate-spin">settings</span>
                </div>
                <h1 class="text-4xl font-bold mb-2">Setting Up Database</h1>
                <p class="text-blue-100 text-lg">Please wait while we prepare your system...</p>
            </div>
            
            <div class="p-8">
                {% if migration_success %}
                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-green-500">check_circle</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-green-800">Database Setup Complete!</h3>
                            <div class="mt-2 text-sm text-green-700">
                                <p>All database tables have been created successfully.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="window.location.reload()" 
                            class="bg-gradient-to-r from-teal-500 to-teal-600 text-white text-lg font-semibold py-4 px-8 rounded-lg hover:from-teal-600 hover:to-teal-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                        Continue to Setup Form
                    </button>
                </div>
                
                {% elif migration_error %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-red-500">error</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Migration Error</h3>
                            <div class="mt-2 text-sm text-red-700">
                                <p>{{ migration_error }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="window.location.reload()" 
                            class="bg-gray-500 text-white text-lg font-semibold py-4 px-8 rounded-lg hover:bg-gray-600 transition-all duration-200 shadow-lg">
                        Retry Setup
                    </button>
                </div>
                
                {% else %}
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-teal-500 mb-4"></div>
                    <p class="text-gray-600">Running database migrations...</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% else %}
        
        <!-- Welcome Card -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-teal-500 to-teal-600 p-8 text-white text-center">
                <div class="flex justify-center mb-4">
                    <span class="material-symbols-outlined text-6xl">savings</span>
                </div>
                <h1 class="text-4xl font-bold mb-2">Welcome to SweetMoney</h1>
                <p class="text-teal-100 text-lg">Where Is My Money - Family Financial Flow</p>
            </div>
            
            <div class="p-8">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-blue-500">info</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">First Time Setup</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <p>This is your first time accessing SweetMoney. Let's set up your family's financial management system by creating an administrator account.</p>
                            </div>
                        </div>
                    </div>
                </div>

                {% if database_error %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-red-500">error</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Database Error</h3>
                            <div class="mt-2 text-sm text-red-700">
                                {{ database_error }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if form.non_field_errors %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <span class="material-symbols-outlined text-red-500">error</span>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error</h3>
                            <div class="mt-2 text-sm text-red-700">
                                {{ form.non_field_errors }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <form method="POST" action="{% url 'initial_setup' %}" class="space-y-6">
                    {% csrf_token %}
                    
                    <div class="border-b border-gray-200 pb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="material-symbols-outlined mr-2 text-teal-600">family_restroom</span>
                            Family Information
                        </h2>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.family_name.id_for_label }}">
                                Family Name
                                <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   name="{{ form.family_name.name }}" 
                                   id="{{ form.family_name.id_for_label }}"
                                   value="{{ form.family_name.value|default:'' }}"
                                   placeholder="e.g., The Smiths, Johnson Family"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                   required>
                            {% if form.family_name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.family_name.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-1 text-sm text-gray-500">This will be the name of your family's financial group</p>
                        </div>
                    </div>

                    <div class="border-b border-gray-200 pb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="material-symbols-outlined mr-2 text-teal-600">admin_panel_settings</span>
                            Administrator Account
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.username.id_for_label }}">
                                    Username
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       name="{{ form.username.name }}" 
                                       id="{{ form.username.id_for_label }}"
                                       value="{{ form.username.value|default:'' }}"
                                       placeholder="Choose a username"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                       required>
                                {% if form.username.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.username.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.email.id_for_label }}">
                                    Email (Optional)
                                </label>
                                <input type="email" 
                                       name="{{ form.email.name }}" 
                                       id="{{ form.email.id_for_label }}"
                                       value="{{ form.email.value|default:'' }}"
                                       placeholder="your.email@example.com"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                {% if form.email.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.password.id_for_label }}">
                                    Password
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="password" 
                                       name="{{ form.password.name }}" 
                                       id="{{ form.password.id_for_label }}"
                                       placeholder="Minimum 6 characters"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                       required>
                                {% if form.password.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.password.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-sm text-gray-500">Must be at least 6 characters long</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.confirm_password.id_for_label }}">
                                    Confirm Password
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="password" 
                                       name="{{ form.confirm_password.name }}" 
                                       id="{{ form.confirm_password.id_for_label }}"
                                       placeholder="Re-enter your password"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                                       required>
                                {% if form.confirm_password.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.confirm_password.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="border-b border-gray-200 pb-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                            <span class="material-symbols-outlined mr-2 text-teal-600">calendar_month</span>
                            Financial Cycle Settings
                        </h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Period Frequency
                                    <span class="text-red-500">*</span>
                                </label>
                                <div class="space-y-3">
                                    {% for radio in form.period_type %}
                                    <label class="flex items-center gap-3 border border-gray-300 p-4 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                        {{ radio.tag }}
                                        <div class="flex grow flex-col">
                                            <p class="text-gray-900 text-sm font-medium">{{ radio.choice_label }}</p>
                                            {% if radio.choice_value == 'M' %}
                                            <p class="text-xs text-gray-500">Budget resets monthly on a specific day</p>
                                            {% elif radio.choice_value == 'B' %}
                                            <p class="text-xs text-gray-500">Budget resets every 2 weeks</p>
                                            {% elif radio.choice_value == 'W' %}
                                            <p class="text-xs text-gray-500">Budget resets weekly</p>
                                            {% endif %}
                                        </div>
                                    </label>
                                    {% endfor %}
                                </div>
                                {% if form.period_type.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.period_type.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.starting_day.id_for_label }}">
                                    Starting Day (for Monthly Cycle)
                                </label>
                                <input type="number" 
                                       name="{{ form.starting_day.name }}" 
                                       id="{{ form.starting_day.id_for_label }}"
                                       value="{{ form.starting_day.value|default:'1' }}"
                                       min="1" 
                                       max="31"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                {% if form.starting_day.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.starting_day.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-sm text-gray-500">Day of the month (1-31) when your budget cycle starts</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="{{ form.base_date.id_for_label }}">
                                    Base Date (for Bi-weekly/Weekly cycles)
                                </label>
                                <input type="date" 
                                       name="{{ form.base_date.name }}" 
                                       id="{{ form.base_date.id_for_label }}"
                                       value="{{ form.base_date.value|default:'' }}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                {% if form.base_date.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.base_date.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-sm text-gray-500">Reference date for calculating bi-weekly/weekly periods</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-teal-50 rounded-lg p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="material-symbols-outlined text-teal-600">check_circle</span>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-teal-800">What happens next?</h3>
                                <div class="mt-2 text-sm text-teal-700">
                                    <ul class="list-disc list-inside space-y-1">
                                        <li>Your family account will be created</li>
                                        <li>You'll be logged in as the administrator</li>
                                        <li>You can start managing your family's finances immediately</li>
                                        <li>You can add other family members from the Settings page</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-teal-500 to-teal-600 text-white text-lg font-semibold py-4 px-6 rounded-lg hover:from-teal-600 hover:to-teal-700 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">rocket_launch</span>
                            Complete Setup & Get Started
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% endif %}

        <div class="text-center text-gray-600 text-sm">
            <p>Â© 2025 SweetMoney - Family Financial Flow Management</p>
        </div>
    </div>
</body>
</html>
