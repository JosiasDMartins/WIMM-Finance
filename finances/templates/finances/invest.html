{% extends "finances/base.html" %}
{% load static %}
{% load humanize %}
{% load i18n %}

{% block content %}
<main class="p-6 md:p-10 lg:p-12">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-[#0d171b] dark:text-white text-2xl font-bold tracking-[-0.015em] mb-6">{% trans "Family Investments" %}</h1>

        <!-- Available Balance Card -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 dark:from-blue-700 dark:to-blue-800 rounded-xl shadow-lg p-8 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold opacity-90 mb-2">{% trans "Available Investment Balance" %}</h2>
                    <p class="text-4xl font-bold">{{ currency_symbol }} {{ available_balance|intcomma|default:"0.00" }}</p>
                    <p class="text-sm opacity-80 mt-2">{% trans "From investment Flow Groups (realized transactions)" %}</p>
                </div>
                <div class="text-6xl opacity-20">
                    <span class="material-symbols-outlined" style="font-size: 96px;">savings</span>
                </div>
            </div>
        </div>

        <!-- Future Development Notice -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden p-8 text-center">
            <span class="material-symbols-outlined text-6xl text-blue-500 mb-4">construction</span>
            <h2 class="text-2xl font-bold text-[#0d171b] dark:text-white mb-4">{% trans "Coming Soon" %}</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                {% trans "The investments management interface is currently under development." %}
                <br>{% trans "Soon you'll be able to track and manage your family investments directly from this page." %}
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-500">
                {% trans "For now, mark Flow Groups as \"Investment\" in the dashboard to track money set aside for investing." %}
            </p>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
// Investments Real-time Updates
window.InvestmentsRealtime = {
    /**
     * Update investment balance display
     */
    updateBalance: function() {
        console.log('[InvestmentsRT] Updating investment balance...');

        const urlParams = new URLSearchParams(window.location.search);
        const period = urlParams.get('period') || '';
        const url = "{% url 'get_investment_balance_ajax' %}" + (period ? `?period=${period}` : '');

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const balanceElement = document.querySelector('.text-4xl.font-bold');
                if (balanceElement) {
                    // Format the balance with currency symbol and separators
                    const formattedBalance = window.RealtimeUI.utils.formatCurrency(data.available_balance);
                    balanceElement.textContent = formattedBalance;
                    console.log('[InvestmentsRT] Balance updated to:', formattedBalance);
                }
            } else {
                console.error('[InvestmentsRT] Error updating balance:', data.error);
            }
        })
        .catch(error => {
            console.error('[InvestmentsRT] Fetch error:', error);
        });
    },

    /**
     * Handle transaction events - check if it's an investment transaction
     */
    handleTransactionEvent: function(transactionData) {
        // Check if the transaction belongs to an investment FlowGroup
        if (transactionData.is_investment) {
            console.log('[InvestmentsRT] Investment transaction event detected:', transactionData);
            this.updateBalance();
        }
    },

    /**
     * Handle FlowGroup update - check if is_investment flag changed
     */
    handleFlowGroupUpdate: function(flowgroupData) {
        // If a FlowGroup's is_investment flag changed, update balance
        if (flowgroupData.hasOwnProperty('is_investment')) {
            console.log('[InvestmentsRT] FlowGroup investment status changed:', flowgroupData);
            this.updateBalance();
        }
    }
};

// Listen for transaction events
document.addEventListener('realtime:transaction:created', function(event) {
    if (window.InvestmentsRealtime && window.InvestmentsRealtime.handleTransactionEvent) {
        window.InvestmentsRealtime.handleTransactionEvent(event.detail.data);
    }
});

document.addEventListener('realtime:transaction:updated', function(event) {
    if (window.InvestmentsRealtime && window.InvestmentsRealtime.handleTransactionEvent) {
        window.InvestmentsRealtime.handleTransactionEvent(event.detail.data);
    }
});

document.addEventListener('realtime:transaction:deleted', function(event) {
    if (window.InvestmentsRealtime && window.InvestmentsRealtime.handleTransactionEvent) {
        window.InvestmentsRealtime.handleTransactionEvent(event.detail.data);
    }
});

// Listen for FlowGroup events (when is_investment changes)
document.addEventListener('realtime:flowgroup:updated', function(event) {
    if (window.InvestmentsRealtime && window.InvestmentsRealtime.handleFlowGroupUpdate) {
        window.InvestmentsRealtime.handleFlowGroupUpdate(event.detail.data);
    }
});

console.log('[InvestmentsRealtime] Loaded successfully');
</script>
{% endblock %}
